---
title: "Conversion To RMark IMP"
author: "Marty Simonson"
date: "December 6, 2018"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# Front Matter
```{r,include=FALSE}
rm(list=ls())


packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

#remove.packages(c("ggplot2", "data.table"))
#install.packages('Rcpp', dependencies = TRUE)
#install.packages('ggplot2', dependencies = TRUE)
#install.packages('data.table', dependencies = TRUE)

#packages(rcompanion)
#packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(FSA)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
#packages(GGally)
packages(wesanderson)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(doBy)
packages(dplyr)
packages(RMark)
packages(tidyr)





```

# Loading in the CSV
```{r}
# compiled data
dframe<-read.csv("2018 and 2017 Compiled Data.csv")
head(dframe)
#Setting new "detect" column used in the web resource I'm using to create capture history
dframe$detect<-1
str(dframe)
###############
#
#   Well shoot. Looks like I should split up by lake first.
#   I'll do blue (COC ONLY) and Center (COC and BIB) first (play with MARK models below)
#   then come back and edit models

dframe$Date<-as.Date(dframe$Date, format = "%m/%d/%Y")
str(dframe$Date)

```


# Blue Lake capture history
```{r,}
input.data<-subset(dframe, Lake == "Blue" & Species == "COC" & !is.na(dframe$TAG.NUMBER))


#reshaping functions to pivot the data
junk<-melt(input.data,id.var=c("TAG.NUMBER","Date"),
           measure.vars="detect")
y<-dcast(junk,TAG.NUMBER~Date)
head(y)

# collapse the capture history to single column
# capture history: using "unite" in dplyr
# Want to make each tag a "comment" first:
y$c<-"/*"
y$d<-"*/"
y$TAG.NUMBER<-paste(y$c,y$TAG.NUMBER,y$d,sep = " ")
#nicely done. Now to unite the capture histories
blue.ch<-unite(y,"ch", 2:41, sep = "",remove=T)
blue.ch<-blue.ch[,-c(3:4)]
#blue.ch$freq<-1 --------- does not need to be included if all are 1
# That looks like what we want!


# looking for the 12 incorrect ch (error from data.proc below)




```


# Blue Lake MARK Models
OK. So here's some potential complications:
- unequal time intervals and unequal samples between years (could collapst to month?)
- DUPLICATE TAGS! 8901-9000 is still a problem that's unresolved.
- further, we have no difference between 2017 and 2018 at the moment
- so many carp with only one capture. Such is life.
- this is gonna put lots of dbf and fpt files in my directory Need a new branch I think!
```{r}
str(blue.ch)

# Process.data
blue.proc<-process.data(blue.ch,model="CJS")
# errors around 12 incorrect capture histories

# OK here's the badness: this lake sucks because of the duplicate tags 
# (or falsified data but I really really really doubt that's a thing)

# Gonna have to take a step back and work on another lake

```


# Center Lake carp: 2018 only
```{r}
input.data<-subset(dframe, Lake == "Center" &                  # Lake
                           Species == "COC" &                  # Species
                           !is.na(dframe$TAG.NUMBER) &         # must have a tag number
                           Year == "2018" &                    # within a year
                           Notes != "Aging Fish" &             # remove euthanized 1
                           Fin.Clipped != "Dorsal")            # remove euthanized 2
# check tag numbers
levels(droplevels(input.data$TAG.NUMBER))
summary(input.data$TAG.NUMBER)

input.data$Month<-strftime(input.data$Date, "%m")
levels(factor(input.data$Month))


#reshaping functions to pivot the data
junk<-melt(input.data,id.var=c("TAG.NUMBER","Month"),
           measure.vars="detect")
y<-dcast(junk,TAG.NUMBER~Month)
head(y)

#y[is.na(y)]<-0
# after consolidating to month there are some fish with 2 captures per month so need to correct those

y$`05`[y$`05` >= 2] <- 1
#y$`06`[y$`06` >= 2] <- 1
#y$`07`[y$`07` >= 2] <- 1
#y$`08`[y$`08` >= 2] <- 1
#y$`09`[y$`09` >= 2] <- 1
#y$`10`[y$`10` >= 2] <- 1

# collapse the capture history to single column
# capture history: using "unite" in dplyr
# Want to make each tag a "comment" first:
y$c<-"/*"
y$d<-"*/"
y$TAG.NUMBER<-paste(y$c,y$TAG.NUMBER,y$d,sep = " ")
#nicely done. Now to unite the capture histories
center.ch<-unite(y,"ch", 2:7, sep = "",remove=T)
center.ch<-center.ch[,-c(3:4)] # comment columns removal.

```


# Center Lake MARK Models
OK. So here's some potential complications:
- unequal time intervals and unequal samples between years (could collapse to month?)
- need to figure out appropriate model (CJS?)
- all the assumptions!
- also some double-tagged fish. How to handle?
```{r}
str(center.ch)

# Process.data
center.proc<-process.data(center.ch,model="CJS")
str(center.proc)



center.ddl<-make.design.data(center.proc)
names(center.ddl)
summary(center.ddl$Phi)

center.carp.1<-mark(center.ch) # dot model
PIMS(center.carp.1,"Phi",simplified=F) # pims for full time dependent model

# Other model structures:
phi.0<-list(formula=~1) # dot model
phi.1<-list(formula=~time) # time dependent
phi.2<-list(formula=~Time) # Time trend
p.1<-list(formula=~1) # dot model recapture rate
p.2<-list(formula=~time) # time dependent recapture

# Running other models
#
#   See if Phi-dot and phi-dot match above
#             Phi = 0.20586
#             p = 0.0698

center.m.1<-mark(center.proc, center.ddl, model.parameters=list(Phi=phi.0,p=p.1))
# dot model matches

# Phi time and p dot
center.m.2<-mark(center.proc,center.ddl,model.parameters=list(Phi=phi.1,p=p.1))

# Phi time trend and p dot
center.m.3<-mark(center.proc,center.ddl,model.parameters=list(Phi=phi.2,p=p.1))

# phi time and p time
center.m.4<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.1,p=p.2))

# phi dot and p time
center.m.5<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.0,p=p.2))

# phi Time trend and p time
center.m.6<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.2,p=p.2))

center.model.results<-collect.models()
center.model.results


```


# Center Lake: Carp and Buffalo
- need to separate months by year. Probs combined column
- and trying to run for both buffalo and carp together (as groups). 
```{r}
input.data<-subset(dframe, Lake == "Center" & 
                           !is.na(dframe$TAG.NUMBER) &
                           Notes != "Aging Fish" &             # remove euthanized 1
                           Fin.Clipped != "Dorsal")            # remove euthanized 2      
input.data$TAG.NUMBER<-droplevels(input.data$TAG.NUMBER)
summary(input.data$TAG.NUMBER)
input.data$Species<-droplevels(input.data$Species)
summary(input.data$Species)

input.data$MonthYear<-factor(strftime(input.data$Date, "%Y %m"))
head(input.data$MonthYear)
levels(input.data$MonthYear)



#reshaping functions to pivot the data
junk<-melt(input.data,id.var=c("TAG.NUMBER","MonthYear", "Species"),
           measure.vars="detect")
y<-dcast(junk,TAG.NUMBER+Species~MonthYear)
head(y)
#y[is.na(y)]<-0
# after consolidating to month there are some fish with 2 captures per month so need to correct those

y$`2017 05`[y$`2017 05` >= 2] <- 1
y$`2017 06`[y$`2017 06` >= 2] <- 1
y$`2018 05`[y$`2018 05` >= 2] <- 1
y$`2018 06`[y$`2018 06` >= 2] <- 1
y$`2018 07`[y$`2018 07` >= 2] <- 1
y$`2018 08`[y$`2018 08` >= 2] <- 1
y$`2018 09`[y$`2018 09` >= 2] <- 1
y$`2018 10`[y$`2018 10` >= 2] <- 1

# collapse the capture history to single column
# capture history: using "unite" in dplyr
# Want to make each tag a "comment" first:
y$c<-"/*"
y$d<-"*/"
y$TAG.NUMBER<-paste(y$c,y$TAG.NUMBER,y$d,sep = " ")
#nicely done. Now to unite the capture histories
center.ch<-unite(y,"ch", 3:10, sep = "",remove=T)
center.ch<-center.ch[,-c(4:5)] # comment columns removal.

```


# Center Lake COC&BIB MARK models 2017-2018 by month

```{r}
# SETTING UP PROCESS DATA AND DESIGN DATA
str(center.ch)

# Process.data
center.proc<-process.data(center.ch,
                          model="CJS",
                          time.intervals = c(1,11,1,1,1,1,1),
                          groups = "Species")
str(center.proc)

release.gof(center.proc) # why won't this work?

center.ddl<-make.design.data(center.proc)
names(center.ddl)
summary(center.ddl$Phi)
```

```{r}


# model structures:
phi.0<-list(formula=~1) # dot model
phi.1<-list(formula=~time) # time dependent
phi.2<-list(formula=~Time) # Time trend
phi.species<-list(formula=~Species)
phi.species.t<-list(formula=~Species+time)
p.1<-list(formula=~1) # dot model recapture rate
p.2<-list(formula=~time) # time dependent recapture
p.species<-list(formula=~Species)
p.species.t<-list(formula=~Species+time)


################################################################################
# dot model with no variation between species
center.m.1<-mark(center.proc, center.ddl, model.parameters=list(Phi=phi.0,p=p.1))

################################################################################
# Phi time and p dot with no variation between species
center.m.2<-mark(center.proc,center.ddl,model.parameters=list(Phi=phi.1,p=p.1))

# Phi species and p dot
center.m.spp<-mark(center.proc,center.ddl,model.parameters=list(Phi=phi.species,p=p.1))

# Phi species and time and p dot
center.m.spp.t<-mark(center.proc,center.ddl,model.parameters=list(Phi=phi.species.t,p=p.1))

# Phi time trend and p dot
center.m.3<-mark(center.proc,center.ddl,model.parameters=list(Phi=phi.2,p=p.1))


################################################################################
# phi dot and p time with no species variation
center.m.4<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.0,p=p.2))

# phi time and p time with no species variation
center.m.5<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.1,p=p.2))

# phi Time trend and p time with no variation in species
center.m.6<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.2,p=p.2))

# phi dot and p species
center.m.phiDot.pSpp<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.0,p=p.species))

# phi time and p species
center.m.phiDot.pSpp<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.1,p=p.species))

# phi dot and p species + time
center.m.phiDot.pSpp<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.0,p=p.species.t))

# phi time and p species + time
center.m.phiDot.pSpp<-mark(center.proc,center.ddl,model.parameters = list (Phi=phi.1,p=p.species.t))


center.model.results<-collect.models()
center.model.results



```


# North Twin Lake: Carp and Buffalo
- need to separate months by year. Probs combined column
- and trying to run for both buffalo and carp together (as groups). 
```{r}
levels(dframe$Lake)
input.data<-subset(dframe, Lake == "N. Twin" & 
                           !is.na(dframe$TAG.NUMBER) &
                           Notes != "Aging Fish" &             # remove euthanized 1
                           Fin.Clipped != "Dorsal")            # remove euthanized 2   
input.data<-subset(input.data, TAG.NUMBER != "no tag")
levels(droplevels(input.data$TAG.NUMBER))
input.data$TAG.NUMBER<-droplevels(input.data$TAG.NUMBER)
summary(input.data$TAG.NUMBER)
input.data$Species<-droplevels(input.data$Species)
summary(input.data$Species)

input.data$MonthYear<-factor(strftime(input.data$Date, "%Y %m"))
head(input.data$MonthYear)
levels(input.data$MonthYear)



#reshaping functions to pivot the data
junk<-melt(input.data,id.var=c("TAG.NUMBER","MonthYear", "Species"),
           measure.vars="detect")
y<-dcast(junk,TAG.NUMBER+Species~MonthYear)
head(y)
#y[is.na(y)]<-0
# after consolidating to month there are some fish with 2 captures per month so need to correct those

y$`2017 06`[y$`2017 06` >= 2] <- 1
y$`2017 07`[y$`2017 07` >= 2] <- 1
y$`2017 08`[y$`2017 08` >= 2] <- 1
y$`2017 09`[y$`2017 09` >= 2] <- 1
y$`2017 10`[y$`2017 10` >= 2] <- 1
y$`2017 11`[y$`2017 11` >= 2] <- 1
y$`2018 05`[y$`2018 05` >= 2] <- 1
y$`2018 06`[y$`2018 06` >= 2] <- 1
y$`2018 07`[y$`2018 07` >= 2] <- 1
y$`2018 08`[y$`2018 08` >= 2] <- 1
y$`2018 09`[y$`2018 09` >= 2] <- 1
y$`2018 10`[y$`2018 10` >= 2] <- 1
y$`2018 11`[y$`2018 11` >= 2] <- 1

# collapse the capture history to single column
# capture history: using "unite" in dplyr
# Want to make each tag a "comment" first:
y$c<-"/*"
y$d<-"*/"
y$TAG.NUMBER<-paste(y$c,y$TAG.NUMBER,y$d,sep = " ")
#nicely done. Now to unite the capture histories
Ntwin.ch<-unite(y,"ch", 3:15, sep = "",remove=T)
Ntwin.ch<-Ntwin.ch[,-c(4:5)] # comment columns removal.

```


# North Twin Lake COC&BIB MARK models 2017-2018 by month

```{r}
# SETTING UP PROCESS DATA AND DESIGN DATA
str(Ntwin.ch)

# Process.data
Ntwin.proc<-process.data(Ntwin.ch,
                          model="CJS",
                          time.intervals = c(1,1,1,1,1,6,1,1,1,1,1,1),
                          groups = "Species")
str(Ntwin.proc)

release.gof(Ntwin.proc)

Ntwin.ddl<-make.design.data(Ntwin.proc)
names(Ntwin.ddl)
summary(Ntwin.ddl$Phi)
```

```{r}


# model structures:
phi.0<-list(formula=~1) # dot model
phi.1<-list(formula=~time) # time dependent
phi.2<-list(formula=~Time) # Time trend
phi.species<-list(formula=~Species)
phi.species.t<-list(formula=~Species+time)
p.1<-list(formula=~1) # dot model recapture rate
p.2<-list(formula=~time) # time dependent recapture
p.species<-list(formula=~Species)
p.species.t<-list(formula=~Species+time)


################################################################################
# dot model with no variation between species
Ntwin.m.1<-mark(Ntwin.proc, Ntwin.ddl, model.parameters=list(Phi=phi.0,p=p.1))

################################################################################
# Phi time and p dot with no variation between species
Ntwin.m.2<-mark(Ntwin.proc,Ntwin.ddl,model.parameters=list(Phi=phi.1,p=p.1))

# Phi species and p dot
Ntwin.m.spp<-mark(Ntwin.proc,Ntwin.ddl,model.parameters=list(Phi=phi.species,p=p.1))

# Phi species and time and p dot
Ntwin.m.spp.t<-mark(Ntwin.proc,Ntwin.ddl,model.parameters=list(Phi=phi.species.t,p=p.1))

# Phi time trend and p dot
Ntwin.m.3<-mark(Ntwin.proc,Ntwin.ddl,model.parameters=list(Phi=phi.2,p=p.1))


################################################################################
# phi dot and p time with no species variation
Ntwin.m.4<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.0,p=p.2))

# phi time and p time with no species variation
Ntwin.m.5<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.1,p=p.2))

# phi Time trend and p time with no variation in species
Ntwin.m.6<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.2,p=p.2))

# phi dot and p species
Ntwin.m.phiDot.pSpp<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.0,p=p.species))

# phi time and p species
Ntwin.m.phiDot.pSpp<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.1,p=p.species))

# phi dot and p species + time
Ntwin.m.phiDot.pSpp<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.0,p=p.species.t))

# phi time and p species + time
Ntwin.m.phiDot.pSpp<-mark(Ntwin.proc,Ntwin.ddl,model.parameters = list (Phi=phi.1,p=p.species.t))


Ntwin.model.results<-collect.models()
Ntwin.model.results


Ntwin.m.6$results$lnl # code format to examine -2 log likelihood for models. Perhaps able to append it to model.results table with more code.
```


# South Twin Lake: Carp and Buffalo
- need to separate months by year. Probs combined column
- and trying to run for both buffalo and carp together (as groups). 
```{r}



levels(dframe$Lake)
input.data<-subset(dframe, Lake == "S. Twin" & 
                           !is.na(dframe$TAG.NUMBER) &
                           Notes != "Aging Fish" &             # remove euthanized 1
                           Fin.Clipped != "Dorsal")            # remove euthanized 2   
input.data<-subset(input.data, TAG.NUMBER != "NO TAG" & TAG.NUMBER != "NO TAG PUT IN")
levels(droplevels(input.data$TAG.NUMBER))
input.data$TAG.NUMBER<-droplevels(input.data$TAG.NUMBER)
summary(input.data$TAG.NUMBER)
input.data$Species<-droplevels(input.data$Species)
summary(input.data$Species)

input.data$MonthYear<-factor(strftime(input.data$Date, "%Y %m"))
head(input.data$MonthYear)
levels(input.data$MonthYear)



#reshaping functions to pivot the data
junk<-melt(input.data,id.var=c("TAG.NUMBER","MonthYear", "Species"),
           measure.vars="detect")
y<-dcast(junk,TAG.NUMBER+Species~MonthYear)
head(y)
#y[is.na(y)]<-0
# after consolidating to month there are some fish with 2 captures per month so need to correct those

y$`2017 06`[y$`2017 06` >= 2] <- 1
y$`2017 07`[y$`2017 07` >= 2] <- 1
y$`2017 08`[y$`2017 08` >= 2] <- 1
y$`2017 09`[y$`2017 09` >= 2] <- 1
y$`2017 10`[y$`2017 10` >= 2] <- 1
y$`2017 11`[y$`2017 11` >= 2] <- 1
y$`2017 12`[y$`2017 12` >= 2] <- 1
y$`2018 05`[y$`2018 05` >= 2] <- 1
y$`2018 06`[y$`2018 06` >= 2] <- 1
y$`2018 07`[y$`2018 07` >= 2] <- 1
y$`2018 08`[y$`2018 08` >= 2] <- 1
y$`2018 09`[y$`2018 09` >= 2] <- 1
y$`2018 10`[y$`2018 10` >= 2] <- 1
y$`2018 11`[y$`2018 11` >= 2] <- 1

# collapse the capture history to single column
# capture history: using "unite" in dplyr
# Want to make each tag a "comment" first:
y$c<-"/*"
y$d<-"*/"
y$TAG.NUMBER<-paste(y$c,y$TAG.NUMBER,y$d,sep = " ")
#nicely done. Now to unite the capture histories
Stwin.ch<-unite(y,"ch", 3:16, sep = "",remove=T)
Stwin.ch<-Stwin.ch[,-c(4:5)] # comment columns removal.

```


# North Twin Lake COC&BIB MARK models 2017-2018 by month

```{r}
# SETTING UP PROCESS DATA AND DESIGN DATA
str(Stwin.ch)

# Process.data
Stwin.proc<-process.data(Stwin.ch,
                          model="CJS",
                          time.intervals = c(1,1,1,1,1,1,5,1,1,1,1,1,1),
                          groups = "Species")
str(Stwin.proc)

release.gof(Stwin.proc)

Stwin.ddl<-make.design.data(Stwin.proc)
names(Stwin.ddl)
summary(Stwin.ddl$Phi)
```

```{r}


# model structures:
phi.0<-list(formula=~1) # dot model
phi.1<-list(formula=~time) # time dependent
phi.2<-list(formula=~Time) # Time trend
phi.species<-list(formula=~Species)
phi.species.t<-list(formula=~Species+time)
p.1<-list(formula=~1) # dot model recapture rate
p.2<-list(formula=~time) # time dependent recapture
p.species<-list(formula=~Species)
p.species.t<-list(formula=~Species+time)


################################################################################
# dot model with no variation between species
Stwin.m.1<-mark(Stwin.proc, Stwin.ddl, model.parameters=list(Phi=phi.0,p=p.1))

################################################################################
# Phi time and p dot with no variation between species
Stwin.m.2<-mark(Stwin.proc,Stwin.ddl,model.parameters=list(Phi=phi.1,p=p.1))

# Phi species and p dot
Stwin.m.spp<-mark(Stwin.proc,Stwin.ddl,model.parameters=list(Phi=phi.species,p=p.1))

# Phi species and time and p dot
Stwin.m.spp.t<-mark(Stwin.proc,Stwin.ddl,model.parameters=list(Phi=phi.species.t,p=p.1))

# Phi time trend and p dot
Stwin.m.3<-mark(Stwin.proc,Stwin.ddl,model.parameters=list(Phi=phi.2,p=p.1))


################################################################################
# phi dot and p time with no species variation
Stwin.m.4<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.0,p=p.2))

# phi time and p time with no species variation
Stwin.m.5<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.1,p=p.2))

# phi Time trend and p time with no variation in species
Stwin.m.6<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.2,p=p.2))

# phi dot and p species
Stwin.m.phiDot.pSpp<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.0,p=p.species))

# phi time and p species
Stwin.m.phiDot.pSpp<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.1,p=p.species))

# phi dot and p species + time
Stwin.m.phiDot.pSpp<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.0,p=p.species.t))

# phi time and p species + time
Stwin.m.phiDot.pSpp<-mark(Stwin.proc,Stwin.ddl,model.parameters = list (Phi=phi.1,p=p.species.t))


Stwin.model.results<-collect.models()
Stwin.model.results


Stwin.m.6$results$lnl # code format to examine -2 log likelihood for models. Perhaps able to append it to model.results table with more code.



```