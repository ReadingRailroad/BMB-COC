---
title: "2020 Annual Report"
author: "Martin A. Simonson"
date: "January 20, 2019"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r,include=FALSE}
rm(list=ls())
```

```{r,}

packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

#packages(rcompanion)
#packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(FSA)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
packages(FSAdata)
packages(nlstools)
#packages(GGally)
packages(wesanderson)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(doBy)
packages(dplyr)
packages(tidyr)
packages(rcompanion)
packages(GISTools)
packages(maps)
packages(mapproj)
packages(ggpmisc)
```







# Compiling and cleaning 2019 data with 2017-2018 data
## do not need to run
```{r}
dat.frame<-read.csv("2018 and 2017 Compiled Data.csv", header = T)
dat.frame$Year<-as.factor(dat.frame$Year)
dat.frame$detect<-1
str(dat.frame)

dat.frame2<-read.csv("2019 Carp and Buffalo Data Entry - Jan 2020.csv", header = T)
dat.frame2$Year<-as.factor(dat.frame2$Year)
dat.frame2$detect<-1
str(dat.frame2)


names(dat.frame)
names(dat.frame2)
setdiff(names(dat.frame),names(dat.frame2))
dat.frame<-rbind(dat.frame, dat.frame2)

# cleaning, setting column formats (numeric, factor, etc)
str(dat.frame)

# Date:
dat.frame$Date<-as.Date(dat.frame$Date, "%m/%d/%Y")
str(dat.frame$Date)

# Lake
levels(dat.frame$Lake)
dat.frame$Lake[dat.frame$Lake == "N. Twin"] <- "N Twin"
dat.frame$Lake[dat.frame$Lake == "S. Twin"] <- "S Twin"
dat.frame$Lake[dat.frame$Lake == "5 Island "] <- "5 Island"
dat.frame$Lake<-droplevels(dat.frame$Lake)
str(dat.frame$Lake)

# Tag Number
str(dat.frame$TAG.NUMBER) # factor OK here for non-carp and non-buffalo species this is an envelope number

# Species
levels(dat.frame$Species)
dat.frame$Species[dat.frame$Species == "BLGxGSF"]<-"HSX"
dat.frame$Species[dat.frame$Species == "GNSF"]<-"GSF"
dat.frame$Species[dat.frame$Species == "BLK CRP"]<-"BLC"
dat.frame$Species[dat.frame$Species == "Green Sunfish"]<-"GSF"
dat.frame$Species[dat.frame$Species == "NOP not silver"]<-"NOP"
dat.frame$Species[dat.frame$Species == "NOP silver"]<-"NOP"
dat.frame$Species[dat.frame$Species == "Pumpkin seed"]<-"Pumpkinseed"
dat.frame$Species[dat.frame$Species == "Painted turtle"]<-"Painted Turtle"
dat.frame$Species[dat.frame$Species == "Spot tail shiner"]<-"Spottail shiner"
dat.frame$Species[dat.frame$Species == "Spot Tail Shiner"]<-"Spottail shiner"
dat.frame$Species[dat.frame$Species == "Spot tal shiner"]<-"Spottail shiner"
dat.frame$Species[dat.frame$Species == "Spottail Shiner"]<-"Spottail shiner"
dat.frame$Species[dat.frame$Species == "Sucker"]<-"WHS"
dat.frame$Species[dat.frame$Species == "WCRP"]<-"WHC"
dat.frame$Species[dat.frame$Species == "White bass"]<-"WHB"
dat.frame$Species[dat.frame$Species == "White Bass"]<-"WHB"
dat.frame$Species[dat.frame$Species == "WHT bass"]<-"WHB"
dat.frame$Species[dat.frame$Species == "WHT CRP"]<-"WHC"
dat.frame$Species[dat.frame$Species == "Yellow Bull Head"]<-"YLB"
dat.frame$Species[dat.frame$Species == "Yellow Bullhead"]<-"YLB"
dat.frame$Species[dat.frame$Species == "CCF "]<-"CCF"
dat.frame$Species<-droplevels(dat.frame$Species)
levels(dat.frame$Species)

# Length (mm)
str(dat.frame$Length..mm.)
dat.frame$Length..mm.<-as.numeric(dat.frame$Length..mm.)
summary(dat.frame$Length..mm.) # not terrible. Lots of all-species surveys with over 300 fish left many fish without length measurements. (DNR)

# Weight (g)
str(dat.frame$Weight..g.)
dat.frame$Weight..g.<-as.numeric(dat.frame$Weight..g.)
summary(dat.frame$Weight..g.) # confirmed a 1 gram BLG this year. I mean doubtful but wtf

# Recap
str(dat.frame$Recap)
dat.frame$Recap<-as.factor(dat.frame$Recap)
levels(dat.frame$Recap)


# Tag Loss
dat.frame$Tag.Loss<-as.factor(dat.frame$Tag.Loss)
str(dat.frame$Tag.Loss)

# Fin Clipped
str(dat.frame$Fin.Clipped)

# Notes
str(dat.frame$Notes)

# Gear
str(dat.frame$Gear)
levels(dat.frame$Gear)
dat.frame$Gear[dat.frame$Gear == "Commercial Seine"] <- "Seine"
dat.frame$Gear[dat.frame$Gear == "electrofishing"] <- "Electroshocking"
dat.frame$Gear[dat.frame$Gear == "Electrofishing"] <- "Electroshocking"
dat.frame$Gear[dat.frame$Gear == "electrofishing "] <- "Electroshocking"
dat.frame$Gear[dat.frame$Gear == "Electrofishing "] <- "Electroshocking"
dat.frame$Gear[dat.frame$Gear == "Electroschocking"] <- "Electroshocking"
dat.frame$Gear[dat.frame$Gear == "Fyke Net"] <- "Fyke"
dat.frame$Gear[dat.frame$Gear == "Seine "] <- "Seine"
dat.frame$Gear<-droplevels(dat.frame$Gear)
levels(dat.frame$Gear)

# Site / Transect
str(dat.frame$Site.Transect)
levels(dat.frame$Site.Transect)
dat.frame$Site.Transect<-as.character(dat.frame$Site.Transect)
dat.frame$Site.Transect[dat.frame$Site.Transect == "Strom trans 1"] <- "Std 1"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Storm trans 9"] <- "Std 9"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Storm trans 4"] <- "Std 4"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Storm trans 2"] <- "Std 2"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Storm 7"] <- "Std 7"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Storm 5"] <- "Std 5"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Storm  trans 5"] <- "Std 5"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 8"] <- "Std 8"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 7"] <- "Std 7"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 6"] <- "Std 6"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 5"] <- "Std 5"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 4"] <- "Std 4"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 3/4"] <- "Std 3"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 3"] <- "Std 3"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 2"] <- "Std 2"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 11"] <- "Bonus 11"
dat.frame$Site.Transect[dat.frame$Site.Transect == "STD 1"] <- "Std 1"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std  1"] <- "Std 1"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Standard1"] <- "Std 1"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Standard 5"] <- "Std 5"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Standard 4"] <- "Std 4"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Standard 3"] <- "Std 3"
dat.frame$Site.Transect[dat.frame$Site.Transect == "Standard 2"] <- "Std 2"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std3"] <- "Std 3"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 9"] <- "Std 9"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 7"] <- "Std 7"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 6"] <- "Std 6"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 5"] <- "Std 5"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 4"] <- "Std 4"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 3"] <- "Std 3"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 2"] <- "Std 2"
dat.frame$Site.Transect[dat.frame$Site.Transect == "std 1"] <- "Std 1"
dat.frame$Site.Transect<-droplevels(as.factor(dat.frame$Site.Transect))
levels(dat.frame$Site.Transect) # all standard runs denoted by Std and others left as they are


########################
# Ignoring lat/long cause that's some really messed up data
########################

# On Time (seconds)
str(dat.frame$On.Time..s.)
dat.frame$On.Time..s.<-as.numeric(dat.frame$On.Time..s.)
summary(dat.frame$On.Time..s.) # high time checks out: comined all EF runs one day with two boats.

# Water Temp (celcius)
str(dat.frame$Water.Temp..C.) #numeric is good
summary(dat.frame$Water.Temp..C.) # range is good

# Secchi (meters actually!!)

# Year
str(dat.frame$Year)

# detect: just 1 because each row is an observation. sum/average these in later analyses

str(dat.frame)
                              # write.csv(dat.frame,"2017-2020 Compiled Data.csv",row.names = F)


# correcting a couple years that show up as NA later
unique(dat.frame$Date[is.na(dat.frame$Year)])
is.na(dat.frame$Year)<-"2019"
unique(dat.frame$Date[is.na(dat.frame$Year)])
# completed in Excel


```

```{r,}
dat.frame<-read.csv("2017-2020 Compiled Data.csv",header = T)
dat.frame$Year<-as.factor(dat.frame$Year)

dat.frame$Date<-as.Date(dat.frame$Date, "%m/%d/%Y")
dat.frame$On.Time..s.<-as.numeric(dat.frame$On.Time..s.)
str(dat.frame)
```




# Iowa state map

```{r}

dev.off()
# blank state of Iowa

map('state','iowa',fill=T,col="grey95",mar=c(0,1,1.1,1))
# now add cities
data(us.cities)
# just Ames
map.cities(us.cities,country='IA',minpop=57680,maxpop=57690,cex=2.5, pch = 16)
# Just Des Moines
map.cities(us.cities,country='IA',capitals=2,cex=1.5,pch=8)
# Add a scale
x<-(-95.4)
y<-(41.1)
map.scale(x,y,ratio=F,cex=1)
# Add a north arrow
x<-(-96.2)
y<-(41)
north.arrow(x,y,len=0.1,lab="N",col='black')
# To add the study lakes, I first need to create a df with the lat, long, and labels

coords<-read.csv('LakeCoords.csv',header=T)
# Adding the points to the map with labels I hope

# only these lakes for 2019 IA AFS talk
# coords<-subset(coords, Name == "Center Lake" | Name == "S. Twin Lake" | Name == "N. Twin Lake")


points(coords$Long,
       coords$Lat,
       pch=c(13,13,13,1,19,1,19),col='blue',cex=2)
text(coords$Long,
     coords$Lat,
     labels = coords$Name,
     pos=c(2,4,4,2,4,4,4),col='black',cex=1.75)
# Adding a title
title(main="Carp & Buffalo Mgmt. Lakes")
```


##################################################################################
# Annual Report Table and meeting Plots: Total Catches, then split by gear
- df of total catches by gear for each species in each lake (Table)
            - ending up with many rows and a column for each lake.
- stacked barplot is in order

__ Update 2/24/2018 __ need to add in 2017 catch as well. Switching dat.frame to compiled data.

```{r,}
##########################################################################
catch.melt<-melt(dat.frame, id.var = c("Species","Lake"),
              measure.vars = "detect")
TotalCatch<-dcast(catch.melt,Species~Lake)
#write.csv(TotalCatch, "2018 Catch by gear.csv")

#########################################################################
# 2018 Carp and Buffalo Catch split by gear
# Subset to only carp and buffalo to apply ggplot wrapper for year and species
dat.frame<-droplevels(subset(dat.frame, Species == "COC" |
                                        Species == "BIB"))
dat.frame$Species<-as.character(dat.frame$Species)
dat.frame$Species[dat.frame$Species == "BIB"] <- "Bigmouth Buffalo"
dat.frame$Species[dat.frame$Species == "COC"] <- "Common Carp"
dat.frame$Species<-as.factor(dat.frame$Species)
dat.frame$Gear<-as.character(dat.frame$Gear)
dat.frame$Gear[dat.frame$Gear == "Seine"] <- "Commercial Seine"
dat.frame$Gear<-as.factor(dat.frame$Gear)
gear.melt<-melt(dat.frame, id.var = c("Species","Lake","Gear","Year"),
              measure.vars = "detect")
GearCatch<-dcast(gear.melt,Lake + Gear+Year+Species~.)


# Buffalo
Catch_GearSppYear<-ggplot(GearCatch, aes(x=Lake, y = ., fill = Gear))+
                          geom_bar(stat="identity",colour="black") +
                          scale_fill_grey(start = 0.1, end = 0.9, aesthetics = "fill")+
                          labs(title = NULL,
                                x="Lake",
                                y="Total Number of Fish Caught") +
                          facet_grid(vars(Species),vars(Year))+
                          theme(legend.position = c(.75,.9),legend.direction = "vertical",
                                legend.title = element_blank(),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                panel.background = element_rect(fill="white",colour="grey50"), 
                                axis.line = element_line(colour = "black"))
                         
Catch_GearSppYear


# Carp
GearPlot.Carp<-ggplot(GearCatch, aes(x=Lake, y = COC, fill = Gear))+
                geom_bar(stat="identity",colour="black") +
                scale_fill_manual(values = wes_palette("Chevalier1")) +
                scale_y_continuous(limits = c(0,5000)) +
                labs(title = "2018 Total Common Carp Catch By Gear",
                 x="Lake",
                 y="Common Carp Catch") +
                theme_classic()


GearPlot.Carp
```

# Table 1

### total electrofishing effort
```{r}
dat.frame<-read.csv("2017-2020 Compiled Data.csv",header = T)
dat.frame$Year<-as.factor(dat.frame$Year)
dat.frame$Date<-as.Date(dat.frame$Date, "%m/%d/%Y")
dat.frame$On.Time..s.<-as.numeric(dat.frame$On.Time..s.)
str(dat.frame)

dat.frame<-droplevels(subset(dat.frame, Gear == "Electroshocking"))
dat.frame<-droplevels(subset(dat.frame, Year == "2019"))
dat.frame<-droplevels(subset(dat.frame, !is.na(dat.frame$On.Time..s.)))
effort.melt<-melt(dat.frame, id.var = c("Lake","Site.Transect","Date"),
              measure.vars = "On.Time..s.")
effort.cast<-dcast(effort.melt, Lake + Site.Transect+Date ~ ., mean)



```

### Mean CPUE - This is corrected as of 1/28/2020

```{r}
df<-read.csv("2017-2020 Compiled Data.csv")
str(df)

# only carp and buffalo cpue
df<-droplevels(subset(df, Species == "COC" |
                          Species == "BIB" |
                          Species == "dummy"))


# Only electrofishing
levels(df$Gear)
df2<-droplevels(subset(df, Gear == "Electroshocking"))


# only 2019
df2$Year<-as.factor(df2$Year)
df2<-droplevels(subset(df2, Year == "2019"))
# New month column
df2$Date<-as.Date(df2$Date, "%m/%d/%Y")
str(df2$Date)
df2$Month<-factor(format(df2$Date, "%m"))

str(df2$On.Time..s.)
df2$On.Time..s.<-as.numeric(df2$On.Time..s.)
catch.df<-dcast(df2, Date+Lake+Site.Transect+On.Time..s. ~ Species + detect)

# good so far.
str(catch.df)

#delete date column
#catch.df<-droplevels(catch.df[,-1])
#str(catch.df)

# remove NA from on.time
catch.df<-subset(catch.df, !is.na(catch.df$On.Time..s.))




catch.df$`Bigmouth Buffalo CPUE`<-catch.df$BIB_1/(catch.df$On.Time..s./3600)
catch.df$`Common Carp CPUE`<-catch.df$COC_1/(catch.df$On.Time..s./3600)

# clean up some labels
catch.df$Lake<-as.character(catch.df$Lake)
catch.df$Lake[catch.df$Lake == "5 Island"] <- "Five Island"
catch.df$Lake<-droplevels(as.factor(catch.df$Lake))

# Need to figure out how to melt again so there's a species column:
# first, delete dummy column:
catch.df<-catch.df[,-c(4:7)]
# try to remove date
catch.df<-catch.df[,-1]
# try to melt that frame
catch.df.m<-melt(catch.df)

groupwiseMean(value~variable+Lake,
              catch.df.m)

```




#######################################################################################
# 2019 Length Frequencies
- Reading in data
- splitting up the lakes
- split by gear too and exclude fyke nets
- delete unnecessary columns for LF (most of them)

__Problem__: have to switch these to inches!
__Update 2-24-2018__ in addition to above problem need to change a bit so that we can keep adding on years in the future. Basic setup is to switch to the compiled data, and split the single figure into two figures of both species.

for each spp: lakes as columns, years as rows, filled with gear. 
- Suggested adding PSD values as well!


```{r,}
#reading in data
dframe<-read.csv("2017-2020 Compiled Data.csv",header = T)
dframe$Year<-as.factor(dframe$Year)

dframe$Date<-as.Date(dframe$Date, "%m/%d/%Y")
dframe$On.Time..s.<-as.numeric(dframe$On.Time..s.)
str(dframe)
# removing fyke catches
levels(dframe$Gear)

dframe$Gear<-as.character(dframe$Gear)
dframe$Gear[dframe$Gear == "Seine"] <- "Commercial Seine"
dframe$Gear<-as.factor(dframe$Gear)
dframe<-droplevels(subset(dframe, Gear == "Electroshocking" |
                                  Gear == "Commercial Seine"))

# getting rid of unused columns
str(dframe)
names(dframe)
dframe<-dframe[,-c(1,3,6:10,12:20,22)]
head(dframe)

# splitting data frame by Lakes
levels(dframe$Lake)
Blue <- subset(dframe, Lake == "Blue")
Center<-subset(dframe, Lake == "Center")
FiveIsland<-subset(dframe, Lake == "5 Island")
NTwin<-subset(dframe, Lake == "N Twin")
Silver<-subset(dframe, Lake == "Silver")
STwin<-subset(dframe, Lake == "S Twin")
Storm<-subset(dframe, Lake == "Storm")


```

- trying to make a single plot with facet.grid
```{r}
# subsetting species
df<-subset(dframe, !is.na(Length..mm.) & Species == "COC" |
                   !is.na(Length..mm.) & Species == "BIB")
#df<-subset(df, Lake != "Blue")

# correcting names so they show up consistently on plot.
levels(df$Lake)
df$Lake<-as.character(df$Lake)
df$Lake[df$Lake == "5 Island"] <- "Five Island"
df$Lake<-as.factor(df$Lake)
df$Species<-as.character(df$Species)
df$Species[df$Species == "COC"] <- "Common Carp"
df$Species[df$Species == "BIB"] <- "Bigmouth Buffalo"
df$Species<-as.factor(df$Species)
#switching to Inches
df$Length.in<-df$Length..mm./25.4
df<-df[,-3]


df.b<-droplevels(subset(df, Species == "Bigmouth Buffalo"))
df.c<-droplevels(subset(df, Species == "Common Carp"))

df.b.m<-melt(df.b)

all.lakes.Buff.lf<-ggplot(df.b.m, aes(x=value, fill = Gear))+
                         geom_histogram(binwidth = 1,
                                        colour = "black",
                                        position = "stack")+
                         coord_cartesian(xlim = c(0,45))+
                         facet_grid(vars(Year), vars(Lake))+
                         theme(panel.grid.major = element_blank(), 
                              panel.grid.minor = element_blank(),
                              panel.background = element_rect(fill="white",colour="grey50"), 
                              axis.line = element_line(colour = "black"),
                              legend.position = c(0.91,0.8),
                              legend.title = element_blank(),
                              legend.background = element_rect(colour="grey20"))+
                         scale_fill_grey(start = 0.1, end = 0.9, aesthetics = "fill")+
                         labs(title = "Bigmouth Buffalo Length Frequencies 2017-2019",
                              x = "Length (inches)",
                              y = "Frequency")

all.lakes.Buff.lf

df.c.m<-melt(df.c)

all.lakes.Carp.lf<-ggplot(df.c.m, aes(x=value, fill = Gear))+
                         geom_histogram(binwidth = 1,
                                        colour = "black",
                                        position = "stack")+
                         coord_cartesian(xlim = c(0,45))+
                         facet_grid(vars(Year), vars(Lake))+
                         theme(panel.grid.major = element_blank(), 
                              panel.grid.minor = element_blank(),
                              panel.background = element_rect(fill="white",colour="grey50"), 
                              axis.line = element_line(colour = "black"),
                              legend.position = c(0.91,0.8),
                              legend.title = element_blank(),
                              legend.background = element_rect(colour="grey20"))+
                         scale_fill_grey(start = 0.1, end = 0.9, aesthetics = "fill")+
                         labs(title = "Common Carp Length Frequencies 2017-2019",
                              x = "Length (inches)",
                              y = "Frequency")

all.lakes.Carp.lf

grid.arrange(all.lakes.Buff.lf,all.lakes.Carp.lf,ncol=1)


```



## Figure 4

Mean cpue for both species from all EF runs in each lake in 2019, split by month

```{r}
df<-read.csv("2017-2020 Compiled Data.csv")
str(df)

# only carp and buffalo cpue
df<-droplevels(subset(df, Species == "COC" |
                          Species == "BIB" |
                          Species == "dummy"))


# Only electrofishing
levels(df$Gear)
df2<-droplevels(subset(df, Gear == "Electroshocking"))


# only 2019
df2$Year<-as.factor(df2$Year)
df2<-droplevels(subset(df2, Year == "2019"))
# New month column
df2$Date<-as.Date(df2$Date, "%m/%d/%Y")
str(df2$Date)
df2$Month<-factor(format(df2$Date, "%m"))

str(df2$On.Time..s.)
df2$On.Time..s.<-as.numeric(df2$On.Time..s.)
catch.df<-dcast(df2, Date+Lake+Month+Site.Transect+On.Time..s. ~ Species + detect)

# good so far.
str(catch.df)

#delete date column
#catch.df<-droplevels(catch.df[,-1])
#str(catch.df)

# remove NA from on.time
catch.df<-subset(catch.df, !is.na(catch.df$On.Time..s.))




catch.df$`Bigmouth Buffalo CPUE`<-catch.df$BIB_1/(catch.df$On.Time..s./3600)
catch.df$`Common Carp CPUE`<-catch.df$COC_1/(catch.df$On.Time..s./3600)

# clean up some labels
catch.df$Lake<-as.character(catch.df$Lake)
catch.df$Lake[catch.df$Lake == "5 Island"] <- "Five Island"
catch.df$Lake<-droplevels(as.factor(catch.df$Lake))

# Need to figure out how to melt again so there's a species column:
# first, delete dummy column:
catch.df<-catch.df[,-c(5:8)]
# try to remove date
catch.df<-catch.df[,-1]
# try to melt that frame
catch.df.m<-melt(catch.df)

DF.boxplot<-ggplot(catch.df.m, aes(x=Month, y=value))+
  geom_boxplot(aes(fill = Lake),
               stat = "boxplot",
               position = "dodge2")+
  scale_fill_brewer(palette = "Greens")+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill="white",colour="grey50"), 
        axis.line = element_line(colour = "black"),
        legend.position = "none")+
  labs(y = "Electrofishing CPUE (Number of fish / Hour)")+
  guides(fill = guide_legend(nrow=1))+
  facet_grid(variable~Lake, scales = "free")
DF.boxplot
```







#############################################################################
# CPUE and Biomass Density - Figure 5

Code here comes from CPUE plots with the source 2017 and 2018 plots.
- note that 2017 used total biomass and not biomass density
- 2018 uses density

after January project update meeting:
- come up with plot to compare this across months and across lakes
- need to use facet.grid again with month variable
- let's rock and roll!

__Update 2/24/2019__ need to add 2017 data as well.

```{r}
# front matter
DF<-read.csv("2018/2018 Raw CPUE Data.csv",header=T)
str(DF)
DF[,3]<-as.factor(DF[,3])
DF[,4]<-as.factor(as.character(DF[,4]))
DF$n<-as.numeric(DF$n)
levels(DF$Lake)
DF$Lake<-as.character(DF$Lake)
DF$Lake[DF$Lake == "N. Twin"] <- "N Twin"
DF$Lake[DF$Lake == "S. Twin"] <- "S Twin"
DF$Lake[DF$Lake == "5 Island"]<- "Five Island"
DF$Lake<-droplevels(as.factor(DF$Lake))


# loading in data frame
denframe<-read.csv("2018_BiomassDensityEstimates.csv",header=T)
denframe[,1]<-factor(c("Blue","Center","Five Island","N Twin","Silver","S Twin","Storm"))
head(denframe)
str(denframe)

# CarpBiomass - avg from 2018 length specific biomass density estimates (IN POUNDS)
BM<-denframe
colnames(BM)[1] <- "Lake"
BM<-BM[,-2]
# adding carp
BM$CarpN <- c(25662,1452,19739,2487,9175,14896,15468) # est carp abundance for 7 lakes as of 1/26/2020

# Buff pop estimates
BM$BuffN<- c(NA,3840,1303,20424,3767,11648,158)


# step 1 add biomass density with density limits
# probably using Merge?
head(BM)
head(DF)
DF2018<-groupwiseMean(cpue~Lake+Species,
                      DF)


head(DF2017)
head(DF2018)
# delete n and conf level
DF2018<-DF2018[,-c(3,5)]

# meh I'll just subset rather than wrangle another function
#                     lower biomass density limit - carp
DF2018$L.BMD[DF2018$Lake == "Blue" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Blue"]
DF2018$L.BMD[DF2018$Lake == "Five Island" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Five Island"]
DF2018$L.BMD[DF2018$Lake == "Center" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Center"]
DF2018$L.BMD[DF2018$Lake == "N Twin" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "N Twin"]
DF2018$L.BMD[DF2018$Lake == "Silver" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Silver"]
DF2018$L.BMD[DF2018$Lake == "S Twin" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "S Twin"]
DF2018$L.BMD[DF2018$Lake == "Storm" &
             DF2018$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Storm"]
                                                     

#                     biomass density estimate - carp
DF2018$BMD[DF2018$Lake == "Blue" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Blue"]
DF2018$BMD[DF2018$Lake == "Five Island" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Five Island"]
DF2018$BMD[DF2018$Lake == "Center" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Center"]
DF2018$BMD[DF2018$Lake == "N Twin" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "N Twin"]
DF2018$BMD[DF2018$Lake == "Silver" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Silver"]
DF2018$BMD[DF2018$Lake == "S Twin" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "S Twin"]
DF2018$BMD[DF2018$Lake == "Storm" &
             DF2018$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Storm"]


#                     upper biomass density estimate - carp
DF2018$U.BMD[DF2018$Lake == "Blue" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Blue"]
DF2018$U.BMD[DF2018$Lake == "Five Island" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Five Island"]
DF2018$U.BMD[DF2018$Lake == "Center" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Center"]
DF2018$U.BMD[DF2018$Lake == "N Twin" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "N Twin"]
DF2018$U.BMD[DF2018$Lake == "Silver" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Silver"]
DF2018$U.BMD[DF2018$Lake == "S Twin" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "S Twin"]
DF2018$U.BMD[DF2018$Lake == "Storm" &
             DF2018$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Storm"]

############################################################################
#                     lower biomass density limit - BUFFALO
DF2018$L.BMD[DF2018$Lake == "Blue" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Blue"]
DF2018$L.BMD[DF2018$Lake == "Five Island" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Five Island"]
DF2018$L.BMD[DF2018$Lake == "Center" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Center"]
DF2018$L.BMD[DF2018$Lake == "N Twin" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "N Twin"]
DF2018$L.BMD[DF2018$Lake == "Silver" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Silver"]
DF2018$L.BMD[DF2018$Lake == "S Twin" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "S Twin"]
DF2018$L.BMD[DF2018$Lake == "Storm" &
             DF2018$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Storm"]
                                                     

#                     biomass density estimate - BUFFALO
DF2018$BMD[DF2018$Lake == "Blue" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Blue"]
DF2018$BMD[DF2018$Lake == "Five Island" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Five Island"]
DF2018$BMD[DF2018$Lake == "Center" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Center"]
DF2018$BMD[DF2018$Lake == "N Twin" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "N Twin"]
DF2018$BMD[DF2018$Lake == "Silver" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Silver"]
DF2018$BMD[DF2018$Lake == "S Twin" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "S Twin"]
DF2018$BMD[DF2018$Lake == "Storm" &
             DF2018$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Storm"]


#                     upper biomass density estimate - BUFFALO
DF2018$U.BMD[DF2018$Lake == "Blue" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Blue"]
DF2018$U.BMD[DF2018$Lake == "Five Island" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Five Island"]
DF2018$U.BMD[DF2018$Lake == "Center" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Center"]
DF2018$U.BMD[DF2018$Lake == "N Twin" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "N Twin"]
DF2018$U.BMD[DF2018$Lake == "Silver" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Silver"]
DF2018$U.BMD[DF2018$Lake == "S Twin" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "S Twin"]
DF2018$U.BMD[DF2018$Lake == "Storm" &
             DF2018$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Storm"]



# ALL 2017 DATA
# Create DF with CPUE and 95% CI for each lake...

Lake<-c("Blue","Blue","Center","Center","N Twin","N Twin","S Twin","S Twin")
Species<-c("BIB","COC","BIB","COC","BIB","COC","BIB","COC")
Biomass <- c(NA,120617,81894,57932,104513,9001,26802,51187)
BMD <- c(NA,438.6,327.6,231.7,225.7,19.4,48.3,92.2)
Mean<-c(NA,80.37,102.29,36.3,24.56,17.18,64.65,41.78)
Trad.lower<-c(NA,59.99,59.4,22.41,17.99,9.74,36.56,29.96)
Trad.upper<-c(NA,100.76,145.17,50.20,31.14,24.63,95.32,53.05)
L.BMD<-c(NA,230.7,283.3,180.8,126.7,11.6,38.8,52.6)
U.BMD<-c(NA,815.1,389.7,309.3,401.2,36.8,61.3,166.5)

DF2017<-data.frame(Lake,Species,Mean,Trad.lower,Trad.upper,L.BMD,BMD,U.BMD)
DF2017<-DF2017[-1,] # removing buff in blue lake from linear regression and plots to follow
DF2017$Year<-as.factor("2017")
summary(DF2017)

head(DF2018)

DF2018$Year<-as.factor("2018")
summary(DF2018)

# close
DF.17.18<-rbind(DF2017,DF2018)
str(DF.17.18)

DF.17.18$L.BMD[DF.17.18$L.BMD <= 0] <- 0 # setting negative biomass estimates to 0
DF.17.18$Species<-as.character(DF.17.18$Species)
DF.17.18$Species[DF.17.18$Species == "BIB"]<- "Bigmouth Buffalo"
DF.17.18$Species[DF.17.18$Species == "COC"]<- "Common Carp"
DF.17.18$Species<-as.factor(DF.17.18$Species)
############################################
# Lake = Lake 
# Species = binary factor of BIB and COC
# mean = mean cpue for that lake/species combination (# fish per hour)
# Trad.lower = lower ci for monthly cpue
# Trad.upper = upper ci for monthly cpue
# L.BMD = lower biomass density estimate
# BMD = biomass density estimate in lbs per acre
# U.BMD = upper biomass density estimate
#############################################


```

# 2019 CPUE
```{r,}
##################################### Now add 2019 biomass density estimates from length specific weight
BM<-read.csv("2019_BiomassDensityEstimates.csv",header = T)
BM<-BM[,-1]
levels(BM$Lake)

##### and cpue frame from figure 4
cpue<-catch.df.m

summary(cpue)
cpue$variable<-as.character(cpue$variable)
cpue$variable[cpue$variable == "Bigmouth Buffalo CPUE"]<-"BIB"
cpue$variable[cpue$variable == "Common Carp CPUE"]<-"COC"
cpue$variable<-droplevels(as.factor(cpue$variable))
colnames(cpue) <- c("Lake","Site.Transect","Species","CPUE")

# now need to match DF.17.18 format
str(DF.17.18)
str(cpue)
DF2019<-groupwiseMean(CPUE~Lake+Species,
                      cpue)
head(DF2019)
# remove top row: buff in blue
# remove column 3 (samples) and 5 (conf. level)
DF2019<-DF2019[-1,-c(3,5)]
str(DF2019)
# then continue adding bm densities as normal

#                     lower biomass density limit - carp
DF2019$L.BMD[DF2019$Lake == "Blue" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Blue"]
DF2019$L.BMD[DF2019$Lake == "Five Island" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Five Island"]
DF2019$L.BMD[DF2019$Lake == "Center" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Center"]
DF2019$L.BMD[DF2019$Lake == "N Twin" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "N Twin"]
DF2019$L.BMD[DF2019$Lake == "Silver" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Silver"]
DF2019$L.BMD[DF2019$Lake == "S Twin" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "S Twin"]
DF2019$L.BMD[DF2019$Lake == "Storm" &
             DF2019$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Storm"]
                                                     

#                     biomass density estimate - carp
DF2019$BMD[DF2019$Lake == "Blue" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Blue"]
DF2019$BMD[DF2019$Lake == "Five Island" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Five Island"]
DF2019$BMD[DF2019$Lake == "Center" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Center"]
DF2019$BMD[DF2019$Lake == "N Twin" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "N Twin"]
DF2019$BMD[DF2019$Lake == "Silver" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Silver"]
DF2019$BMD[DF2019$Lake == "S Twin" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "S Twin"]
DF2019$BMD[DF2019$Lake == "Storm" &
             DF2019$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Storm"]


#                     upper biomass density estimate - carp
DF2019$U.BMD[DF2019$Lake == "Blue" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Blue"]
DF2019$U.BMD[DF2019$Lake == "Five Island" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Five Island"]
DF2019$U.BMD[DF2019$Lake == "Center" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Center"]
DF2019$U.BMD[DF2019$Lake == "N Twin" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "N Twin"]
DF2019$U.BMD[DF2019$Lake == "Silver" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Silver"]
DF2019$U.BMD[DF2019$Lake == "S Twin" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "S Twin"]
DF2019$U.BMD[DF2019$Lake == "Storm" &
             DF2019$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Storm"]

############################################################################
#                     lower biomass density limit - BUFFALO
DF2019$L.BMD[DF2019$Lake == "Blue" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Blue"]
DF2019$L.BMD[DF2019$Lake == "Five Island" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Five Island"]
DF2019$L.BMD[DF2019$Lake == "Center" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Center"]
DF2019$L.BMD[DF2019$Lake == "N Twin" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "N Twin"]
DF2019$L.BMD[DF2019$Lake == "Silver" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Silver"]
DF2019$L.BMD[DF2019$Lake == "S Twin" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "S Twin"]
DF2019$L.BMD[DF2019$Lake == "Storm" &
             DF2019$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Storm"]
                                                     

#                     biomass density estimate - BUFFALO
DF2019$BMD[DF2019$Lake == "Blue" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Blue"]
DF2019$BMD[DF2019$Lake == "Five Island" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Five Island"]
DF2019$BMD[DF2019$Lake == "Center" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Center"]
DF2019$BMD[DF2019$Lake == "N Twin" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "N Twin"]
DF2019$BMD[DF2019$Lake == "Silver" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Silver"]
DF2019$BMD[DF2019$Lake == "S Twin" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "S Twin"]
DF2019$BMD[DF2019$Lake == "Storm" &
             DF2019$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Storm"]


#                     upper biomass density estimate - BUFFALO
DF2019$U.BMD[DF2019$Lake == "Blue" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Blue"]
DF2019$U.BMD[DF2019$Lake == "Five Island" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Five Island"]
DF2019$U.BMD[DF2019$Lake == "Center" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Center"]
DF2019$U.BMD[DF2019$Lake == "N Twin" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "N Twin"]
DF2019$U.BMD[DF2019$Lake == "Silver" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Silver"]
DF2019$U.BMD[DF2019$Lake == "S Twin" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "S Twin"]
DF2019$U.BMD[DF2019$Lake == "Storm" &
             DF2019$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Storm"]

DF2019$Year<-as.factor("2019")

DF2019$Species<-as.character(DF2019$Species)
DF2019$Species[DF2019$Species == "BIB"]<- "Bigmouth Buffalo"
DF2019$Species[DF2019$Species == "COC"]<- "Common Carp"
DF2019$Species<-as.factor(DF2019$Species)

summary(DF2019)





summary(DF.17.18)

DF.17.18.19<-rbind(DF.17.18,DF2019)
```

- whew that was a doozy. got the data frame though!


Now to create 6 plots, with regression lines (YAY!)

# Figure 5
```{r,}

# visualize how CPUE changes as a function of biomass....
#
# I think biomass density might be beneficial here

# quick regressions with species split

DF.17.18.19.Carp<-droplevels(subset(DF.17.18.19, Species == "Common Carp"))
DF.17.18.19.Buff<-droplevels(subset(DF.17.18.19, Species == "Bigmouth Buffalo"))

mod.carp<-lm(Mean ~ BMD + Year, data = DF.17.18.19.Carp)
summary(mod.carp)

mod.buff<-lm(Mean ~ BMD + Year, data = DF.17.18.19.Buff)
summary(mod.buff)

max(DF.17.18.19$U.BMD)
max(DF.17.18.19$Trad.upper)


CPUE.Plot<-ggplot(DF.17.18.19, aes(x=BMD, y=Mean, label = Lake)) +
                            geom_point(size=2) +
                            geom_errorbar(aes(ymax = Trad.upper, ymin = Trad.lower),width=20) +
                            geom_errorbarh(aes(xmax= U.BMD, xmin = L.BMD),height=5) +
                            geom_text(aes(label=Lake),hjust = -.25, vjust = .75, size = 3)+
                            labs(title = NULL,
                                  x = "Estimated Common Carp Biomass Density (lbs. / acre)",
                                  y = "Catch per Unit Effort (fish/hour)") +
                            facet_grid(vars(Year),vars(Species),
                                       scales = "free_y")+ 
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(),
                                  panel.background = element_rect(fill="white",colour="grey50"),
                                  axis.line = element_line(colour = "black")) +
                            geom_smooth(method=lm,se=F) +
                            stat_poly_eq(formula = y~x,
                                         aes(label = paste(..eq.label..,..rr.label..,sep = "~~~")),
                                         parse=T)
CPUE.Plot

# figure 5 done!

```




# Figure 6
(2) stacked plots with each month as a panel in one column, biomass density on x axis and CPUE in the multiple y-axes. side by side for each species first but maybe also split by STD and Run-n-Gun within each species.  

- plots
-- x axis: biomass density in lbs/acre
-- y axis: CPUE in fish/hour
-- vertical panels: month

dot for each lake in each month

regressions may be pointless and cumbersome, ask MJW

__leaving in the blue lake may observation of cpue__ because data is data and let's not discard anything.

```{r}
# front matter
##################################### Now add 2019 biomass density estimates from length specific weight
BM<-read.csv("2019_BiomassDensityEstimates.csv",header = T)
BM<-BM[,-1]
levels(BM$Lake)

df<-read.csv("2017-2020 Compiled Data.csv")
str(df)

# only carp and buffalo cpue
df<-droplevels(subset(df, Species == "COC" |
                          Species == "BIB" |
                          Species == "dummy"))


# Only electrofishing
levels(df$Gear)
df2<-droplevels(subset(df, Gear == "Electroshocking"))


# only 2019 -- What if we keep all years? 
#df2$Year<-as.factor(df2$Year)
#df2<-droplevels(subset(df2, Year == "2019"))
# New month column
df2$Date<-as.Date(df2$Date, "%m/%d/%Y")
str(df2$Date)
df2$Month<-factor(format(df2$Date, "%m"))
df2$Year<-factor(format(df2$Date, "%Y"))
str(df2$On.Time..s.)
df2$On.Time..s.<-as.numeric(df2$On.Time..s.)
catch.df<-dcast(df2, Date+Lake+Month+Year+Site.Transect+On.Time..s. ~ Species + detect)

# good so far.
str(catch.df)



# remove NA from on.time
catch.df<-subset(catch.df, !is.na(catch.df$On.Time..s.))




catch.df$`Bigmouth Buffalo CPUE`<-catch.df$BIB_1/(catch.df$On.Time..s./3600)
catch.df$`Common Carp CPUE`<-catch.df$COC_1/(catch.df$On.Time..s./3600)

# clean up some labels
catch.df$Lake<-as.character(catch.df$Lake)
catch.df$Lake[catch.df$Lake == "5 Island"] <- "Five Island"
catch.df$Lake<-droplevels(as.factor(catch.df$Lake))

# Need to figure out how to melt again so there's a species column:
# first, delete dummy column:
catch.df<-catch.df[,-c(5:9)]
# try to remove date
catch.df<-catch.df[,-1]
# try to melt that frame
catch.df.m<-melt(catch.df)

DF2019<-groupwiseMean(value~Lake+Month+Year+variable,
                      catch.df.m)
head(DF2019)

DF2019$Species<-as.character(DF2019$variable)
DF2019$Species[DF2019$Species == "Common Carp CPUE"] <- "Common Carp"
DF2019$Species[DF2019$Species == "Bigmouth Buffalo CPUE"] <- "Bigmouth Buffalo"
DF2019$Species<-as.factor(DF2019$Species)

DF<-merge(DF2019,DF.17.18.19, by = c("Lake","Year","Species"))
# merge works! delete mean/lower/upper from y (DF.17.18.19)
DF<-DF[,-c(8,11:13)]


colnames(DF)<-c("Lake","Year","Species","Month","variable",
                    "n","Mean","Trad.lower","Trad.upper",
                    "Lower.BMD","BMD","U.BMD")
names(DF)



str(DF) # # have to figure out how to do this appropriately. 
# finally have even carp and buff runs





DF$Month<-as.character(DF$Month)

DF$Month[DF$Month == "04"] <- "April"
DF$Month[DF$Month == "05"] <- "May"
DF$Month[DF$Month == "06"] <- "June"
DF$Month[DF$Month == "07"] <- "July"
DF$Month[DF$Month == "08"] <- "August"
DF$Month[DF$Month == "09"] <- "September"
DF$Month[DF$Month == "10"] <- "October"
DF$Month[DF$Month == "11"] <- "November"
DF$Month[DF$Month == "12"] <- "December"
DF$Month<-as.factor(DF$Month)
DF<-droplevels(subset(DF, Month != "December"))
DF$Month<- ordered(DF$Month, levels = c("April","May","June","July","August",
                                            "September","October","November"))


head(DF)
```

Frame done, let's plot!
- update: buff as one plot, carp as second plot, grid.arrange to get them side by side

```{r,}
DF.b<-droplevels(subset(DF, Species == "Bigmouth Buffalo"))
BMD.plot.b<-ggplot(DF.b, aes(x= BMD,y=Mean))+
                  geom_point(aes(shape = Lake),size=2)+
                  scale_shape_manual(values = c(0,1,2,3,4,6,8))+
                  facet_grid(Month~Year)+
                  labs( x = "Bigmouth Buffalo Biomass Density (lbs./acre)",
                        y = "Mean Electrofishing CPUE (Fish/Hour)",
                        title = "Bigmouth Bufallo Biomass Density vs. CPUE")+
                  geom_smooth(method = lm, se=F)+
                  stat_poly_eq(formula = y~x,
                               aes(label = paste(..eq.label..,..rr.label..,sep = "~~~")),
                                         parse=T)+
                  theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                       panel.background = element_rect(fill="white",colour="gray50"), 
                       axis.line = element_line(colour = "black"),
                       legend.position= "bottom",
                       legend.direction = "horizontal",
                       legend.title = element_blank(),
                       legend.background = element_blank())+
                  guides(shape = guide_legend(nrow=1))
BMD.plot.b

##########################################################################################

DF.c<-droplevels(subset(DF, Species == "Common Carp"))
BMD.plot.c<-ggplot(DF.c, aes(x= BMD,y=Mean))+
                  geom_point(aes(shape = Lake),size=2)+
                  scale_shape_manual(values = c(0,1,2,3,4,6,8))+
                  facet_grid(Month~Year)+
                  labs( x = "Common CarpBiomass Density (lbs./acre)",
                        y = "Mean Electrofishing CPUE (Fish/Hour)",
                        title = "Common Carp Biomass Density vs. CPUE")+
                  geom_smooth(method = lm, se=F)+
                  stat_poly_eq(formula = y~x,
                               aes(label = paste(..eq.label..,..rr.label..,sep = "~~~")),
                                         parse=T)+
                  theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                       panel.background = element_rect(fill="white",colour="gray50"), 
                       axis.line = element_line(colour = "black"),
                       legend.position= "bottom",
                       legend.direction = "horizontal",
                       legend.title = element_blank(),
                       legend.background = element_blank())+
                  guides(shape = guide_legend(nrow=1))
BMD.plot.c

grid.arrange(BMD.plot.b,BMD.plot.c,ncol=2)

```



###################################################################################
# 2017-2019 Harvest
- condense data frame
- plot lakes on x axis, total harvest in lbs on y axis, species as paired bars
- plot lakes on x axis, removal rate in lbs/acre on y axis, species as paired bars


#######################################################################
Update to plots including all 2019 harvest
```{r,}
harvest<-read.csv("Commercial Harvest 2013 to 2019.csv")
str(harvest)
harvest<-harvest[,-c(2:3)]
harvest$Year<-factor(harvest$Year)
# harvest$Month<-factor(harvest$Month) 
harvest$Harvest<-as.numeric(as.character(harvest$Pounds))

nas<-subset(harvest, is.na(harvest$Harvest))
harvest$Date<-as.Date(harvest$Date, "%m/%d/%Y")
str(harvest$Date)
summary(harvest)




#Drop lakes
levels(harvest$Lake)
harvest<-droplevels(subset(harvest, Lake == "Center Lake" |
                         Lake == "Five Island Lake" |
                         Lake == "Silver Lake (Dickinson)" |
                         Lake == "North Twin Lake"))



#drop freshwater drum
harvest<-droplevels(subset(harvest, Species == "CAP"|
                                    Species == "BMB"))

# correct the species names for later plotting
harvest$Species<-as.character(harvest$Species)
harvest$Species[harvest$Species == "CAP"] <- "Common Carp"
harvest$Species[harvest$Species == "BMB"] <- "Bigmouth Buffalo"
harvest$Species<-factor(harvest$Species)

# add acrage
harvest$Acres[harvest$Lake == "Center Lake"] <- 220
harvest$Acres[harvest$Lake == "Five Island Lake"] <- 973
harvest$Acres[harvest$Lake == "Silver Lake (Dickinson)"] <- 1066
harvest$Acres[harvest$Lake == "North Twin Lake"] <- 453

# shorten silver lake name
harvest$Lake<-as.character(harvest$Lake)
harvest$Lake[harvest$Lake == "Silver Lake (Dickinson)"] <- "Silver Lake"
harvest$Lake<-factor(harvest$Lake)


# add column for pounds removed per acre
harvest$Removal<-harvest$Harvest/harvest$Acres


str(harvest)
##################################
# Lake: factor of 4 lakes with harvest winter 2012/2013 through December 31 2019
# Date: date column
# Year: factor of year
# Month: NUMERIC VALUE of months sampled (numeric for subsetting later)
# Species: both study species
# Harvest: total removal in pounds
# Acres: lake area in acres
# Removal: standardized rough fish removal in pounds per acre
#################################
```


- need to adjust DF so that we have another column representing a season. 
-- maybe like "15-16" could represent fall 15 and spring 16 harvest. Eh?
```{r}
# re-categorizing

# Adding Season column to combine harvests across calendar years.
summary(harvest$Month)

harvest$Season[harvest$Year == "2012" &
               harvest$Month >= 7 |
               harvest$Year == "2013" &
               harvest$Month <= 6]  <- "12-13"

harvest$Season[harvest$Year == "2013" &
               harvest$Month >= 7 |
               harvest$Year == "2014" &
               harvest$Month <= 6]  <- "13-14"

harvest$Season[harvest$Year == "2014" &
               harvest$Month >= 7 |
               harvest$Year == "2015" &
               harvest$Month <= 6]  <- "14-15"

harvest$Season[harvest$Year == "2015" &
               harvest$Month >= 7 |
               harvest$Year == "2016" &
               harvest$Month <= 6]  <- "15-16"

harvest$Season[harvest$Year == "2016" &
               harvest$Month >= 7 |
               harvest$Year == "2017" &
               harvest$Month <= 6]  <- "16-17"

harvest$Season[harvest$Year == "2017" &
               harvest$Month >= 7 |
               harvest$Year == "2018" &
               harvest$Month <= 6]  <- "17-18"

harvest$Season[harvest$Year == "2018" &
               harvest$Month >= 7 |
               harvest$Year == "2019" &
               harvest$Month <= 6]  <- "18-19"

harvest$Season[harvest$Year == "2019" &
               harvest$Month >= 7 |
               harvest$Year == "2020" &
               harvest$Month <= 6]  <- "18-19"

!is.na(harvest$Season)
harvest$Season<-as.factor(harvest$Season)
levels(harvest$Lake)

head(harvest)
```

- Plot it! 
-- Lakes (4) on x-axis
-- lbs on y axis (lbs/acre on other y axis)
-- Each season is a new bar for each lake
-- perhaps stack based on Species??
-- then again with Removal on y axis

```{r}
str(harvest)

harvest$Total.Harvest<-harvest$Harvest
harvest$Std.Removal<-harvest$Removal
harvest<-harvest[,-c(2:4,6:9)]
harvest.m<-melt(harvest, id.vars = c("Lake", "Species","Season"))
harvest.c<-dcast(harvest.m, Lake + Season + Species ~ variable, sum)
harvest.m<-melt(harvest.c)
p1<-ggplot(harvest.m,aes(x=Season, y=value, fill = Species))+
           geom_bar(stat="identity",position="Dodge")+
           scale_fill_grey(start = 0.3, end = 0.7, aesthetics = "fill")+
           facet_grid(variable~Lake, scales = "free_y")+
           theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                panel.background = element_rect(fill="white",colour="grey50"), 
                axis.line = element_line(colour = "black"),
                legend.position = c(0.85,0.4),
                legend.background = element_rect(fill = "white", colour="black"),
                legend.title = element_blank())+
           scale_y_continuous(labels = scales::comma)+
           labs(title = NULL,
                x = "Harvest Season",
                y = "Harvest - (lbs. / acre)                             Harvest (lbs.)")
           
p1


```

# Von Bertalanffy Growth Curves

**************** Update 2020
- creating two plot areas, one for each species
- each plot area is 2 cols by 7 rows
- 2017 von berts on left (NEED TO USE SPINE DATA)
- 2018 von berts on right (need to use spine data as well)

- therefore, I will interject a new sub-chunk of code for each lake's 2018 estimates (and create new lakes)
- split up real chunks between lakes

Task 1: load in and format 2018 age estimate data
- probably good to do a couple preliminary plots/summaries to look for wacky values
- I'mma hate on question marks

```{r,}
ages18<-read.csv("2018 Age Structure Estimates -  Spines.csv")
str(ages18)
ages18$Length<-as.numeric(ages18$Length) # length in mm
ages18$Weight<-as.numeric(ages18$Weight) # weight in grams
ages18$Foli.Age..Spine.<-as.numeric(as.character(ages18$Foli.Age..Spine.))
summary(ages18$Foli.Age..Spine.)
```


# CARPE DIEM

```{r,}
ages<-read.csv("2017_Age_Estimates.csv",header=T)
summary(ages)
str(ages)

#######################################################################
# Subset by species then lake
#
#
#         Blue Lake Carp (SPINES 2017)
#
#
#
b.carp <- droplevels(subset(ages, Species == "COC" &
                                 Lake == "Blue" &
                                 !is.na(ages$Otolith.MAS)&
                                 !is.na(ages$Spine.MAS)))
summary(b.carp)
b.carp$tl<-b.carp$TL.mm
b.carp$age<-b.carp$Spine.MAS 

summary(b.carp$tl)
summary(b.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=b.carp,
                    methLinf = "oldAge")
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=530,K=0.1509417,t0=0)



# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=b.carp, start=svTypical) 

fitTypical <- nls(vbTypical,data=b.carp,start=svTypical) 
#overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

summary(b.carp$age)
ages2plot<- 0:10                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots
dev.off()
plot.new()
par(mfrow=c(7,2),
    mar=c(4,4,2,2))
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Blue Lake Carp 2017",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)+
      lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)+
      lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

#######################################################################
# Subset by species then lake
#
#
#         Blue Lake Carp (SPINES 2018)
#
#
#
b.carp <- droplevels(subset(ages18, Species == "COC" &
                                    Lake == "Blue" &
                                    !is.na(ages18$Foli.Age..Spine.) &
                                    !is.na(ages18$Length)))
summary(b.carp)
b.carp$tl<-b.carp$Length
b.carp$age<-as.numeric(b.carp$Foli.Age..Spine.)

summary(b.carp$tl)
summary(b.carp$age)
#plot(tl~age,b.carp)
# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=426.6693927,K=1.4285567,t0=0)

# Fitting the model and boostrapping
vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=b.carp, start=svTypical) 

fitTypical <- nls(vbTypical,data=b.carp,start=svTypical) 
#overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:11                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Blue Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)+
      lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)+
      lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

# checking a single obs (max length)
b.carp$Env.Tag[b.carp$tl >= 650] # agreed with age estimate!

```

```{r,}
#############################################################################
# Subset by species then lake
#
#
#           Center Lake Carp (2017 spines)
#
#
c.carp <- droplevels(subset(ages, Species == "COC" &
                                 Lake == "Center" &
                                 !is.na(ages$TL.mm)))
summary(c.carp)
c.carp$tl<-c.carp$TL.mm
c.carp$age<-c.carp$Spine.MAS # No otoliths taken from this lake 2017

summary(c.carp$tl)
summary(c.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=c.carp)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=704,K=0.2795948,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(704,0.2795948,-1.2430354))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=c.carp, start=svTypical)

fitTypical <- nls(vbTypical,data=c.carp,start=svTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:16                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Center Lake Carp 2017",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)


#############################################################################
# Subset by species then lake
#
#
#           Center Lake Carp (2018 Spines)
#
#
levels(ages18$Lake)
c.carp <- droplevels(subset(ages18, Species == "COC" &
                                    Lake == "Center" &
                                    !is.na(ages18$Length)&
                                    !is.na(ages18$Marcus.Age..Spine.)))
summary(c.carp)
c.carp$tl<-c.carp$Length
c.carp$age<-c.carp$Marcus.Age..Spine. # No otoliths taken from this lake 2017

summary(c.carp$tl)
summary(c.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=c.carp)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=676.5430337,K=0.2442079,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(676,0.2442079,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=c.carp, start=svTypical)

fitTypical <- nls(vbTypical,data=c.carp,start=svTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

summary(c.carp$age)
ages2plot<- 0:16                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Center Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```

# Five Island von bert curves
```{r,}
# trying to get a placeholder frame for five island in 2017
plot(NULL)


#############################################################################
# Subset by species then lake
#
#
#           Five Island Lake carp 2018 spines
#
#
levels(ages18$Lake)
fi.carp <- droplevels(subset(ages18, Species == "COC" &
                                 Lake == "Five Island" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Marcus.Age..Spine.)))
summary(fi.carp)
fi.carp$tl<-fi.carp$Length
fi.carp$age<-fi.carp$Marcus.Age..Spine. 

summary(fi.carp$tl)
summary(fi.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=fi.carp)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=679.8183989,K=0.6044431,t0=1.86865)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=fi.carp, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=fi.carp,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

summary(fi.carp$Marcus.Age..Spine.)
ages2plot<- 0:18                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Five Island Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```

# north twin von bert curves
```{r,}
#############################################################################
# Subset by species then lake
#
#
#           North Twin Lake Carp (2017 Spines)
#
#
levels(ages$Lake)
nt.carp <- droplevels(subset(ages, Species == "COC" &
                                 Lake == "N Twin" &
                                 !is.na(ages$Spine.MAS)))
summary(nt.carp)
nt.carp$tl<-nt.carp$TL.mm
nt.carp$age<-nt.carp$Spine.MAS 

summary(nt.carp$tl)
summary(nt.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=nt.carp)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=674.5,K=0.1976556,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(674.5,0.201306,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=nt.carp, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=nt.carp,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

summary(nt.carp$age)
ages2plot<- 0:32                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "North Twin Lake Carp 2017",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)



#############################################################################
# Subset by species then lake
#
#
#           North Twin Lake Carp (2018 Spines)
#
#
levels(ages18$Lake)
nt.carp <- droplevels(subset(ages18, Species == "COC" &
                                 Lake == "N. Twin" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Marcus.Age..Spine.)))
summary(nt.carp)
nt.carp$tl<-nt.carp$Length
nt.carp$age<-nt.carp$Marcus.Age..Spine.


# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=nt.carp)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=777.7,K=0.1713801,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(777.7,0.1713801,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=nt.carp, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=nt.carp,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:16                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "North Twin Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```

# silver lake carp von berts

```{r,}
plot(NULL)
#############################################################################
# Subset by species then lake
#
#
#           Silver Lake Carp (2018 spines)
#
#
si.carp <- droplevels(subset(ages18, Species == "COC" &
                                 Lake == "Silver" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Foli.Age..Spine.)))
summary(si.carp)
si.carp$tl<-si.carp$Length
si.carp$age<-si.carp$Foli.Age..Spine. # spines

summary(si.carp$tl)
summary(si.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=si.carp)
unlist(svTypical)
svTypical<-list(Linf=745.515,K=0.69435,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(745.515,0.69435,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500,warnOnly=T), 
            data=si.carp, start=svTypical)

fitTypical <- nls(vbTypical,data=si.carp,start=svTypical,control=list(warnOnly=T))
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:15                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Silver Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
```

# south twin lake carp von berts

```{r,}
#############################################################################
# Subset by species then lake
#
#
#           South Twin Lake Carp (2017 spines)
#
#
st.carp <- droplevels(subset(ages, Species == "COC" &
                                 Lake == "S. Twin" &
                                 !is.na(ages$TL.mm)&
                                 !is.na(ages$Spine.DRF)))
summary(st.carp)
st.carp$tl<-st.carp$TL.mm
st.carp$age<-st.carp$Spine.DRF # otoliths taken from this lake 2017

summary(st.carp$tl)
summary(st.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=st.carp)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.carp)
unlist(svTypical)
svTypical<-list(Linf=495,K=1.145066,t0=1)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(495,1.145066,1))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=st.carp, start=svTypical)

fitTypical <- nls(vbTypical,data=st.carp,start=svTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

summary(st.carp$age)
ages2plot<- 0:13                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "South Twin Lake Carp 2017",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)



#############################################################################
# Subset by species then lake
#
#
#           South Twin Lake Carp (2018 spines)
#
#
st.carp <- droplevels(subset(ages18, Species == "COC" &
                                 Lake == "S. Twin" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Foli.Age..Spine.)))
summary(st.carp)
st.carp$tl<-st.carp$Length
st.carp$age<-st.carp$Foli.Age..Spine. # spines

summary(st.carp$tl)
summary(st.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=st.carp,meth0 = "yngAge")
unlist(svTypical)
svTypical<-list(Linf=389.5,K=1.2754392,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(389.5,1.2754392,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500,warnOnly=T), 
            data=st.carp, start=svTypical)

fitTypical <- nls(vbTypical,data=st.carp,start=svTypical,control=list(warnOnly=T))
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:8                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "South Twin Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
```


# storm lake carp von berts

```{r,}
plot(NULL)
#############################################################################
# Subset by species then lake
#
#
#           Storm Lake Carp (2018 spines)
#
#
storm.carp <- droplevels(subset(ages18, Species == "COC" &
                                 Lake == "Storm" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Foli.Age..Spine.)))
summary(storm.carp)
storm.carp$tl<-storm.carp$Length
storm.carp$age<-storm.carp$Foli.Age..Spine. # spines

summary(storm.carp$tl)
summary(storm.carp$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=storm.carp)
unlist(svTypical)
svTypical<-list(Linf=502.182,K=0.540008,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(502.182,0.540008,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500,warnOnly=T), 
            data=storm.carp, start=svTypical)

fitTypical <- nls(vbTypical,data=storm.carp,start=svTypical,control=list(warnOnly=T))
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:15                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Storm Lake Carp 2018",
        xlim = c(0,35), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
```








~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~





## Buffalo DIEM

```{r}
# read in data
ages<-read.csv("2017_Age_Estimates.csv",header=T)
summary(ages)
str(ages)

summary(ages$TL.mm)

#############################################################################
# Subset by species then lake
#
#
#           Center Lake Buffalo 2017 (spines only, no otoliths)
#
#
c.buff <- droplevels(subset(ages, Species == "BIB" &
                                 Lake == "Center" &
                                 !is.na(ages$TL.mm)))
summary(c.buff)
c.buff$tl<-c.buff$TL.mm
c.buff$age<-c.buff$Spine.MAS # No otoliths taken from this lake 2017

summary(c.buff$tl)
summary(c.buff$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=c.buff,
                    methLinf = "oldAge")
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.buff)
unlist(svTypical)
svTypical<-list(Linf=699,K=0.05632404,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(Linf=699,K=0.05632404,t0=0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=c.buff, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=c.buff,start=svTypical)
summary(fitTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:12                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

dev.off()
plot.new()
par(mfrow=c(4,2),
    mar=c(4,4,2,2))
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Center Lake Buffalo 2017",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

#############################################################################
# Subset by species then lake
#
#
#           Center Lake Buffalo 2017 (spines only, no otoliths)
#
#
c.buff <- droplevels(subset(ages18, Species == "BIB" &
                                 Lake == "Center" &
                                 !is.na(ages18$Length) &
                                 !is.na(ages18$Marcus.Age..Spine.)))
summary(c.buff)
c.buff$tl<-c.buff$Length
c.buff$age<-c.buff$Marcus.Age..Spine. # No otoliths taken from this lake 2017

summary(c.buff$tl)
summary(c.buff$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=c.buff,
                    methLinf = "oldAge")
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.buff)
unlist(svTypical)
svTypical<-list(Linf=585,K=0.2932983,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(585,0.2932983,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=c.buff, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=c.buff,start=svTypical)
summary(fitTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:15                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Center Lake Buffalo 2018",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```

# Five Island

```{r}
#############################################################################
# Subset by species then lake
#
#
#           North Twin Lake Buffalo (Otoliths)
#
#
levels(ages18$Lake)
fi.buff <- droplevels(subset(ages18, Species == "BIB" &
                                 Lake == "Five Island" &
                                 !is.na(ages18$Length) &
                                 !is.na(ages18$Foli.Age..Spine.)))
summary(fi.buff)
fi.buff$tl<-fi.buff$Length
fi.buff$age<-fi.buff$Foli.Age..Spine. 

summary(fi.buff$tl)
summary(fi.buff$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=fi.buff)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.buff)
unlist(svTypical)
svTypical<-list(Linf=674.9123,K=0.4222550,t0=0)


# Fitting the model and boostrapping

vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(674.9123,0.4222550,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=fi.buff, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=fi.buff,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)


ages2plot<- 0:15                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots
plot(NULL) # placeholder plot
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Five Island Lake Buffalo 2018",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```


# North Twin Lake Buff Von Berts
```{r,}
#############################################################################
# Subset by species then lake
#
#
#           North Twin Lake Buffalo (2017)
#
#
levels(ages$Lake)
nt.buff <- droplevels(subset(ages, Species == "BIB" &
                                 Lake == "N Twin" &
                                 !is.na(ages$Spine.MAS)))
nt.buff$Spine.MAS[nt.buff$Spine.MAS == 40]<-25
summary(nt.buff)
nt.buff$tl<-nt.buff$TL.mm
nt.buff$age<-nt.buff$Spine.MAS 

summary(nt.buff$tl)
summary(nt.buff$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=nt.buff)
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.buff)
unlist(svTypical)
svTypical<-list(Linf=633,K=0.238783,t0=0)


# Fitting the model and boostrapping

vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(633,0.238783,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=nt.buff, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=nt.buff,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:26                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "North Twin Lake Buffalo 2017",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)




#############################################################################
# Subset by species then lake
#
#
#           North Twin Lake Buffalo (2018)
#
#
levels(ages18$Lake)
nt.buff <- droplevels(subset(ages18, Species == "BIB" &
                                 Lake == "N. Twin" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Foli.Age..Spine.)))
summary(nt.buff)
nt.buff$tl<-nt.buff$Length
nt.buff$age<-nt.buff$Marcus.Age..Spine. 

summary(nt.buff$tl)
summary(nt.buff$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=nt.buff,meth0 = "yngAge")
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.buff)
unlist(svTypical)
svTypical<-list(Linf=737.4488,K=0.2088784,t0=0)


# Fitting the model and boostrapping

vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(737.4488,0.2088784,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=nt.buff, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=nt.buff,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:13                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "North Twin Lake Buffalo 2018",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
```



# Silver Lake 

```{r}

#############################################################################
# Subset by species then lake
#
#
#           Silver Lake Buffalo (2018)
#
#
levels(ages18$Lake)
nt.buff <- droplevels(subset(ages18, Species == "BIB" & # ignore that I kept this named 'nt.buff' for rest of chunk
                                 Lake == "Silver" &
                                 !is.na(ages18$Length)&
                                 !is.na(ages18$Foli.Age..Spine.)))
summary(nt.buff)
nt.buff$tl<-nt.buff$Length
nt.buff$age<-nt.buff$Marcus.Age..Spine. 

summary(nt.buff$tl)
summary(nt.buff$age)

# vbStarts and function variables
svTypical<-vbStarts(tl~age,data=nt.buff,meth0 = "yngAge")
#svAlternate<-vbStartsDP(TL.mm,Otolith.MAS,data=b.buff)
unlist(svTypical)
svTypical<-list(Linf=887.5229,K=0.1701503,t0=0)


# Fitting the model and boostrapping

vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(887.5229,0.1701503,0))

fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=nt.buff, start=svTypical)
summary(fitTyp)

fitTypical <- nls(vbTypical,data=nt.buff,start=svTypical)
summary(fitTypical)


bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=F)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:13                       # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots
plot(NULL)
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Silver Lake Buffalo 2018",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
```

# south twin lake buff von berts
``` {r,}
#############################################################################
# Subset by species then lake
#
#
#           South Twin Lake buffalo spines - 2017
#
#
st.buff <- droplevels(subset(ages, Species == "BIB" &
                                 Lake == "S. Twin" &
                                 !is.na(ages$TL.mm)&
                                 !is.na(ages$Spine.MAS)&
                                 !is.na(ages$Otolith.MAS)))

summary(st.buff)
st.buff$tl<-st.buff$TL.mm
st.buff$age<-st.buff$Spine.PVG
summary(st.buff$tl)
summary(st.buff$age)
summary(st.buff$mean.age)
#plot(tl~age,st.buff)
# checking some ages
junky<-droplevels(subset(st.buff, age == 4))



# vbStarts and function variables ****** problems converging ******
svTypical<-vbStarts(tl~age,data=st.buff, methLinf = "oldAge")



unlist(svTypical)
svTypical<-list(Linf=629.92,K=0.08136705,t0=0)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(629.92,0.08136705,0))



fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=st.buff, start=svTypical)

fitTypical <- nls(vbTypical,data=st.buff,start=svTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=T)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:16                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "South Twin Buffalo 2017",
        xlim = c(0,26), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)


#############################################################################
# Subset by species then lake
#
#
#           South Twin Lake buffalo spines - 2018
#
#
levels(ages18$Lake)
st.buff <- droplevels(subset(ages18, Species == "BIB" &
                                 Lake == "S. Twin" &
                                 !is.na(ages18$Length) &
                                 !is.na(ages18$Marcus.Age..Spine.)))

summary(st.buff)
st.buff$tl<-st.buff$Length
st.buff$age<-st.buff$Marcus.Age..Spine.
summary(st.buff$tl)
summary(st.buff$age)
#plot(tl~age,st.buff)


# vbStarts and function variables ****** problems converging ******
svTypical<-vbStarts(tl~age,data=st.buff)

# removing two oddball high age buffs

unlist(svTypical)
svTypical<-list(Linf=579.1508347,K=0.3065546,t0=-1.2960263)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(579.1508347,0.3065546,-1.2960263))



fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=st.buff, start=svTypical)

fitTypical <- nls(vbTypical,data=st.buff,start=svTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=T)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:16                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots

fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "South Twin Lake Buffalo 2018",
        xlim = range(ages2plot), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```

# Storm Lake 2018 buffalo von bert

```{r,}

#############################################################################
# Subset by species then lake
#
#
#           Storm Lake buffalo spines - 2018
#
#
levels(ages18$Lake)
st.buff <- droplevels(subset(ages18, Species == "BIB" &
                                 Lake == "Storm" &
                                 !is.na(ages18$Length) &
                                 !is.na(ages18$Foli.Age..Spine.)))

summary(st.buff)
st.buff$tl<-st.buff$Length
st.buff$age<-st.buff$Marcus.Age..Spine.
summary(st.buff$tl)
summary(st.buff$age)
#plot(tl~age,st.buff)


# vbStarts and function variables ****** problems converging ******
svTypical<-vbStarts(tl~age,data=st.buff)

# removing two oddball high age buffs
st.buff2<-subset(st.buff, mean.age <= 10)
svTypical.2<-vbStarts(tl~age,data=st.buff2)

unlist(svTypical)
svTypical<-list(Linf=579.1508347,K=0.3065546,t0=-1.2960263)


# Fitting the model and boostrapping


vbTypical <- tl ~ Linf*(1-exp(-K*(age-t0)))
vbTyp<-vbFuns()
vbTyp(3,Linf=c(579.1508347,0.3065546,-1.2960263))



fitTyp<-nls(tl~vbTyp(age,Linf,K,t0), 
            control = list(maxiter=500), 
            data=st.buff, start=svTypical)

fitTypical <- nls(vbTypical,data=st.buff,start=svTypical)
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=2000)
headtail(bootTypical$coefboot,n=2)
confint(bootTypical,plot=T)
ests <- data.frame(bootTypical$coefboot)

ages2plot<- 0:16                        # need to change this with each spp/lake combo
LCI<-UCI<-numeric(length(ages2plot))
for(i in 1:length(ages2plot)) {
  pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <-quantile(pv,0.025)
  UCI[i] <-quantile(pv,0.975)
}


# Plots
plot(NULL)
fitPlot(fitTypical,xlab="Age Estimate",ylab="Length (mm)",
        main = "Storm Lake Buffalo 2018",
        xlim = range(ages2plot), ylim = c(200,900),
        legend = T)
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

```


## turns out storm and south twin will not effing cooperate!


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# age-frequency histograms
```{r}
ages<-read.csv("2017_Age_Estimates.csv",header=T)

ages<-droplevels(ages[-761,])
summary(ages)
str(ages)

# 2018
ages18<-read.csv("2018 Age Structure Estimates -  Spines.csv")
str(ages18)
ages18$Length<-as.numeric(ages18$Length) # length in mm
ages18$Weight<-as.numeric(ages18$Weight) # weight in grams
ages18$Foli.Age..Spine.<-as.numeric(as.character(ages18$Foli.Age..Spine.))
summary(ages18$Foli.Age..Spine.)




ages<-ages[,-c(2,4,5,7:13)]
ages<-droplevels(subset(ages, !is.na(ages$Spine.MAS)))


ages18<-droplevels(subset(ages18, !is.na(ages18$Foli.Age..Spine.)))

# need to create a combined frame so that I can use facet.grid by year
#2017
ages$Year<-as.factor("2017")
colnames(ages)
colnames(ages)<-c("Lake","Species","Age","Year")
# 2018
ages18<-ages18[,-c(3,5,6,7,8)] # keeping marcus ages
colnames(ages18)
ages18<-ages18[,c(2,3,4,1)]
colnames(ages18)<-c("Lake","Species","Age","Year")
str(ages18)
ages18$Year<-as.factor(ages18$Y)
ages<-rbind(ages,ages18)



ages$Species<-as.character(ages$Species)
ages$Species[ages$Species == "BIB"] <-"Bigmouth Buffalo"
ages$Species[ages$Species == "COC"] <-"Common Carp"
ages$Species<-as.factor(ages$Species)

ages$Age<-as.numeric(ages$Age)

ages$Lake[ages$Lake == "N Twin"] <- "N. Twin"
ages$Lake<-ordered(ages$Lake, c("Blue","Center","Five Island","N. Twin","S. Twin","Silver","Storm")) # order
ages<-subset(ages, !is.na(ages$Age)) # remove 16 fish with no age estimate

#plot
Age.Hist<-ggplot(ages, aes(x=Age))+
                         geom_histogram(binwidth = 1,
                                        colour = "white")+
                         facet_grid(Lake ~ Species + Year)+
                         theme(panel.grid.major = element_blank(), 
                              panel.grid.minor = element_blank(),
                              panel.background = element_rect(fill="white",colour="grey50"), 
                              axis.line = element_line(colour = "black"),
                              legend.position = "bottom",
                              legend.background = element_rect(colour="grey20"))+
                         scale_fill_grey(start = 0.1, end = 0.9, aesthetics = "fill")+
                         labs(title = NULL,
                              x = "Age",
                              y = "Frequency")

Age.Hist

```



#################################################################################
# Changes in biomass and biomass density following harvest in center lake

my plan a couple hours ago was to have a four panel plot: 

Within each panel is Center, N&S Twin Lakes
Within each lake is year

data for each panel is:
TOPLEFT: COC TOTAL BIOMASS
TOPRIGHT: BIB TOTAL BIOMASS
BOTTOMLEFT: COC BIOMASS DENSITY
BOTTOMRIGHT: BIB BIOMASS DENSITY

__because you're a masochist, do all four and see if there's a meaningful difference__

current idea is to take the code from the cpue plots. figure out how to categorize x values and fill with year

```{r}
# gonna need biomass df for both years with confidence intervals
# basically paired boxplots without the boxes?
daf<-read.csv("2018/2018_BiomassDensityEstimates.csv")
daf
daf[,1]<-c("Blue","Center","Five Island","N. Twin","Silver","S. Twin","Storm")
daf$Year<-factor("2018")

dat<-read.csv("2017/2017_BiomassDensityEstimates.csv")
dat
dat[,1]<-c("Blue","Center","N. Twin","S. Twin")
dat$Year<-factor("2017")

data<-rbind(dat,daf)
data<-subset(data, X == "Center" |
                   X == "N. Twin"|
                   X == "S. Twin")




```


split by species, melt, and plot!

```{r}

c.data<-data[,c(1:7,14)]
b.data<-data[,c(1,8:14)]

frame<-read.csv("junk.csv")
frame$Year<-factor(frame$Year)
str(frame)

frame$L.BM<-frame$L.BM/1000
frame$BM<-frame$BM/1000
frame$U.BM<-frame$U.BM/1000
require(ggplot2)
dodge<-position_dodge(width=0.2)
bm<-ggplot(frame, aes(x= Year, y = BM, ymin=L.BM, ymax=U.BM))+
                geom_point(size=4, aes( shape = Species))+
                geom_errorbar(width = 0.2, position = dodge) +
                facet_grid(Species ~ Lake)+
                theme(panel.grid.major = element_blank(), 
                      panel.grid.minor = element_blank(),
                      panel.background = element_rect(fill="white",colour="grey50"), 
                      axis.line = element_line(colour = "black"),
                      legend.position = "none")+
                labs (title = "Total Biomass 2017-2019", 
                    y = "Biomass Estimate (in thousands of pounds)")
bm

# Buf total biomass plot
#bib.bm<-ggplot(b.data, aes(x= Year, y = B.BM, ymin=B.L.BM, ymax=B.U.BM))+
#                geom_point(size=4)+
#                ylim=c(0,300000)+
#                geom_linerange(size = 0.5) +
#                facet_wrap(~X,scales = "free_x")+
#                theme_bw()+
#                labs (title = "Buffalo Total Biomass 2017-2018", 
#                    y = "Biomass Estimate (lbs.)")
#bib.bm

#Carp bm density plot
dodge<-position_dodge(width=0.2)
bmD<-ggplot(frame, aes(x= Year, y = BMDensity, ymin=L.BMDensity, ymax=U.BMDensity))+
                geom_point(size=4, aes(shape=Species))+
                geom_errorbar(width = 0.2,
                           position = dodge) +
                facet_grid(Species~Lake)+
                theme(panel.grid.major = element_blank(), 
                      panel.grid.minor = element_blank(),
                      panel.background = element_rect(fill="white",colour="grey50"), 
                      axis.line = element_line(colour = "black"),
                      legend.position = "none")+
                labs (title = "Biomass Density 2017-2019", 
                    y = "Estimated Biomass Density (lbs. / acre)")
bmD

grid.arrange(bm,bmD,
             nrow = 2)

```



## real quick cpue plot like above frame

```{r}
frame<-read.csv("junk2.csv")
frame$Year<-factor(frame$Year)
str(frame)
# total biomass plot
bm<-ggplot(frame, aes(x= Year, y = CPUE, ymin=Lower, ymax=Upper))+
                geom_point(size=4, aes(colour = Species, shape = Species))+
                geom_errorbar(width = 0.2) +
                facet_wrap(~Species+Lake)+
                theme_bw()+
                labs (title = "Catch Per Unit Effort 2017-2018", 
                    y = "CPUE (Fish per Hour)")
bm
```




# Plot of species diversity
- side by side plot, number of species on y axis lake on x axis and filled with EF vs. fyke in a stacked barplot

- update 1-28-2019
-- Decide what's most meaningful for annual report!


## Species Diversity
```{r}
diversity<-read.csv("2018/2018_COC_BIB_CMR_Data.csv", header = T)

summary(diversity$Gear)
diversity<-droplevels(subset(diversity, Gear == "Fyke" |
                             Gear == "Electroshocking"))

p1.data<-data.frame(with(diversity, 
                         tapply(Species, 
                                list(Lake, Gear), 
                                FUN = function(x) 
                                  length(unique(x)))))

p1.data$Lake<-c("Blue","Center","FiveIsland","N.Twin","S. Twin","Silver","Storm")
m1.d.melt<-melt(p1.data)
theme_set(theme_bw())
p1 <- ggplot(m1.d.melt, aes(x=Lake, y = value, fill = variable))+
            geom_bar(stat="identity", position = "dodge", colour = "black") +
           scale_fill_grey(start = 0.3, end = 0.7, aesthetics = "fill")+
             theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                panel.background = element_rect(fill="white",colour="grey50"), 
                axis.line = element_line(colour = "black"),
                legend.position = c(0.1,0.8), legend.title = element_blank()) +
              labs (title = "Number of Unique Species 2018", 
                    y = "Number of Species")
  
p1

# p2, the same shenanigans with the 2019 data
diversity2<-read.csv("2017-2020 Compiled Data.csv", header = T)
diversity2$Year<-as.factor(diversity2$Year)
summary(diversity2$Gear)
diversity2<-droplevels(subset(diversity2, Gear == "Fyke" |
                             Gear == "Electroshocking"))
diversity2<-droplevels(subset(diversity2, Year == "2019"))

levels(diversity2$Lake)
diversity2$Lake<-as.character(diversity2$Lake)
diversity2$Lake[diversity2$Lake == "5 Island"] <- "Five Island"
diversity2$Lake<-as.factor(diversity2$Lake)

length(unique(diversity2$Species))

p2.data<-data.frame(with(diversity2, 
                         tapply(Species, 
                                list(Lake, Gear), 
                                FUN = function(x) 
                                  length(unique(x)))))

p2.data$Lake<-c("Blue","Center","Five Island","N.Twin","S. Twin","Silver","Storm")
m1.d.melt<-melt(p2.data)
theme_set(theme_bw())
p2 <- ggplot(m1.d.melt, aes(x=Lake, y = value, fill = variable))+
            geom_bar(stat="identity", position = "dodge", colour = "black") +
           scale_fill_grey(start = 0.3, end = 0.7, aesthetics = "fill")+
             theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                panel.background = element_rect(fill="white",colour="grey50"), 
                axis.line = element_line(colour = "black"),
                legend.position = 'none') +
              labs (title = "Number of Unique Species 2019", 
                    y = "Number of Species")
  
p2 # missing row is Fyke Nets in 5 island


grid.arrange(p1,p2, ncol=1)


```


Trying some PSDs with the all fyke and ef data 

******** New 2020 development: CANNOT have ef and fyke in same PSD table. 
- gears are size selective
- so now we split them up and make 2 psd tables! Life is grand

```{r}
packages("FSA")

str(diversity2)


psdVal()
levels(diversity2$Species)
psd.frame<-diversity2

psd.frame$Species<-as.character(psd.frame$Species)
psd.frame$Species[psd.frame$Species == "BLC"]<-"Black Crappie"
psd.frame$Species[psd.frame$Species == "BBH"]<-"Brown Bullhead"
psd.frame$Species[psd.frame$Species == "BIB"]<-"Bigmouth Buffalo"
psd.frame$Species[psd.frame$Species == "BLB"]<-"Black Bullhead"
psd.frame$Species[psd.frame$Species == "BLG"]<-"Bluegill"
psd.frame$Species[psd.frame$Species == "COC"]<-"Common Carp"
psd.frame$Species[psd.frame$Species == "FWD"]<-"Freshwater Drum"
psd.frame$Species[psd.frame$Species == "GZS"]<-"Gizzard Shad"
psd.frame$Species[psd.frame$Species == "GSF"]<-"Green Sunfish"
psd.frame$Species[psd.frame$Species == "NOP"]<-"Northern Pike"
psd.frame$Species[psd.frame$Species == "OSS"]<-"Orangespotted Sunfish"
psd.frame$Species[psd.frame$Species == "SMB"]<-"Smallmouth Bass"
psd.frame$Species[psd.frame$Species == "WHB"]<-"White Bass"
psd.frame$Species[psd.frame$Species == "WHS"]<-"White Sucker"
psd.frame$Species[psd.frame$Species == "YLB"]<-"Yellow Bullhead"
psd.frame$Species[psd.frame$Species == "YEP"]<-"Yellow Perch"
psd.frame$Species[psd.frame$Species == "YEB"]<-"Yellow Bass"
psd.frame$Species[psd.frame$Species == "YLP"]<-"Yellow Perch"
psd.frame$Species[psd.frame$Species == "CCF"]<-"Channel Catfish"
psd.frame$Species[psd.frame$Species == "LMB"]<-"Largemouth Bass"
psd.frame$Species[psd.frame$Species == "WAE"]<-"Walleye"
psd.frame$Species[psd.frame$Species == "WHC"]<-"White Crappie"
psd.frame$Species[psd.frame$Species == "HSX"]<-"Hybrid Sunfish"
psd.frame$Species[psd.frame$Species == "WHX"]<-"Hybrid White Bass"
psd.frame$Species<-as.factor(psd.frame$Species)
levels(psd.frame$Species)
psd.frame<-droplevels(subset(psd.frame, Species != "dummy"))

length(levels(psd.frame$Species))


summary(psd.frame$Species[psd.frame$Lake == "Blue" & psd.frame$Gear == "Fyke"])
summary(psd.frame$Species[psd.frame$Lake == "Center"])
summary(psd.frame$Species[psd.frame$Lake == "Five Island"])
summary(psd.frame$Species[psd.frame$Lake == "N Twin"])
summary(psd.frame$Species[psd.frame$Lake == "Silver"])
summary(psd.frame$Species[psd.frame$Lake == "S Twin"])
summary(psd.frame$Species[psd.frame$Lake == "Storm"])

# always, always gotta remove those pesky yellow bass from storm lake
psd.frame$Species[psd.frame$Lake == "Storm" & psd.frame$Species == "Yellow Bass"] <- "White Bass"


# remove fish that aren't included in Ogle's FSA (Gablehouse (PSD) lengths)
summary(psd.frame$Lake[psd.frame$Species == "Painted Turtle"])

levels(psd.frame$Species)

# Also remove Carp and buff because of uneven sampling
psd.frame<-droplevels(subset(psd.frame, Species != "Madtom" &
                                        Species != "Orangespotted Sunfish"&
                                        Species != "Painted Turtle"&
                                        Species != "Hybrid Sunfish"&
                                        Species != "Emerald Shiner"&
                                        Species != "Hybrid White Bass"&
                                        Species != "Spotfin shiner"&
                                        Species != "Spottail shiner"))

levels(psd.frame$Species)

# time to split by gear!
psd.frame.fyke<-droplevels(subset(psd.frame, Gear == "Fyke"))
psd.frame.ef<-droplevels(subset(psd.frame, Gear == "Electroshocking"))
```


## Fyke Net PSD table
```{r,}
psd.frame.fyke$PSDcat<-psdAdd(Length..mm.~Species, 
                              data = psd.frame.fyke,
                              units = "mm")
head(psd.frame.fyke)

first.table<-data.frame(t1 <- with(psd.frame.fyke, table(interaction(Species, Lake),PSDcat)))
packages("reshape2")
second.table<-dcast(first.table, Var1 ~ PSDcat, fun.aggregate = NULL )

second.table$Total<-rowSums(second.table[,2:7])
write.csv(second.table, "2019_PSD_Fyke.csv", row.names = F)





(t1r <- t(apply(t1[,-1],MARGIN=1,FUN=rcumsum)) )

third.table<-data.frame( t1p <- round(t1r[,-1]/t1r[,1]*100,1) )
third.table$Total<-rowSums(third.table)
third.table<-cbind(second.table[,1],third.table)
write.csv(third.table, "2019_PSD_Fyke 2.csv", row.names = F)

```

2019: got photos of some white bass and yellow bass from storm on the same measuring board. We'll see how this year goes!~
2020: Yep the consensus in the lab is that they're still not yellow bas in Storm. So I suck at fish, which is nice.


## Electrofishing Net PSD table
```{r,}
psd.frame.ef$Date<-as.Date(psd.frame.ef$Date, "%m/%d/%Y")
#Need to do COC and BIB only from the std sample days....
psd.frame.ef<-droplevels(subset(psd.frame.ef, Date == "2019-06-03" | # silver and center
                                              Date == "2019-05-15" & Site.Transect != "Bonus" | # storm
                                              Date == "2019-06-17" & Site.Transect != "Bonus 1" | # five island
                                              Date == "2019-05-07" & Lake == "S Twin" |
                                              Date == "2019-05-06" & Lake == "N Twin" |
                                              Date == "2019-05-13" & Lake == "N Twin" |
                                              Date == "2019-05-17" & Lake == "Blue")) 


psd.frame.ef$PSDcat<-psdAdd(Length..mm.~Species, 
                              data = psd.frame.ef,
                              units = "mm")
head(psd.frame.ef)

first.table<-data.frame(t1 <- with(psd.frame.ef, table(interaction(Species, Lake),PSDcat)))
packages("reshape2")
second.table<-dcast(first.table, Var1 ~ PSDcat, fun.aggregate = NULL )

second.table$Total<-rowSums(second.table[,2:7])
write.csv(second.table, "2019_PSD_Efish.csv", row.names = F)





(t1r <- t(apply(t1[,-1],MARGIN=1,FUN=rcumsum)) )

third.table<-data.frame( t1p <- round(t1r[,-1]/t1r[,1]*100,1) )
third.table$Total<-rowSums(third.table)
third.table<-cbind(second.table[,1],third.table)
write.csv(third.table, "2019_PSD_Efish 2.csv", row.names = F)

```



Trying some PSDs with the all fyke and ef data                                (2018 data --- 2018 data -- 2018 data)

******** New 2020 development: CANNOT have ef and fyke in same PSD table. 
- gears are size selective
- so now we split them up and make 2 psd tables! Life is grand

```{r}
str(diversity)

levels(diversity$Species)
psd.frame<-diversity

psd.frame$Species<-as.character(psd.frame$Species)
psd.frame$Species[psd.frame$Species == "BLC"]<-"Black Crappie"
psd.frame$Species[psd.frame$Species == "BBH"]<-"Brown Bullhead"
psd.frame$Species[psd.frame$Species == "BIB"]<-"Bigmouth Buffalo"
psd.frame$Species[psd.frame$Species == "BLB"]<-"Black Bullhead"
psd.frame$Species[psd.frame$Species == "BLG"]<-"Bluegill"
psd.frame$Species[psd.frame$Species == "COC"]<-"Common Carp"
psd.frame$Species[psd.frame$Species == "FWD"]<-"Freshwater Drum"
psd.frame$Species[psd.frame$Species == "GZS"]<-"Gizzard Shad"
psd.frame$Species[psd.frame$Species == "GSF"]<-"Green Sunfish"
psd.frame$Species[psd.frame$Species == "NOP"]<-"Northern Pike"
psd.frame$Species[psd.frame$Species == "OSS"]<-"Orangespotted Sunfish"
psd.frame$Species[psd.frame$Species == "SMB"]<-"Smallmouth Bass"
psd.frame$Species[psd.frame$Species == "WHB"]<-"White Bass"
psd.frame$Species[psd.frame$Species == "WHS"]<-"White Sucker"
psd.frame$Species[psd.frame$Species == "YEB"]<-"Yellow Bullhead"
psd.frame$Species[psd.frame$Species == "YEP"]<-"Yellow Perch"
psd.frame$Species[psd.frame$Species == "YLB"]<-"Yellow Bass"
psd.frame$Species[psd.frame$Species == "YLP"]<-"Yellow Perch"
psd.frame$Species[psd.frame$Species == "CCF"]<-"Channel Catfish"
psd.frame$Species[psd.frame$Species == "LMB"]<-"Largemouth Bass"
psd.frame$Species[psd.frame$Species == "WAE"]<-"Walleye"
psd.frame$Species[psd.frame$Species == "WHC"]<-"White Crappie"
psd.frame$Species[psd.frame$Species == "BLGxGSF"]<-"Hybrid Sunfish"
psd.frame$Species[psd.frame$Species == "WHX"]<-"Hybrid White Bass"
psd.frame$Species[psd.frame$Species == "SNG"]<-"Shortnose Gar"
psd.frame$Species[psd.frame$Species == "GIS"]<-"Gizzard Shad"

psd.frame$Species<-as.factor(psd.frame$Species)
levels(psd.frame$Species)

length(levels(psd.frame$Species))


summary(psd.frame$Species[psd.frame$Lake == "Blue"])
summary(psd.frame$Species[psd.frame$Lake == "Center"])
summary(psd.frame$Species[psd.frame$Lake == "Five Island"])
summary(psd.frame$Species[psd.frame$Lake == "N Twin"])
summary(psd.frame$Species[psd.frame$Lake == "Silver"])
summary(psd.frame$Species[psd.frame$Lake == "S Twin"])
summary(psd.frame$Species[psd.frame$Lake == "Storm"])



psdVal()
levels(psd.frame$Species)

# Also remove Carp and buff because of uneven sampling
psd.frame<-droplevels(subset(psd.frame, Species != "Golden Shiner" &
                                        Species != "Orangespotted Sunfish"&
                                        Species != "Painted turtle"&
                                        Species != "Hybrid Sunfish"&
                                        Species != "Emerald Shiner"&
                                        Species != "Shortnose Gar"&
                                        Species != "Spotfin shiner"&
                                        Species != "Spottail shiner" &
                                        Species != "Snapping Turtle" &
                                        Species != "Softshell Turtle"))

levels(psd.frame$Species)

# time to split by gear!
psd.frame.fyke<-droplevels(subset(psd.frame, Gear == "Fyke"))
psd.frame.ef<-droplevels(subset(psd.frame, Gear == "Electroshocking"))
```


## Fyke Net PSD table
```{r,}
psd.frame.fyke$PSDcat<-psdAdd(Length..mm.~Species, 
                              data = psd.frame.fyke,
                              units = "mm")
head(psd.frame.fyke)

first.table<-data.frame(t1 <- with(psd.frame.fyke, table(interaction(Species, Lake),PSDcat)))
packages("reshape2")
second.table<-dcast(first.table, Var1 ~ PSDcat, fun.aggregate = NULL )

second.table$Total<-rowSums(second.table[,2:7])
write.csv(second.table, "2018_PSD_Fyke.csv", row.names = F)





(t1r <- t(apply(t1[,-1],MARGIN=1,FUN=rcumsum)) )

third.table<-data.frame( t1p <- round(t1r[,-1]/t1r[,1]*100,1) )
third.table<-cbind(second.table[,1],third.table)
write.csv(third.table, "2018_PSD_Fyke 2.csv", row.names = F)

```



## Electrofishing PSD table
```{r,}
levels(psd.frame$Lake)
#Need to do COC and BIB only from the std sample days....
psd.frame.ef<-droplevels(subset(psd.frame.ef, Date == "2018-05-17" & Lake == "Center" |
                                              Date == "2018-05-18" & Lake == "Silver" | 
                                              Date == "2018-06-13" & Lake == "Blue"   | 
                                              Date == "2018-05-21" & Lake == "Storm"  |
                                              Date == "2018-06-04" & Lake == "N. Twin" |
                                              Date == "2018-05-23" & Lake == "Five Island")) 


psd.frame.ef$PSDcat<-psdAdd(Length..mm.~Species, 
                              data = psd.frame.ef,
                              units = "mm")
head(psd.frame.ef)

first.table<-data.frame(t1 <- with(psd.frame.ef, table(interaction(Species, Lake),PSDcat)))
packages("reshape2")
second.table<-dcast(first.table, Var1 ~ PSDcat, fun.aggregate = NULL )

second.table$Total<-rowSums(second.table[,2:7])
write.csv(second.table, "2018_PSD_Efish.csv", row.names = F)





(t1r <- t(apply(t1[,-1],MARGIN=1,FUN=rcumsum)) )

third.table<-data.frame( t1p <- round(t1r[,-1]/t1r[,1]*100,1) )
third.table$Total<-rowSums(third.table)
third.table<-cbind(second.table[,1],third.table)
write.csv(third.table, "2018_PSD_Efish 2.csv", row.names = F)

```













