---
title: "Chapter 2 - Mortality"
author: "Marty Simonson"
date: "September 25, 2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
```{r, include=FALSE}
# front matter
packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

#packages(rcompanion)
packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(FSA)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
packages(FSAdata)
packages(nlstools)
#packages(GGally)
packages(wesanderson)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(doBy)
packages(dplyr)
packages(tidyr)
packages(rcompanion)
packages(GISTools)
#packages(maps)
#packages(mapproj)
packages(ggpmisc)
packages(lubridate)
```
As of 1/31/2020 This file is meant to assemble all the code and plots relative to data analysis for Chapter 2. But let's start small, with the code relative to the 2020 Iowa AFS presentation. 

Beginning abstract draft:

# Title: Evaluating Additive Versus Compensatory Harvest Mortality in Common Carp and Bigmouth Buffalo

Authors: Martin A. Simonson, Michael J. Weber
Track: Contributed Oral - Fisheries

Tags/Keywords: Harvest Mortality, Biomanipulation, Capture-Mark-Recapture, Recruitment

## Abstract:
Establishment of non-native species is a primary cause of drastic change in ecological processes through the disruption of ecosystem structure and function at multiple levels. Harvest-based management, or mechanical removal, is a common method of population management that may serve as a restoration strategy in disrupted systems by minimizing the ecological impact of nuisance species. However, biomanipulation may not be successful when organisms compensate for harvest and reductions in biomass are not proportional to biomass removed. We implemented a capture-mark-recapture study at seven lakes in northwest Iowa to evaluate mechanisms Common Carp and Bigmouth Buffalo may use to compensate for harvest mortality (e.g., increased recruitment and natural survival rate). Density dependence was tested by performing an ANOVA to examine differences in body condition (Wr) between harvested and non-harvested lakes. _Couple sentences about results, couple about discussion_


## Additve vs. Compensatory Mortality

We have the general equation:

\[
S_i = S_0(1-bK_i)
\]

where $S_i$ is the annual total survival rate in year i. $S_0$ is the annual natural mortality rate in the ABSENCE of harvest, $K_i$ is the annual harvest mortality rate in year i, and $b$ is the slope of the relationship between annual survival rate and annual harvest mortality rate, normalized such that 0 < b < 1.

#### Harvest Mortality
Now, to get the variables in the equation above and isolate $b$, we can first determine harvest mortality (Ki):

\[
K_i = \frac{f_{i.} * f_{.i}}{m_i * n_i}
\]

where $m_i$ is the number of fish marked at the start of period i, and 
$f_{i.}$ is the number of fish marked in year i caught by fishers over all years, and
$f_{.i}$ is the number of marked fish caught in year i regardless of when they were marked, and
$n_i$ is the number of marked fish caught after year i of fish marked before year i.

```{r,include=FALSE}
#rm(list=ls())
#reading in data
dframe<-read.csv("2017-2020 Compiled Data.csv",header = T)
dframe$Year<-as.factor(dframe$Year)
dframe$TAG.NUMBER<-as.factor(dframe$TAG.NUMBER)
dframe$Date<-as.Date(dframe$Date, "%m/%d/%Y")
dframe$On.Time..s.<-as.numeric(dframe$On.Time..s.)
str(dframe)
# remove all other spp
dframe$TAG.NUMBER[dframe$TAG.NUMBER == ""]<-NA
dframe<-droplevels(subset(dframe, Species == "BIB" |
                                  Species == "COC" ))
# remove all dissected fish and non-tagged fish
dframe<-droplevels(subset(dframe, !is.na(as.numeric(as.character(dframe$TAG.NUMBER)))))
# change five island
dframe$Lake<-as.character(dframe$Lake)
dframe$Lake[dframe$Lake == "5 Island"]<- "Five Island"
dframe$Lake<-as.factor(dframe$Lake)


# 
#Harvested tags recovered
harvest<-read.csv("Harvest Tag Recovery.csv",header=T)
str(harvest)
harvest$Year<-as.factor(harvest$Year)
harvest$TAG.NUMBER<-as.factor(harvest$TAG.NUMBER)
harvest$Date<-as.Date(harvest$Date, "%m/%d/%Y")
summary(harvest$Lake)
# these are all the other tags that need to get censored
Censor <-droplevels(subset(harvest, Lake == "Five Island" | # found in dsm river
                                    Lake == "Storm" | # recovered dead
                                    Lake == "S Twin" | # sent off to hort farm
                                    Lake == "Blue")) # recreational catch, tags removed
# can split out the tags that were actually harvested
harvest<-droplevels(subset(harvest, Lake != "Five Island" &
                                    Lake != "Storm" & # recovered dead
                                    Lake != "S Twin" & # sent off to hort farm
                                    Lake != "Blue")) # recreational catch, tags removed
levels(harvest$Lake)
harvest$Lake<-as.character(harvest$Lake)
harvest$Lake[harvest$Lake == "N Twin "] <- "N Twin"
harvest$Lake[harvest$Lake == "5 Island"]<- "Five Island"
harvest$Lake<-as.factor(harvest$Lake)
levels(harvest$Notes)
harvest$detect<-1

levels(harvest$Gear)
harvest$Gear<-as.character(harvest$Gear)
harvest$Gear[harvest$Gear == "Seine"] <- "COMMERCIAL HARVEST"
harvest$Gear<-as.factor(harvest$Gear)


## CAN I SET SPECIES BY LOOKING UP PREV TAG NUMBER?
harvest$Species<-factor(harvest$Species, levels = c("BIB","COC"))
dframe.blend <- dframe[!duplicated(dframe$TAG.NUMBER),] # removing recaps
harvest.blend<-left_join(harvest,dframe.blend, by = "TAG.NUMBER")
sum(is.na(harvest.blend$Species.y)) # have about 21 tags recovered with no prior record at silver, Center, and N Twin
sum(is.na(harvest.blend$Species.y))/length(harvest.blend$TAG.NUMBER) # about 1.6% of all recovered tags do not have prior info
harvest$Species<-harvest.blend$Species.y
harvest<-droplevels(subset(harvest, !is.na(harvest$Species)))
#

# CENSOR TAGS FROM DF ABOVE
w <- which(levels(dframe$TAG.NUMBER) %in% levels(Censor$TAG.NUMBER)) # Get only those that are "matched"
w
dframe<-droplevels(subset(dframe, TAG.NUMBER != "3382" &
                                  TAG.NUMBER != "4494" &
                                  TAG.NUMBER != "8626" &
                                  TAG.NUMBER != "13309"&
                                  TAG.NUMBER != "13587"&
                                  TAG.NUMBER != "21278"&
                                  TAG.NUMBER != "23445"&
                                  TAG.NUMBER != "23952"&
                                  TAG.NUMBER != "24106"))

# correct a couple things
names(dframe)
names(harvest)
#
# Try to merge the frames now!
df<-rbind(dframe,harvest)
str(df)
summary(df$detect)
levels(harvest$Species)
summary(df$TAG.NUMBER) # about 14 fish with 4 observations, many more with 3.

# delete extraneous information
df2<-df[,c(1,2,3,4,5,8,11,21,22)]
# write.csv(df2, "2020/National AFS Meeting/Buffalo/LiveDead_LongFormat.csv",row.names=F)
```



```{r}
# report time of knitting
now()
```

# Master live-dead INP file

```{r, include = F}
ntwin<-droplevels(subset(df, Lake == "N Twin"))
str(ntwin)


unique(ntwin$Date[ntwin$Gear != "COMMERCIAL HARVEST"])
ntwin.tag<-droplevels(subset(ntwin, Gear != "COMMERCIAL HARVEST"))
ntwin.tag<-subset(ntwin.tag, Date != "2019-05-06") # fish not tagged May 6 2019, std runs for recaps only
ntwin.tag<-subset(ntwin.tag, Date != "2019-05-17") # fish not tagged May 17 2019, std runs for recaps only

unique(ntwin$Date[ntwin$Gear == "COMMERCIAL HARVEST"])
ntwin.har<-droplevels(subset(ntwin, Gear == "COMMERCIAL HARVEST"))

ntwin<-rbind(ntwin.tag,ntwin.har)
ntwin<-ntwin[order(as.Date(ntwin$Date, format = "%Y-%m-%d")),]


ntwin.c<-dcast(ntwin, Date+Gear ~ Species + detect)


# harvest date breaks at:
### 2019-04-04; 2019-04-05; 2019-04-07; 2019-04-08; 2019-04-09
### 2019-5-16; 2019-5-17
### 2019-11-23; 2019-11-30, 2019-11-06, 2019-11-25

#  M_i is the number of fish marked at the start of the period (all tags - harvest)

M_1<-data.frame(t(colSums(ntwin.c[c(1:31),c(3,4)]))) # marked in period 1 = pre 2019 harvest
M_2<- M_1+
      data.frame(t(colSums(ntwin.c[c(39:55),c(3,4)])))-
      data.frame(t(colSums(ntwin.c[c(32:38),c(3,4)])))# marked in period 2 = 2019 field season
M_3<- M_2+
      data.frame(ntwin.c[57,c(3,4)])-
      data.frame(ntwin.c[56,c(3,4)])# marked in one seine tag event before another late harvest 2019



# F_i., the number of fish marked in period i caught by fishers in all periods


F_1.<-data.frame(t(c(with(merge(subset(ntwin, Date <= "2019-04-03" & 
                                         ntwin$Species == "BIB"),  
                                ntwin.har, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(ntwin, Date <= "2019-04-03" & 
                                         ntwin$Species == "COC"),  
                                ntwin.har, by = "TAG.NUMBER"), length(Gear.y)))))

F_2.<-data.frame(t(c(with(merge(subset(ntwin, Date >= "2019-05-18" &
                                              Date <= "2019-10-04" & 
                                              ntwin$Species == "BIB"),  
                                ntwin.har, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(ntwin, Date >= "2019-05-18" &
                                              Date <= "2019-10-04" & 
                                              ntwin$Species == "COC"),  
                                ntwin.har, by = "TAG.NUMBER"), length(Gear.y)))))

F_3.<-data.frame(t(c(with(merge(subset(ntwin, Date == "2019-11-10" & 
                                              ntwin$Species == "BIB"),  
                                ntwin.har, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(ntwin, Date == "2019-11-10" & 
                                              ntwin$Species == "COC"),  
                                ntwin.har, by = "TAG.NUMBER"), length(Gear.y)))))


# F_.i, the number of fish caught in period i from all marking occasions

F_.1<-data.frame(t(c(with(merge(subset(ntwin, Date >= "2019-04-03" & 
                                              Date <= "2019-05-17" &
                                              ntwin$Species == "BIB"),  
                                ntwin.tag, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(ntwin, Date >= "2019-04-03" & 
                                              Date <= "2019-05-17" &
                                              ntwin$Species == "COC"),  
                                ntwin.tag, by = "TAG.NUMBER"), length(Gear.y)))))


F_.2<-data.frame(t(c(with(merge(subset(ntwin, Date == "2019-11-06" &
                                         ntwin$Species == "BIB"),  
                                ntwin.tag, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(ntwin, Date == "2019-11-06" &
                                         ntwin$Species == "COC"),  
                                ntwin.tag, by = "TAG.NUMBER"), length(Gear.y)))))


F_.3<-data.frame(t(c(with(merge(subset(ntwin, Date >= "2019-11-11" &
                                         ntwin$Species == "BIB"),  
                                ntwin.tag, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(ntwin, Date >= "2019-11-11" &
                                         ntwin$Species == "COC"),  
                                ntwin.tag, by = "TAG.NUMBER"), length(Gear.y)))))                    

# n_i, the number of marked fish caught after period i of fish marked before period i

n_1<-data.frame(t(c(with(merge(subset(ntwin, Date <= "2018-11-11" &  
                                        ntwin$Species == "BIB"),  
                               subset(ntwin.har, Date >= "2019-05-20"),
                               by = "TAG.NUMBER"), length(Gear.y)),
                    with(merge(subset(ntwin, Date <= "2018-11-11" & 
                                        ntwin$Species == "COC"),  
                               subset(ntwin.har, Date >= "2019-05-20"),
                               by = "TAG.NUMBER"), length(Gear.y))))) 


n_2<-data.frame(t(c(with(merge(subset(ntwin, Date <= "2019-10-05" &  
                                            ntwin$Species == "BIB"),
                               subset(ntwin.har, Date >= "2019-11-06"),
                               by = "TAG.NUMBER"), length(Gear.y)),
                        with(merge(subset(ntwin, Date <= "2019-10-05" & 
                                            ntwin$Species == "COC"),  
                                   subset(ntwin.har, Date >= "2019-11-06"),
                                   by = "TAG.NUMBER"), length(Gear.y)))))

n_3<-data.frame(t(c(with(merge(subset(ntwin, Date <= "2019-11-08" &  
                                        ntwin$Species == "BIB"),
                               subset(ntwin.har, Date >= "2019-11-21"),
                               by = "TAG.NUMBER"), length(Gear.y)),
                    with(merge(subset(ntwin, Date <= "2019-11-08" & 
                                        ntwin$Species == "COC"),  
                               subset(ntwin.har, Date >= "2019-11-21"),
                               by = "TAG.NUMBER"), length(Gear.y)))))

# now to aggregate this all together.
# data frame that will be: Lake, Species, Period (i), F_i., F_.i, M_i, and n_i. Use those to compute mu_i

Lake<-factor(rep("N Twin",6))
Species<-factor(rep(c("Bigmouth Buffalo","Common Carp"),3))

NTWIN<-data.frame(Lake,Species)
NTWIN$Period<-factor(c("1","1","2","2","3","3"))
NTWIN$F_i.<-as.numeric(as.character(c(F_1.,F_2.,F_3.)))
NTWIN$F_.i<-as.numeric(as.character(c(F_.1,F_.2,F_.3)))
NTWIN$M_i<-as.numeric(as.character(c(M_1,M_2,M_3)))
NTWIN$n_i<-as.numeric(as.character(c(n_1,n_2,n_3)))

# applying formula for mu_i
NTWIN<-data.frame(NTWIN)
str(NTWIN)
NTWIN$mu_i<-(NTWIN$F_i. * NTWIN$F_.i) / (NTWIN$M_i * NTWIN$n_i) # provides some biased estimates.
# DOES NOT ACCOUNT FOR TAG LOSS

NTWIN$fishing.mortality<-round(NTWIN$mu_i * 100, 1)




# add plot faceted lake x species





```


#### center fishing mortality
```{r}
center<-droplevels(subset(df, Lake == "Center"))
str(center)


unique(center$Date[center$Gear != "COMMERCIAL HARVEST"])
center.tag<-droplevels(subset(center, Gear != "COMMERCIAL HARVEST"))

unique(center$Date[center$Gear == "COMMERCIAL HARVEST"])
center.har<-droplevels(subset(center, Gear == "COMMERCIAL HARVEST"))

center<-rbind(center.tag,center.har)
center<-center[order(as.Date(center$Date, format = "%Y-%m-%d")),]






##
center.c<-dcast(center, Date+Gear ~ Species + detect) # need to ID harvest periods, after checking for harvest dates.
##







# harvest date breaks at:
### 

#  M_i is the number of fish marked at the start of the period (all tags - harvest)

M_1<-data.frame(t(colSums(center.c[c(1:31),c(3,4)]))) # marked in period 1 = pre 2019 harvest
M_2<- M_1+
      data.frame(t(colSums(center.c[c(39:55),c(3,4)])))-
      data.frame(t(colSums(center.c[c(32:38),c(3,4)])))# marked in period 2 = 2019 field season
M_3<- M_2+
      data.frame(center.c[57,c(3,4)])-
      data.frame(center.c[56,c(3,4)])# marked in one seine tag event before another late harvest 2019



# F_i., the number of fish marked in period i caught by fishers in all periods


F_1.<-data.frame(t(c(with(merge(subset(center, Date <= "2019-04-03" & 
                                         center$Species == "BIB"),  
                                center.har, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(center, Date <= "2019-04-03" & 
                                         center$Species == "COC"),  
                                center.har, by = "TAG.NUMBER"), length(Gear.y)))))

F_2.<-data.frame(t(c(with(merge(subset(center, Date >= "2019-05-18" &
                                              Date <= "2019-10-04" & 
                                              center$Species == "BIB"),  
                                center.har, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(center, Date >= "2019-05-18" &
                                              Date <= "2019-10-04" & 
                                              center$Species == "COC"),  
                                center.har, by = "TAG.NUMBER"), length(Gear.y)))))

F_3.<-data.frame(t(c(with(merge(subset(center, Date == "2019-11-10" & 
                                              center$Species == "BIB"),  
                                center.har, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(center, Date == "2019-11-10" & 
                                              center$Species == "COC"),  
                                center.har, by = "TAG.NUMBER"), length(Gear.y)))))


# F_.i, the number of fish caught in period i from all marking occasions

F_.1<-data.frame(t(c(with(merge(subset(center, Date >= "2019-04-03" & 
                                              Date <= "2019-05-17" &
                                              center$Species == "BIB"),  
                                center.tag, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(center, Date >= "2019-04-03" & 
                                              Date <= "2019-05-17" &
                                              center$Species == "COC"),  
                                center.tag, by = "TAG.NUMBER"), length(Gear.y)))))


F_.2<-data.frame(t(c(with(merge(subset(center, Date == "2019-11-06" &
                                         center$Species == "BIB"),  
                                center.tag, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(center, Date == "2019-11-06" &
                                         center$Species == "COC"),  
                                center.tag, by = "TAG.NUMBER"), length(Gear.y)))))


F_.3<-data.frame(t(c(with(merge(subset(center, Date >= "2019-11-11" &
                                         center$Species == "BIB"),  
                                center.tag, by = "TAG.NUMBER"), length(Gear.y)),
                     with(merge(subset(center, Date >= "2019-11-11" &
                                         center$Species == "COC"),  
                                center.tag, by = "TAG.NUMBER"), length(Gear.y)))))                    

# n_i, the number of marked fish caught after period i of fish marked before period i

n_1<-data.frame(t(c(with(merge(subset(center, Date <= "2018-11-11" &  
                                        center$Species == "BIB"),  
                               subset(center.har, Date >= "2019-05-20"),
                               by = "TAG.NUMBER"), length(Gear.y)),
                    with(merge(subset(center, Date <= "2018-11-11" & 
                                        center$Species == "COC"),  
                               subset(center.har, Date >= "2019-05-20"),
                               by = "TAG.NUMBER"), length(Gear.y))))) 


n_2<-data.frame(t(c(with(merge(subset(center, Date <= "2019-10-05" &  
                                            center$Species == "BIB"),
                               subset(center.har, Date >= "2019-11-06"),
                               by = "TAG.NUMBER"), length(Gear.y)),
                        with(merge(subset(center, Date <= "2019-10-05" & 
                                            center$Species == "COC"),  
                                   subset(center.har, Date >= "2019-11-06"),
                                   by = "TAG.NUMBER"), length(Gear.y)))))

n_3<-data.frame(t(c(with(merge(subset(center, Date <= "2019-11-08" &  
                                        center$Species == "BIB"),
                               subset(center.har, Date >= "2019-11-21"),
                               by = "TAG.NUMBER"), length(Gear.y)),
                    with(merge(subset(center, Date <= "2019-11-08" & 
                                        center$Species == "COC"),  
                               subset(center.har, Date >= "2019-11-21"),
                               by = "TAG.NUMBER"), length(Gear.y)))))

# now to aggregate this all together.
# data frame that will be: Lake, Species, Period (i), F_i., F_.i, M_i, and n_i. Use those to compute mu_i

Lake<-factor(rep("Center",6))
Species<-factor(rep(c("Bigmouth Buffalo","Common Carp"),3))

center<-data.frame(Lake,Species)
center$Period<-factor(c("1","1","2","2","3","3"))
center$F_i.<-as.numeric(as.character(c(F_1.,F_2.,F_3.)))
center$F_.i<-as.numeric(as.character(c(F_.1,F_.2,F_.3)))
center$M_i<-as.numeric(as.character(c(M_1,M_2,M_3)))
center$n_i<-as.numeric(as.character(c(n_1,n_2,n_3)))

# applying formula for mu_i
center<-data.frame(center)
str(center)
center$mu_i<-(center$F_i. * center$F_.i) / (center$M_i * center$n_i) # provides some biased estimates.
# DOES NOT ACCOUNT FOR TAG LOSS

center$fishing.mortality<-round(center$mu_i * 100, 1)



```

#### Silver Lake Fishing Mortality
```{r}

```


```{r}

```









#### Annual survival
Pollock's robust design, may not be necessary. Equation 3.2.3 in proposal.

\[
S_i = \frac{M_{i+1}}{(M_i - m_i + R_i)}
\]

where $M_i$ is the number of marked fish in the population prior to the ith sample, and
$m_i$ is the number of marked fish in sample i, and
$R_i$ is the number of fish captured in the ith sample that are released.

```{r}
#########################
#
#   North Twin
#
############################

# Mi

M_1<- data.frame(t(colSums(ntwin.c[c(1:31),c(3,4)]))) # marked in period 1 = pre 2019 harvest
M_2<- M_1+
      data.frame(t(colSums(ntwin.c[c(39:55),c(3,4)])))-
      data.frame(t(colSums(ntwin.c[c(32:38),c(3,4)])))# marked in period 2 = 2019 field season
M_3<- M_2+
      data.frame(ntwin.c[57,c(3,4)])-
      data.frame(ntwin.c[56,c(3,4)])# marked in one seine tag event before another late harvest 2019

# mi numer of marked fish insample i

m_1<-



```


## Variance of $S_i$ is calculated by methods outlined in seber 1982:

_put in equation for variance here!_

where ____ is ____, and


```{r}

```

#### b, the coefficient of harvest
And so when annual harvest mortality ($K_i$) is 0, $S_i = S_0$. We now have all the variablees to isolate $b$:

\[
b = \frac{1-\frac{S_i}{S_0}}{K_i}
\]

When $b = 0$ there is a completely compensatory response to harvest, and if $b=1$ there is a totally additive response to harvest; $b$ may take any value between 0 and 1 in instances of partial compensation to harvest.

_in particular, $b$ may be variable across the range of $K$, indicating a non-linear response to harvest and unequal compenstation depending on harvest rate_ but that might be too much to deal with for IA AFS 2020.

```{r}

```


## Annual Recruitment

Using Pollock's (1982) annual recruitment estimator, we can estimate the difference between the population size at time i+1 and the expected number of survivers from i to i+1:

\[
\hat{B_t} = \hat{N_{t+1}} - S_i * (\hat{N_i}-n_i +R_i)
\]

where
$N_{t+1}$ is the abundance estimate for species j in lake k in 2019 (for IA AFS), and
$S_i$ is the annual survival rate for species j in lake k for 2018 _calculated above_, and
$N_i$ is the abundance estimate for species j in lake k for 2018, and
$n_i$ is _maybe the number of fish caputred in the ith sample_
$R_i$ is the number of fish captured in the ith sample that are released _calculated above_.


```{r}

```


## Condition

Finally, populations may compensate for harvest through increased individual growth, meaning that the overall biomass does not change proportionally to the biomass removed. Therefore, we will test to see if the body condition of fish that survive a harvest increases more than fish who remain in non-harvested systems.

\[
W_r = \frac{W_i}{W_s}*100
\]

where $W_i$ is the individual fish weight, and 
$W_s$ is a length-specific standard weight predicted from a weight-length regression developed to represent the body form of carp and buffalo along their geographical range (provided in Blackwell et al 2000). 

```{r}
library(FSA)
# data frame - massage and subset
dframe<-read.csv("2017-2020 Compiled Data.csv",header = T)
dframe$Year<-as.factor(dframe$Year)
dframe$TAG.NUMBER<-as.factor(dframe$TAG.NUMBER)
dframe$Date<-as.Date(dframe$Date, "%m/%d/%Y")
dframe$On.Time..s.<-as.numeric(dframe$On.Time..s.)
dframe<-droplevels(subset(dframe, Species == "BIB" |
                                  Species == "COC" ))
# change five island
dframe$Lake<-as.character(dframe$Lake)
dframe$Lake[dframe$Lake == "5 Island"]<- "Five Island"
dframe$Lake<-as.factor(dframe$Lake)
#structure
str(dframe)


cond<-droplevels(subset(dframe, !is.na(dframe$Weight..g.)))
summary(cond$Lake)
cond$Species<-as.character(cond$Species)
cond$Species[cond$Species == "COC"] <- "Common Carp"
cond$Species[cond$Species == "BIB"] <- "Bigmouth Buffalo"
cond$Species<-as.factor(cond$Species)


# quick plot to examine how weights are distributed in each lake
require(ggplot2)
a<-ggplot(cond, aes(x=Weight..g.))+
    geom_histogram()+
    facet_grid(Lake ~ Species)
a

# Condition
levels(WSlit$species) # "Bigmouth Buffalo" and "Common Carp" are required spelling for names
cond$w_r<-wrAdd(Weight..g. ~ Length..mm. + Species, 
                  data = cond,
                  units = "metric") # was supposed to append two columns to cond

# Means for each species and year and lake??
Summarize(w_r~Lake*Species, data = cond, digits = 1)
Summarize(w_r~Year*Species, data = cond, digits = 1)

# Derek Ogle says other Wr comparisons cannot be made before determining if Wr differs across fish length categories.
cond$PSDcat<-psdAdd(Length..mm. ~ Species, data = cond, units = "mm") # ok then
```

```{r,}

#### now to subset and run within-year and within-lake ANOVAs

##################################
#
#           Center Lake
#
##################################
cond.carp.center.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Center" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.center.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.center.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Center" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.center.18)
anova(lm1) # some evidence for a difference between PSD categories within carp in center in 2018

cond.carp.center.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Center" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.center.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.center.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Center" &
                                   Year == "2017"))
lm3<-lm(w_r~PSDcat,data=cond.buff.center.17)
anova(lm3) # strong evidence for a difference in condition among PSD groups in center buff 2017

cond.buff.center.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Center" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.center.18)
anova(lm4) # evidence for a difference in condition

cond.buff.center.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Center" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.center.19)
anova(lm5) # NO EVIDENCE for a change in condition among PSD groups
```

```{r}
##################################
#
#           Five Island Lake
#
##################################

cond.carp.FiveIsland.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Five Island" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.FiveIsland.18)
anova(lm1) # STRONG evidence for a difference between PSD categories within carp in Five Island in 2018

cond.carp.FiveIsland.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "FiveIsland" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.FiveIsland.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.FiveIsland.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Five Island" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.FiveIsland.18)
anova(lm4) # evidence for a difference in condition

cond.buff.FiveIsland.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Five Island" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.FiveIsland.19)
anova(lm5) # STRONG evidence for a change in condition among PSD groups
```

```{r}
##################################
#
#           Blue Lake
#
##################################
cond.carp.blue.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Blue" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.blue.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.blue.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Blue" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.blue.18)
anova(lm1) # strong evidence for a difference between PSD categories within carp in center in 2018

cond.carp.blue.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Blue" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.blue.19)
anova(lm2) # strong evidence to support conclusion that there is a difference in PSD cats

```

```{r}
##################################
#
#           North Twin Lake
#
##################################
cond.carp.ntwin.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "N Twin" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.ntwin.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.ntwin.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "N Twin" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.ntwin.18)
anova(lm1) # No Evidence

cond.carp.ntwin.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "N Twin" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.ntwin.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.ntwin.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "N Twin" &
                                   Year == "2017"))
lm3<-lm(w_r~PSDcat,data=cond.buff.ntwin.17)
anova(lm3) # strong evidence for a difference in condition among PSD groups in center buff 2017

cond.buff.ntwin.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "N Twin" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.ntwin.18)
anova(lm4) # strongevidence for a difference in condition

cond.buff.ntwin.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "N Twin" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.ntwin.19)
anova(lm5) # Some evidence for a change in condition among PSD groups
```

```{r}
##################################
#
#           Silver Lake
#
##################################
cond.carp.silver.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Silver" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.silver.18)
anova(lm1) # some evidence for a difference between PSD categories within carp in center in 2018

cond.carp.silver.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Silver" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.silver.19)
anova(lm2) # STRONG evidence to support conclusion that there is a difference in PSD cats

cond.buff.silver.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Silver" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.silver.18)
anova(lm4) # STRONG evidence for a difference in condition

cond.buff.silver.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Silver" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.silver.19)
anova(lm5) # EVIDENCE for a change in condition among PSD groups
```

```{r}
##################################
#
#           South Twin Lake
#
##################################
cond.carp.stwin.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "S Twin" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.stwin.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.stwin.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "S Twin" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.stwin.18)
anova(lm1) # some evidence for a difference between PSD categories within carp in center in 2018

cond.carp.stwin.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "S Twin" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.stwin.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.stwin.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "S Twin" &
                                   Year == "2017"))
lm3<-lm(w_r~PSDcat,data=cond.buff.stwin.17)
anova(lm3) # NO evidence for a difference in condition among PSD groups in center buff 2017

cond.buff.stwin.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "S Twin" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.stwin.18)
anova(lm4) # NO evidence for a difference in condition

cond.buff.stwin.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "S Twin" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.stwin.19)
anova(lm5) # NO EVIDENCE for a change in condition among PSD groups
```
### Interesting that there is no evidence for a difference in condition among PSD categories in South Twin Buffalo for all 3 years. Interesting.

```{r}
##################################
#
#           Storm Lake
#
##################################
cond.carp.Storm.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Storm" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.Storm.18)
anova(lm1) # STRONG evidence for a difference between PSD categories within carp in Storm in 2018

cond.carp.Storm.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Storm" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.Storm.19)
anova(lm2) # WEAK evidence to support conclusion that there is a difference in PSD cats

cond.buff.Storm.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Storm" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.Storm.18)
anova(lm4) # evidence for a difference in condition

cond.buff.Storm.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Storm" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.Storm.19)
anova(lm5) # NO EVIDENCE for a change in condition among PSD groups.... SMALL SAMPLE SIZE
```

OK now that junk is done I guess. Informed me that there are differences in condition among PSD categories for both carp and buffalo in nearly all years (except South Twin Buffalo). Great that Ogle didn't specify what comes next once one determines that information...


### Condition ANOVA 1: within lakes between years

```{r}
# split by species first
cond.buff.cent<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Center"))

levels(cond.buff.cent$Year)
lm.cent<-lm(w_r~Year,cond.buff.cent)
summary(lm.cent)
anova(lm.cent)
fitPlot(lm.cent)

cond.buff.five<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Five Island"))

levels(cond.buff.five$Year)
lm.suc<-lm(w_r~Year,cond.buff.five)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.ntwin<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "N Twin"))

levels(cond.buff.ntwin$Year)
lm.suc<-lm(w_r~Year,cond.buff.ntwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.stwin<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "S Twin"))

levels(cond.buff.stwin$Year)
lm.suc<-lm(w_r~Year,cond.buff.stwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.silver<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Silver"))

levels(cond.buff.silver$Year)
lm.suc<-lm(w_r~Year,cond.buff.silver)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.storm<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Storm"))

levels(cond.buff.storm$Year)
lm.suc<-lm(w_r~Year,cond.buff.storm)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)


# now same is for carp carp carp
# split by species first
cond.carp.cent<-droplevels(subset(cond, Species == "Common Carp" &
                                        Lake == "Center"))

levels(cond.carp.cent$Year)
lm.cent<-lm(w_r~Year,cond.carp.cent)
summary(lm.cent)
anova(lm.cent)
fitPlot(lm.cent)

cond.carp.five<-droplevels(subset(cond, Species == "Common Carp" &
                                        Lake == "Five Island"))

levels(cond.carp.five$Year)
lm.suc<-lm(w_r~Year,cond.carp.five)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.ntwin<-droplevels(subset(cond, Species == "Common Carp" &
                                         Lake == "N Twin"))

levels(cond.carp.ntwin$Year)
lm.suc<-lm(w_r~Year,cond.carp.ntwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.stwin<-droplevels(subset(cond, Species == "Common Carp" &
                                         Lake == "S Twin"))

levels(cond.carp.stwin$Year)
lm.suc<-lm(w_r~Year,cond.carp.stwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.silver<-droplevels(subset(cond, Species == "Common Carp" &
                                          Lake == "Silver"))

levels(cond.carp.silver$Year)
lm.suc<-lm(w_r~Year,cond.carp.silver)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.storm<-droplevels(subset(cond, Species == "Common Carp" &
                                        Lake == "Storm"))

levels(cond.carp.storm$Year)
lm.suc<-lm(w_r~Year,cond.carp.storm)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)



```

### Condition ANOVA 2: within years between lakes

```{r}
# split by species first
cond.buff.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                      Year == "2017"))

levels(cond.buff.17$Lake)
lm.suc<-lm(w_r~Lake,cond.buff.17)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                      Year == "2018"))

levels(cond.buff.18$Lake)
lm.suc<-lm(w_r~Lake,cond.buff.18)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                      Year == "2019"))

levels(cond.buff.19$Lake)
lm.suc<-lm(w_r~Lake,cond.buff.19)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

# split by common carp second
cond.carp.17<-droplevels(subset(cond, Species == "Common Carp" &
                                      Year == "2017"))

levels(cond.carp.17$Lake)
lm.suc<-lm(w_r~Lake,cond.carp.17)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.18<-droplevels(subset(cond, Species == "Common Carp" &
                                      Year == "2018"))

levels(cond.carp.18$Lake)
lm.suc<-lm(w_r~Lake,cond.carp.18)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.19<-droplevels(subset(cond, Species == "Common Carp" &
                                      Year == "2019"))

levels(cond.carp.19$Lake)
lm.suc<-lm(w_r~Lake,cond.carp.19)
summary(lm.suc)
Anova(lm.suc,type="II")
fitPlot(lm.suc)
```

### Additive Anova: years and lakes

```{r}
cond.buff<-droplevels(subset(cond, Species == "Bigmouth Buffalo"))
all.buff<-lm(w_r~Year+Lake, cond.buff)
summary(all.buff)
anova(all.buff)
fitPlot(all.buff, main = "Bigmouth Buffalo Condition 2017 - 2019",
        ylab = "Relative Weight (Wr)", xlab = "Year",
        ylim = c(70,120),
        legend = "topleft",
        lwd = 3,
        col=c("darkorange1","burlywood","cadetblue1","chartreuse4","coral2","darkgoldenrod1"))

cond.carp<-droplevels(subset(cond, Species == "Common Carp"))
all.carp<-lm(w_r~Year+Lake, cond.carp)
summary(all.carp)
anova(all.carp)
fitPlot(all.carp, main = "Common Carp Condition 2017 - 2019",
        ylab = "Relative Weight (Wr)", xlab = "Year",
        ylim = c(70,120),
        legend = "topleft",
        lwd = 3,
        col=c("blue","darkorange1","burlywood","cadetblue3","chartreuse4","coral2","darkgoldenrod1"))

```

- colors look a bit better; could split colors by harvest/non-harvest lakes????

### Plots of condition for each species, but as a function of that year's Biomass Density.

Will need to merge the BMD file and this w_r file.
- merge by lake and year and species. This might look a lot like the bmd vs cpue plots in the annual report

```{r}
# let's trim some fat
cond<-cond[,c(1,2,4,21,23)]
head(cond)
cond<-droplevels(subset(cond, !is.na(cond$w_r)))
library(rcompanion)
cond2<-groupwiseMean(w_r~Lake+Year+Species,cond)
head(cond2)
# this looks pretty good; don't need the sample size (n) or conf.level columns. 
cond2<-cond2[,-c(4,6)]
levels(cond2$Lake)
cond2$Lake<-factor(cond2$Lake)


# bmd
bmd<-read.csv("Biomass Density 2017 - 2019.csv", header = T)
head(bmd)
bmd$Lake<-factor(bmd$Lake)
levels(bmd$Lake)


# now to merge/join the data frames
setdiff(bmd$Lake,cond2$Lake) # check to make sure that lakes are identical between frames
levels(cond2$Lake)
df<-merge(cond2,bmd, all = T)
head(df)

```

### plot that ish

```{r}
df.carp<-droplevels(subset(df, Species == "Common Carp"))
df.buff<-droplevels(subset(df, Species == "Bigmouth Buffalo"))


mod.carp<-lm(Mean ~ BMD + Year, data = df.carp)
summary(mod.carp)

mod.buff<-lm(Mean ~ BMD + Year, data = df.buff)
summary(mod.buff)

summary(df$Upper.BMD)
summary(df$Trad.upper)


BMD.Cond <- ggplot(df, aes(x=BMD, y=Mean, label = Lake)) +
                            geom_point(size=2) +
                            geom_errorbar(aes(ymax = Trad.upper, ymin = Trad.lower),width=20) +
                            geom_errorbarh(aes(xmax= Upper.BMD, xmin = Lower.BMD),height=5) +
                            geom_text(aes(label=Lake),hjust = -.25, vjust = .75, size = 3)+
                            labs(title = NULL,
                                  x = "Estimated Biomass Density (lbs. / acre)",
                                  y = "Relative Weight (Wr)") +
                            facet_grid(vars(Year),vars(Species))+ 
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(),
                                  panel.background = element_rect(fill="white",colour="grey50"),
                                  axis.line = element_line(colour = "black")) +
                            geom_smooth(method=lm,se=F) +
                            stat_poly_eq(formula = y~x,
                                         aes(label = paste(..eq.label..,..rr.label..,sep = "~~~")),
                                         parse=T)
BMD.Cond

```

not too shabby. Need input from MJW
- input from mjw is to change x axis to prior year's harvest amount (lbs/acre)
- change y axis to change in condition between that year.

```{r}
# let's trim some fat
cond<-cond[,c(1,2,4,21,23)]
head(cond)
cond<-droplevels(subset(cond, !is.na(cond$w_r)))
library(rcompanion)
cond2<-groupwiseMean(w_r~Lake+Year+Species,cond)
head(cond2)
# this looks pretty good; don't need the sample size (n) or conf.level columns. 
cond2<-cond2[,-c(4,6:8)]
levels(cond2$Lake)
cond2$Lake<-factor(cond2$Lake)

cond.2017<-droplevels(subset(cond2, Year == "2017"))
cond.2018<-droplevels(subset(cond2, Year == "2018"))
cond.2019<-droplevels(subset(cond2, Year == "2019"))
library(reshape2)
cond.melt<-melt(cond2)
cond.cast<-dcast(cond.melt, Lake + Species ~ Year)
# now create differences:
cond.cast$`17-18`<-cond.cast$`2018`-cond.cast$`2017`
cond.cast$`18-19`<-cond.cast$`2019`-cond.cast$`2018`

cond.cast<-cond.cast[,-c(3:5)]
cond3<-melt(cond.cast)

colnames(cond3)<-c("Lake","Species","Season","Delta Wr")
levels(harvest2$Lake)
levels(cond3$Lake)

cond3$Lake<-as.character(cond3$Lake)
cond3$Lake[cond3$Lake == "Blue"] <- "Blue Lake"
cond3$Lake[cond3$Lake == "Center"] <- "Center Lake"
cond3$Lake[cond3$Lake == "Five Island"] <- "Five Island Lake"
cond3$Lake[cond3$Lake == "N Twin"] <- "North Twin Lake"
cond3$Lake[cond3$Lake == "S Twin"] <- "South Twin Lake"
cond3$Lake[cond3$Lake == "Silver"] <- "Silver Lake"
cond3$Lake[cond3$Lake == "Storm"] <- "Storm Lake"
cond3$Lake<-as.factor(cond3$Lake)
########################################################################################
# harvested fish:
harvest<-read.csv("Commercial Harvest 2013 to 2019.csv")
str(harvest)
harvest<-harvest[,-c(2:3)]
harvest$Year<-factor(harvest$Year)
#harvest$Month<-factor(harvest$Month) 

nas<-subset(harvest, is.na(harvest$Harvest)) # should be empty
harvest$Date<-as.Date(harvest$Date, "%m/%d/%Y")
str(harvest$Date)
summary(harvest)

#Drop lakes
levels(harvest$Lake)
harvest<-droplevels(subset(harvest, Lake == "Center Lake" |
                         Lake == "Five Island Lake" |
                         Lake == "Silver Lake (Dickinson)" |
                         Lake == "North Twin Lake"))



#drop freshwater drum
harvest<-droplevels(subset(harvest, Species == "CAP"|
                                    Species == "BMB"))

# correct the species names for later plotting
harvest$Species<-as.character(harvest$Species)
harvest$Species[harvest$Species == "CAP"] <- "Common Carp"
harvest$Species[harvest$Species == "BMB"] <- "Bigmouth Buffalo"
harvest$Species<-factor(harvest$Species)

# add acrage
harvest$Acres[harvest$Lake == "Center Lake"] <- 220
harvest$Acres[harvest$Lake == "Five Island Lake"] <- 973
harvest$Acres[harvest$Lake == "Silver Lake (Dickinson)"] <- 1066
harvest$Acres[harvest$Lake == "North Twin Lake"] <- 453

# shorten silver lake name
harvest$Lake<-as.character(harvest$Lake)
harvest$Lake[harvest$Lake == "Silver Lake (Dickinson)"] <- "Silver Lake"
harvest$Lake<-factor(harvest$Lake)


# add column for pounds removed per acre
harvest$Removal<-harvest$Pounds/harvest$Acres


str(harvest)
# set harvest summed by season
# season 2017: harvest between 2017 and spring 2018. 
# Season 2018: harvest between 2018 and spring 2019

harvest$Season[harvest$Year == "2017" &
               harvest$Month >= 7 |
               harvest$Year == "2018" &
               harvest$Month <= 6]  <- "17-18"

harvest$Season[harvest$Year == "2018" &
               harvest$Month >= 7 |
               harvest$Year == "2019" &
               harvest$Month <= 6]  <- "18-19"
harvest<-droplevels(subset(harvest, !is.na(harvest$Season)))

harvest2<-groupwiseSum(Removal ~ Lake + Season + Species, harvest)

# that looks good for harvest sums!



# now to merge/join the data frames
setdiff(harvest2$Lake,cond3$Lake) # check to make sure that lakes are identical between frames

df<-merge(cond3,harvest2, all = T)
head(df)
df<-df[,-5] # removing n column
df$Sum[is.na(df$Sum)] <- 0
summary(df)

require(ggpmisc)
harvest.Cond <- ggplot(df, aes(x=Sum, y=`Delta Wr`, shape = Lake)) +
                            geom_point(size=3,) +
                            scale_shape_manual(values=1:nlevels(df$Lake)) +
                            geom_abline(slope = 0, intercept = 0, lty = 2)+
                            labs(title = NULL,
                                  x = "Estimated Biomass Removed (lbs. / acre)",
                                  y = "Change in Relative Weight (Wr)") +
                            facet_grid(vars(Season),vars(Species))+ 
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(),
                                  panel.background = element_rect(fill="white",colour="grey50"),
                                  axis.line = element_line(colour = "black")) 
harvest.Cond
```

