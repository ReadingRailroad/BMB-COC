---
title: "Chapter 2 - Mortality"
author: "Marty Simonson"
date: "September 25, 2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
```{r, include=FALSE}
# front matter
packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

#packages(rcompanion)
packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(FSA)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
packages(FSAdata)
packages(nlstools)
#packages(GGally)
packages(wesanderson)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(doBy)
packages(dplyr)
packages(tidyr)
packages(rcompanion)
packages(GISTools)
#packages(maps)
#packages(mapproj)
packages(ggpmisc)
packages(lubridate)
```
As of 1/31/2020 This file is meant to assemble all the code and plots relative to data analysis for Chapter 2. But let's start small, with the code relative to the 2020 Iowa AFS presentation. 

Beginning abstract draft:

# Title: Evaluating Additive Versus Compensatory Harvest Mortality in Common Carp and Bigmouth Buffalo

Authors: Martin A. Simonson, Michael J. Weber
Track: Contributed Oral - Fisheries

Tags/Keywords: Harvest Mortality, Biomanipulation, Capture-Mark-Recapture, Recruitment

## Abstract:
Establishment of non-native species is a primary cause of drastic change in ecological processes through the disruption of ecosystem structure and function at multiple levels. Harvest-based management, or mechanical removal, is a common method of population management that may serve as a restoration strategy in disrupted systems by minimizing the ecological impact of nuisance species. However, biomanipulation may not be successful when organisms compensate for harvest and reductions in biomass are not proportional to biomass removed. We implemented a capture-mark-recapture study at seven lakes in northwest Iowa to evaluate mechanisms Common Carp and Bigmouth Buffalo may use to compensate for harvest mortality (e.g., increased recruitment and natural survival rate). Density dependence was tested by performing an ANOVA to examine differences in body condition (Wr) between harvested and non-harvested lakes. _Couple sentences about results, couple about discussion_


## Additve vs. Compensatory Mortality

We have the general equation:

\[
S_i = S_0(1-bK_i)
\]

where $S_i$ is the annual total survival rate in year i. $S_0$ is the annual natural mortality rate in the ABSENCE of harvest, $K_i$ is the annual harvest mortality rate in year i, and $b$ is the slope of the relationship between annual survival rate and annual harvest mortality rate, normalized such that 0 < b < 1.

#### Harvest Mortality
Now, to get the variables in the equation above and isolate $b$, we can first determine harvest mortality (Ki):

\[
K_i = \frac{f_{i.} * f_{.i}}{m_i * n_i}
\]

where $m_i$ is the number of fish marked at the start of period i, and 
$f_{i.}$ is the number of fish marked in year i caught by fishers over all years, and
$f_{.i}$ is the number of marked fish caught in year i regardless of when they were marked, and
$n_i$ is the number of marked fish caught after year i of fish marked before year i.

```{r,include=FALSE}
rm(list=ls())
#reading in data
dframe<-read.csv("2017-2020 Compiled Data.csv",header = T)
dframe$Year<-as.factor(dframe$Year)
dframe$TAG.NUMBER<-as.factor(dframe$TAG.NUMBER)
dframe$Date<-as.Date(dframe$Date, "%m/%d/%Y")
dframe$On.Time..s.<-as.numeric(dframe$On.Time..s.)
str(dframe)
# remove all other spp
dframe$TAG.NUMBER[dframe$TAG.NUMBER == ""]<-NA
dframe<-droplevels(subset(dframe, Species == "BIB" |
                                  Species == "COC" ))
# remove all dissected fish and non-tagged fish
dframe<-droplevels(subset(dframe, !is.na(as.numeric(as.character(dframe$TAG.NUMBER)))))
# change five island
dframe$Lake<-as.character(dframe$Lake)
dframe$Lake[dframe$Lake == "5 Island"]<- "Five Island"
dframe$Lake<-as.factor(dframe$Lake)


# 
#Harvested tags recovered
harvest<-read.csv("Harvest Tag Recovery.csv",header=T)
str(harvest)
harvest$Year<-as.factor(harvest$Year)
harvest$TAG.NUMBER<-as.factor(harvest$TAG.NUMBER)
harvest$Date<-as.Date(harvest$Date, "%m/%d/%Y")
summary(harvest$Lake)
# can delete the single "five island" because it's an escaped fish caught in DSM
harvest<-droplevels(subset(harvest, Lake != "Five Island" &
                                    Lake != "Storm" &
                                    Lake != "S Twin" &
                                    Lake != "Blue"))
levels(harvest$Lake)
harvest$Lake<-as.character(harvest$Lake)
harvest$Lake[harvest$Lake == "N Twin "] <- "N Twin"
harvest$Lake[harvest$Lake == "5 Island"]<- "Five Island"
harvest$Lake<-as.factor(harvest$Lake)
levels(harvest$Notes)
harvest$detect<-1

levels(harvest$Gear)
harvest$Gear<-as.character(harvest$Gear)
harvest$Gear[harvest$Gear == "Seine"] <- "COMMERCIAL HARVEST"
harvest$Gear<-as.factor(harvest$Gear)


## CAN I SET SPECIES BY LOOKING UP PREV TAG NUMBER?
harvest$Species<-factor(harvest$Species, levels = c("BIB","COC"))
dframe.blend <- dframe[!duplicated(dframe$TAG.NUMBER),]
harvest.blend<-left_join(harvest,dframe.blend, by = "TAG.NUMBER")
harvest$Species<-harvest.blend$Species.y
harvest<-droplevels(subset(harvest, !is.na(harvest$Species)))
#
# correct a couple things
names(dframe)
names(harvest)
#
# Try to merge the frames now!
df<-rbind(dframe,harvest)
str(df)
summary(df$detect)
levels(df$Species)
levels(dframe$Species)
levels(harvest$Species)




```



```{r}
# report time of knitting
now()
```


```{r, include = F}

# want to write a function to get a Ki value for each lake based on break points (harvest)
HarvMort <- function(x){
  
               #m_i, number of fish marked at the start of the period
                    df.2<- df %>%
                      filter(Date[Gear])
                      )
  
                # sum of all 
  
     
     
               #f_i., the number of fish marked in year i caught by fishers in all years, and
     
     
     
     
              
               #f_.i, the number of marked fish caught in year i from all marking occasions, and
     
     
     
              

                #n_i, the number of marked fish caught after year i OF FISH MARKED BEFORE YEAR i
     
     
     
     ########### k_i, the final estimate of harvest mortality:
     
     k_i<-data.frame(cbind(Lake,i,Species,(f_i. * f_.i)/(m_i * n_i)))
     colnames(k_i)<-c("Lake","Period","Species","Harvest Mortality")
     print(k_i)
    
      }
  } 
}

# add plot faceted lake x species





```


```{r}

```


#### Annual survival
Pollock's robust design, may not be necessary. Equation 3.2.3 in proposal.

\[
S_i = \frac{M_{i+1}}{(M_i - m_i + R_i)}
\]

where $M_i$ is the number of marked fish in the population prior to the ith sample, and
$m_i$ is the number of marked fish in sample i, and
$R_i$ is the number of fish captured in the ith sample that are released.

```{r}
#########################
#
#   North Twin
#
############################

# Mi

M_1<- data.frame(t(colSums(ntwin.c[c(1:31),c(3,4)]))) # marked in period 1 = pre 2019 harvest
M_2<- M_1+
      data.frame(t(colSums(ntwin.c[c(39:55),c(3,4)])))-
      data.frame(t(colSums(ntwin.c[c(32:38),c(3,4)])))# marked in period 2 = 2019 field season
M_3<- M_2+
      data.frame(ntwin.c[57,c(3,4)])-
      data.frame(ntwin.c[56,c(3,4)])# marked in one seine tag event before another late harvest 2019





```


Variance of $S_i$ is calculated by methods outlined in seber 1982:

_put in equation for variance here!_

where ____ is ____, and


```{r}

```

#### b, the coefficient of harvest
And so when annual harvest mortality ($K_i$) is 0, $S_i = S_0$. We now have all the variablees to isolate $b$:

\[
b = \frac{1-\frac{S_i}{S_0}}{K_i}
\]

When $b = 0$ there is a completely compensatory response to harvest, and if $b=1$ there is a totally additive response to harvest; $b$ may take any value between 0 and 1 in instances of partial compensation to harvest.

_in particular, $b$ may be variable across the range of $K$, indicating a non-linear response to harvest and unequal compenstation depending on harvest rate_ but that might be too much to deal with for IA AFS 2020.

```{r}

```


## Annual Recruitment

Using Pollock's (1982) annual recruitment estimator, we can estimate the difference between the population size at time i+1 and the expected number of survivers from i to i+1:

\[
\hat{B_t} = \hat{N_{t+1}} - S_i * (\hat{N_i}-n_i +R_i)
\]

where
$N_{t+1}$ is the abundance estimate for species j in lake k in 2019 (for IA AFS), and
$S_i$ is the annual survival rate for species j in lake k for 2018 _calculated above_, and
$N_i$ is the abundance estimate for species j in lake k for 2018, and
$n_i$ is _maybe the number of fish caputred in the ith sample_
$R_i$ is the number of fish captured in the ith sample that are released _calculated above_.


```{r}

```


## Condition

Finally, populations may compensate for harvest through increased individual growth, meaning that the overall biomass does not change proportionally to the biomass removed. Therefore, we will test to see if the body condition of fish that survive a harvest increases more than fish who remain in non-harvested systems.

\[
W_r = \frac{W_i}{W_s}*100
\]

where $W_i$ is the individual fish weight, and 
$W_s$ is a length-specific standard weight predicted from a weight-length regression developed to represent the body form of carp and buffalo along their geographical range (provided in Blackwell et al 2000). 

```{r}
# data frame - massage and subset
dframe<-read.csv("2017-2020 Compiled Data.csv",header = T)
dframe$Year<-as.factor(dframe$Year)
dframe$TAG.NUMBER<-as.factor(dframe$TAG.NUMBER)
dframe$Date<-as.Date(dframe$Date, "%m/%d/%Y")
dframe$On.Time..s.<-as.numeric(dframe$On.Time..s.)
dframe<-droplevels(subset(dframe, Species == "BIB" |
                                  Species == "COC" ))
# change five island
dframe$Lake<-as.character(dframe$Lake)
dframe$Lake[dframe$Lake == "5 Island"]<- "Five Island"
dframe$Lake<-as.factor(dframe$Lake)
#structure
str(dframe)


cond<-droplevels(subset(dframe, !is.na(dframe$Weight..g.)))
summary(cond$Lake)
cond$Species<-as.character(cond$Species)
cond$Species[cond$Species == "COC"] <- "Common Carp"
cond$Species[cond$Species == "BIB"] <- "Bigmouth Buffalo"
cond$Species<-as.factor(cond$Species)


# quick plot to examine how weights are distributed in each lake
require(ggplot2)
a<-ggplot(cond, aes(x=Weight..g.))+
    geom_histogram()+
    facet_grid(Lake ~ Species)
a

# Condition
levels(WSlit$species) # "Bigmouth Buffalo" and "Common Carp" are required spelling for names
cond$w_r<-wrAdd(Weight..g. ~ Length..mm. + Species, 
                  data = cond,
                  units = "metric") # was supposed to append two columns to cond

# Means for each species and year and lake??
Summarize(w_r~Lake*Species, data = cond, digits = 1)
Summarize(w_r~Year*Species, data = cond, digits = 1)

# Derek Ogle says other Wr comparisons cannot be made before determining if Wr differs across fish length categories.
cond$PSDcat<-psdAdd(Length..mm. ~ Species, data = cond, units = "mm") # ok then
```

```{r,}

#### now to subset and run within-year and within-lake ANOVAs

##################################
#
#           Center Lake
#
##################################
cond.carp.center.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Center" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.center.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.center.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Center" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.center.18)
anova(lm1) # some evidence for a difference between PSD categories within carp in center in 2018

cond.carp.center.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Center" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.center.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.center.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Center" &
                                   Year == "2017"))
lm3<-lm(w_r~PSDcat,data=cond.buff.center.17)
anova(lm3) # strong evidence for a difference in condition among PSD groups in center buff 2017

cond.buff.center.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Center" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.center.18)
anova(lm4) # evidence for a difference in condition

cond.buff.center.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Center" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.center.19)
anova(lm5) # NO EVIDENCE for a change in condition among PSD groups
```

```{r}
##################################
#
#           Five Island Lake
#
##################################

cond.carp.FiveIsland.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Five Island" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.FiveIsland.18)
anova(lm1) # STRONG evidence for a difference between PSD categories within carp in Five Island in 2018

cond.carp.FiveIsland.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "FiveIsland" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.FiveIsland.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.FiveIsland.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Five Island" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.FiveIsland.18)
anova(lm4) # evidence for a difference in condition

cond.buff.FiveIsland.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Five Island" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.FiveIsland.19)
anova(lm5) # STRONG evidence for a change in condition among PSD groups
```

```{r}
##################################
#
#           Blue Lake
#
##################################
cond.carp.blue.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Blue" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.blue.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.blue.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Blue" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.blue.18)
anova(lm1) # strong evidence for a difference between PSD categories within carp in center in 2018

cond.carp.blue.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Blue" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.blue.19)
anova(lm2) # strong evidence to support conclusion that there is a difference in PSD cats

```

```{r}
##################################
#
#           North Twin Lake
#
##################################
cond.carp.ntwin.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "N Twin" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.ntwin.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.ntwin.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "N Twin" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.ntwin.18)
anova(lm1) # No Evidence

cond.carp.ntwin.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "N Twin" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.ntwin.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.ntwin.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "N Twin" &
                                   Year == "2017"))
lm3<-lm(w_r~PSDcat,data=cond.buff.ntwin.17)
anova(lm3) # strong evidence for a difference in condition among PSD groups in center buff 2017

cond.buff.ntwin.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "N Twin" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.ntwin.18)
anova(lm4) # strongevidence for a difference in condition

cond.buff.ntwin.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "N Twin" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.ntwin.19)
anova(lm5) # Some evidence for a change in condition among PSD groups
```

```{r}
##################################
#
#           Silver Lake
#
##################################
cond.carp.silver.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Silver" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.silver.18)
anova(lm1) # some evidence for a difference between PSD categories within carp in center in 2018

cond.carp.silver.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Silver" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.silver.19)
anova(lm2) # STRONG evidence to support conclusion that there is a difference in PSD cats

cond.buff.silver.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Silver" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.silver.18)
anova(lm4) # STRONG evidence for a difference in condition

cond.buff.silver.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Silver" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.silver.19)
anova(lm5) # EVIDENCE for a change in condition among PSD groups
```

```{r}
##################################
#
#           South Twin Lake
#
##################################
cond.carp.stwin.17<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "S Twin" &
                                             Year == "2017"))
lm0<-lm(w_r~PSDcat,data=cond.carp.stwin.17)
anova(lm0) # evidence for a significant difference between PSD categories for condition in center lake carp '17

cond.carp.stwin.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "S Twin" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.stwin.18)
anova(lm1) # some evidence for a difference between PSD categories within carp in center in 2018

cond.carp.stwin.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "S Twin" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.stwin.19)
anova(lm2) # no evidence to support conclusion that there is a difference in PSD cats

cond.buff.stwin.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "S Twin" &
                                   Year == "2017"))
lm3<-lm(w_r~PSDcat,data=cond.buff.stwin.17)
anova(lm3) # NO evidence for a difference in condition among PSD groups in center buff 2017

cond.buff.stwin.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "S Twin" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.stwin.18)
anova(lm4) # NO evidence for a difference in condition

cond.buff.stwin.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "S Twin" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.stwin.19)
anova(lm5) # NO EVIDENCE for a change in condition among PSD groups
```
### Interesting that there is no evidence for a difference in condition among PSD categories in South Twin Buffalo for all 3 years. Interesting.

```{r}
##################################
#
#           Storm Lake
#
##################################
cond.carp.Storm.18<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Storm" &
                                             Year == "2018"))
lm1<-lm(w_r~PSDcat,data=cond.carp.Storm.18)
anova(lm1) # STRONG evidence for a difference between PSD categories within carp in Storm in 2018

cond.carp.Storm.19<-droplevels(subset(cond, Species == "Common Carp" &
                                             Lake == "Storm" &
                                             Year == "2019"))
lm2<-lm(w_r~PSDcat,data=cond.carp.Storm.19)
anova(lm2) # WEAK evidence to support conclusion that there is a difference in PSD cats

cond.buff.Storm.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Storm" &
                                   Year == "2018"))
lm4<-lm(w_r~PSDcat,data=cond.buff.Storm.18)
anova(lm4) # evidence for a difference in condition

cond.buff.Storm.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                   Lake == "Storm" &
                                   Year == "2019"))
lm5<-lm(w_r~PSDcat,data=cond.buff.Storm.19)
anova(lm5) # NO EVIDENCE for a change in condition among PSD groups.... SMALL SAMPLE SIZE
```

OK now that junk is done I guess. Informed me that there are differences in condition among PSD categories for both carp and buffalo in nearly all years (except South Twin Buffalo). Great that Ogle didn't specify what comes next once one determines that information...


### Condition ANOVA 1: within lakes between years

```{r}
# split by species first
cond.buff.cent<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Center"))

levels(cond.buff.cent$Year)
lm.cent<-lm(w_r~Year,cond.buff.cent)
summary(lm.cent)
anova(lm.cent)
fitPlot(lm.cent)

cond.buff.five<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Five Island"))

levels(cond.buff.five$Year)
lm.suc<-lm(w_r~Year,cond.buff.five)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.ntwin<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "N Twin"))

levels(cond.buff.ntwin$Year)
lm.suc<-lm(w_r~Year,cond.buff.ntwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.stwin<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "S Twin"))

levels(cond.buff.stwin$Year)
lm.suc<-lm(w_r~Year,cond.buff.stwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.silver<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Silver"))

levels(cond.buff.silver$Year)
lm.suc<-lm(w_r~Year,cond.buff.silver)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.storm<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                        Lake == "Storm"))

levels(cond.buff.storm$Year)
lm.suc<-lm(w_r~Year,cond.buff.storm)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)


# now same is for carp carp carp
# split by species first
cond.carp.cent<-droplevels(subset(cond, Species == "Common Carp" &
                                        Lake == "Center"))

levels(cond.carp.cent$Year)
lm.cent<-lm(w_r~Year,cond.carp.cent)
summary(lm.cent)
anova(lm.cent)
fitPlot(lm.cent)

cond.carp.five<-droplevels(subset(cond, Species == "Common Carp" &
                                        Lake == "Five Island"))

levels(cond.carp.five$Year)
lm.suc<-lm(w_r~Year,cond.carp.five)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.ntwin<-droplevels(subset(cond, Species == "Common Carp" &
                                         Lake == "N Twin"))

levels(cond.carp.ntwin$Year)
lm.suc<-lm(w_r~Year,cond.carp.ntwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.stwin<-droplevels(subset(cond, Species == "Common Carp" &
                                         Lake == "S Twin"))

levels(cond.carp.stwin$Year)
lm.suc<-lm(w_r~Year,cond.carp.stwin)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.silver<-droplevels(subset(cond, Species == "Common Carp" &
                                          Lake == "Silver"))

levels(cond.carp.silver$Year)
lm.suc<-lm(w_r~Year,cond.carp.silver)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.storm<-droplevels(subset(cond, Species == "Common Carp" &
                                        Lake == "Storm"))

levels(cond.carp.storm$Year)
lm.suc<-lm(w_r~Year,cond.carp.storm)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)



```

### Condition ANOVA 2: within years between lakes

```{r}
# split by species first
cond.buff.17<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                      Year == "2017"))

levels(cond.buff.17$Lake)
lm.suc<-lm(w_r~Lake,cond.buff.17)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.18<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                      Year == "2018"))

levels(cond.buff.18$Lake)
lm.suc<-lm(w_r~Lake,cond.buff.18)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.buff.19<-droplevels(subset(cond, Species == "Bigmouth Buffalo" &
                                      Year == "2019"))

levels(cond.buff.19$Lake)
lm.suc<-lm(w_r~Lake,cond.buff.19)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

# split by common carp second
cond.carp.17<-droplevels(subset(cond, Species == "Common Carp" &
                                      Year == "2017"))

levels(cond.carp.17$Lake)
lm.suc<-lm(w_r~Lake,cond.carp.17)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.18<-droplevels(subset(cond, Species == "Common Carp" &
                                      Year == "2018"))

levels(cond.carp.18$Lake)
lm.suc<-lm(w_r~Lake,cond.carp.18)
summary(lm.suc)
anova(lm.suc)
fitPlot(lm.suc)

cond.carp.19<-droplevels(subset(cond, Species == "Common Carp" &
                                      Year == "2019"))

levels(cond.carp.19$Lake)
lm.suc<-lm(w_r~Lake,cond.carp.19)
summary(lm.suc)
Anova(lm.suc,type="II")
fitPlot(lm.suc)
```

### Additive Anova: years and lakes

```{r}
cond.buff<-droplevels(subset(cond, Species == "Bigmouth Buffalo"))
all.buff<-lm(w_r~Year+Lake, cond.buff)
summary(all.buff)
anova(all.buff)
fitPlot(all.buff, main = "Bigmouth Buffalo Condition 2017 - 2019",
        ylab = "Relative Weight (Wr)", xlab = "Year",
        ylim = c(70,120),
        legend = "topleft",
        lwd = 3,
        col=c("darkorange1","burlywood","cadetblue1","chartreuse4","coral2","darkgoldenrod1"))

cond.carp<-droplevels(subset(cond, Species == "Common Carp"))
all.carp<-lm(w_r~Year+Lake, cond.carp)
summary(all.carp)
anova(all.carp)
fitPlot(all.carp, main = "Common Carp Condition 2017 - 2019",
        ylab = "Relative Weight (Wr)", xlab = "Year",
        ylim = c(70,120),
        legend = "topleft",
        lwd = 3,
        col=c("blue","darkorange1","burlywood","cadetblue3","chartreuse4","coral2","darkgoldenrod1"))

```

- colors look a bit better; could split colors by harvest/non-harvest lakes????

### Plots of condition for each species, but as a function of that year's Biomass Density.

Will need to merge the BMD file and this w_r file.
- merge by lake and year and species. This might look a lot like the bmd vs cpue plots in the annual report

```{r}
# let's trim some fat
cond<-cond[,c(1,2,4,21,23)]
head(cond)
cond<-droplevels(subset(cond, !is.na(cond$w_r)))

cond2<-groupwiseMean(w_r~Lake+Year+Species,cond)

# this looks pretty good; don't need the sample size (n) or conf.level columns. 
cond2<-cond2[,-c(4,6)]
levels(cond2$Lake)
cond2$Lake<-factor(cond2$Lake)


# bmd
bmd<-read.csv("Biomass Density 2017 - 2019.csv", header = T)
head(bmd)
bmd$Lake<-factor(bmd$Lake)
levels(bmd$Lake)


# now to merge/join the data frames
setdiff(bmd$Lake,cond2$Lake) # check to make sure that lakes are identical between frames
levels(cond2$Lake)
df<-merge(cond2,bmd, all = T)
head(df)

```

### plot that ish

```{r}
df.carp<-droplevels(subset(df, Species == "Common Carp"))
df.buff<-droplevels(subset(df, Species == "Bigmouth Buffalo"))


mod.carp<-lm(Mean ~ BMD + Year, data = df.carp)
summary(mod.carp)

mod.buff<-lm(Mean ~ BMD + Year, data = df.buff)
summary(mod.buff)

summary(df$Upper.BMD)
summary(df$Trad.upper)


BMD.Cond <- ggplot(df, aes(x=BMD, y=Mean, label = Lake)) +
                            geom_point(size=2) +
                            geom_errorbar(aes(ymax = Trad.upper, ymin = Trad.lower),width=20) +
                            geom_errorbarh(aes(xmax= Upper.BMD, xmin = Lower.BMD),height=5) +
                            geom_text(aes(label=Lake),hjust = -.25, vjust = .75, size = 3)+
                            labs(title = NULL,
                                  x = "Estimated Biomass Density (lbs. / acre)",
                                  y = "Relative Weight (Wr)") +
                            facet_grid(vars(Year),vars(Species))+ 
                            theme(panel.grid.major = element_blank(), 
                                  panel.grid.minor = element_blank(),
                                  panel.background = element_rect(fill="white",colour="grey50"),
                                  axis.line = element_line(colour = "black")) +
                            geom_smooth(method=lm,se=F) +
                            stat_poly_eq(formula = y~x,
                                         aes(label = paste(..eq.label..,..rr.label..,sep = "~~~")),
                                         parse=T)
BMD.Cond

```

not too shabby. Need input from MJW