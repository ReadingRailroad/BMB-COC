---
title: "Marcus Age Comparison Plots"
author: "Martin Simonson"
date: "April 19, 2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r,include=F}
rm(list=ls())

packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

packages(vegan)
packages(ggplot2)
packages(reshape2)
packages(nnet)
packages(multcomp)
packages(plyr)
packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
packages(gridExtra)
packages(dplyr)

```


```{r,}
## Age comparison plots for North Twin Lake
#
# Buffalo and Carp
#
#
age<-read.csv("Marcus/BuffaloAges_Compiled.csv",header=T)
summary(age)


##############################################################

# Dorsals
        # marcus v drake
p1<-ggplot(age, aes(carp,x=Marcus_Dorsal, y=Drake_Dorsal))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Dorsal Spine Buffalo Age: Marcus vs. Drake")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p1

        # marcus v Marty
p2<-ggplot(age, aes(x=Marcus_Dorsal, y=Marty_Dorsal))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Dorsal Spine Buffalo Age: Marcus vs. Marty")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p2

        # Drake v Marty
p3<-ggplot(age, aes(x=Drake_Dorsal, y=Marty_Dorsal))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Dorsal Spine Buffalo Age: Drake vs. Marty")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p3

##############################################################
        

# Pectoral spines


        # marcus v drake
p4<-ggplot(age, aes(carp,x=Marcus_Pectoral, y=Drake_Pectoral))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Pectoral Spine Buffalo Age: Marcus vs. Drake")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p4

        # marcus v Marty
p5<-ggplot(age, aes(x=Marcus_Pectoral, y=Marty_Pectoral))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Pectoral Spine Buffalo Age: Marcus vs. Marty")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p5

        # Drake v Marty
p6<-ggplot(age, aes(x=Drake_Pectoral, y=Marty_Pectoral))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Pectoral Spine Buffalo Age: Drake vs. Marty")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p6

##############################################################

# sectioned otliths

        # marcus v drake
p7<-ggplot(age, aes(carp,x=Marcus_SectOto, y=Drake_SectOto))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Sectioned Otolith Buffalo Age: Marcus vs. Drake")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p7

        # marcus v Marty
p8<-ggplot(age, aes(x=Marcus_SectOto, y=Marty_SectOto))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Sectioned Otolith Buffalo Age: Marcus vs. Marty")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p8

        # Drake v Marty
p9<-ggplot(age, aes(x=Drake_SectOto, y=Marty_SectOto))+
  geom_point(size=5, alpha = 0.2)+
  geom_abline(slope = 1, intercept = 0)+
  ggtitle("Sectioned Otolith Buffalo Age: Drake vs. Marty")+
  theme_classic()+
  xlim(0,20)+
  ylim(0,20)
p9

##############################################################

grid.arrange(p1,p4,p7,
             p2,p5,p8,
             p3,p4,p9,
             ncol=3)


##############################################################

#

#

#       New plots: based on fact that pectoral spines have least CV

#       We will place Pectoral Age as the common X axis (but different for each reader)

#       Each of the other three structures will be columns

#       Each of the readers will be rows

#       Therefore a 9x9 grid

#       Within each plot we want to have the 1 to 1 line,

#       then the average age estimate from the reader for the column structure with error bars

##############################################################################################
ages<-read.csv("Marcus/BuffaloAges_Long.csv",header=T)
head(ages)


ggplot(ages, aes(x=))








```


# Coefficient of Variation computation

FOR EACH STRUCTURE:

\[
CV_j = 100\% * \frac{\sqrt{\Sigma_{i=1}^{R}\frac{(X_{ij}-X_j)^2}{R-1}}}{X_j}
\]

Where $CV_j$ is the age precision estimate for the $j$th fish. $X_{ij}$ is the $i$th age determination of the $j$th fish, $X_j$ is the mean age estimate of the $j$th fish, and $R$ is the number of times each fish is aged. 

Therefore, we need:

- $X_{ij}$: each of the 3 age estimates for each fish 

- $X_j$: the MEAN age estimate for each fish

- $R$: number of times each fish is aged. = 3

let's get to work!

```{r,}

age$j<-paste(age$Lake,age$TAG.NUMBER,sep = ".")
age$R<-3 # easy one. number of times fish is aged.

age<-age[,-c(1:7)]

head(age)

# MeanAge = Xj

###########################
#
#    Dorsal
#
###########################

dorsal<-age[,c(10,1,2,3,11)]
head(dorsal)

library(dplyr)
dorsal <- dorsal %>% mutate(MeanAge=(Marcus_Dorsal+Drake_Dorsal+Marty_Dorsal)/3)
head(dorsal)

# items to sum before the square root sign of denominator of CV equation.
dorsal$MarcusDenom<-((dorsal$Marcus_Dorsal-dorsal$MeanAge)^2)/(dorsal$R-1)
dorsal$DrakeDenom<-((dorsal$Drake_Dorsal-dorsal$MeanAge)^2)/(dorsal$R-1)
dorsal$MartyDenom<-((dorsal$Marty_Dorsal-dorsal$MeanAge)^2)/(dorsal$R-1)
head(dorsal)

# CV
dorsal$CV<-100*((sqrt(dorsal$MarcusDenom+dorsal$MartyDenom+dorsal$DrakeDenom))/dorsal$MeanAge)
summary(dorsal$CV)
packages(psych)
describe(dorsal$CV)
###########################
#
#    Pectoral
#
###########################
head(age)
pectoral<-age[,c(10,4,5,6,11)]
head(pectoral)

library(dplyr)
pectoral <- pectoral %>% mutate(MeanAge=(Marcus_Pectoral+Drake_Pectoral+Marty_Pectoral)/3)
head(pectoral)

# items to sum before the square root sign of denominator of CV equation.
pectoral$MarcusDenom<-((pectoral$Marcus_Pectoral-pectoral$MeanAge)^2)/(pectoral$R-1)
pectoral$DrakeDenom<-((pectoral$Drake_Pectoral-pectoral$MeanAge)^2)/(pectoral$R-1)
pectoral$MartyDenom<-((pectoral$Marty_Pectoral-pectoral$MeanAge)^2)/(pectoral$R-1)
head(pectoral)

# CV
pectoral$CV<-100*((sqrt(pectoral$MarcusDenom+pectoral$MartyDenom+pectoral$DrakeDenom))/pectoral$MeanAge)
summary(pectoral$CV)
describe(pectoral$CV)

###########################
#
#    sectioned otoliths
#
###########################
head(age)
SectOto<-age[,c(10,7,8,9,11)]
head(SectOto)

library(dplyr)
SectOto <- SectOto %>% mutate(MeanAge=(Marcus_SectOto+Drake_SectOto+Marty_SectOto)/3)
head(SectOto)

# items to sum before the square root sign of denominator of CV equation.
SectOto$MarcusDenom<-((SectOto$Marcus_SectOto-SectOto$MeanAge)^2)/(SectOto$R-1)
SectOto$DrakeDenom<-((SectOto$Drake_SectOto-SectOto$MeanAge)^2)/(SectOto$R-1)
SectOto$MartyDenom<-((SectOto$Marty_SectOto-SectOto$MeanAge)^2)/(SectOto$R-1)
head(SectOto)

# CV
SectOto$CV<-100*((sqrt(SectOto$MarcusDenom+SectOto$MartyDenom+SectOto$DrakeDenom))/SectOto$MeanAge)
summary(SectOto$CV)
describe(SectOto$CV)
###########################
#
#    Cracked and Sanded otoliths
#
###########################
head(age)
CrackOto<-age[,c(10,7,8,9,11)]
head(CrackOto)

library(dplyr)
CrackOto <- CrackOto %>% mutate(MeanAge=(Marcus_CrackOto+Drake_CrackOto+Marty_CrackOto)/3)
head(CrackOto)

# items to sum before the square root sign of denominator of CV equation.
CrackOto$MarcusDenom<-((CrackOto$Marcus_CrackOto-CrackOto$MeanAge)^2)/(CrackOto$R-1)
CrackOto$DrakeDenom<-((CrackOto$Drake_CrackOto-CrackOto$MeanAge)^2)/(CrackOto$R-1)
CrackOto$MartyDenom<-((CrackOto$Marty_CrackOto-CrackOto$MeanAge)^2)/(CrackOto$R-1)
head(CrackOto)

# CV
CrackOto$CV<-100*((sqrt(CrackOto$MarcusDenom+CrackOto$MartyDenom+CrackOto$DrakeDenom))/CrackOto$MeanAge)
summary(CrackOto$CV)
describe(CrackOto$CV)
```
