---
title: "CPUE Plots"
author: "Martin A. Simonson"
date: "January 12, 2018"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
```{r,include=FALSE}

rm(list=ls())
packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
#packages(arm)
packages(lattice)
packages(tikzDevice)
#packages(GGally)
packages(wesanderson)
packages(devtools)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(dplyr)
packages(tidyr)
packages(rcompanion)
```

# Per MJW Request:
Scatterplot and Correlation for biomass vs. CPUE for each species, which each lake represented by 1 point with 95% CI

very preliminary at this point and future refinement of how to calculate CPUE is necessary, but we need to describe the relationship somehow.

# ALL 2017 DATA

```{r,}
# Create DF with CPUE and 95% CI for each lake...

Lakes<-c("Blue","Center","North Twin","South Twin")
CarpBiomass <- c(120617,57932,9001,51187)
CarpDensity <- c(438.6,231.7,19.4,92.2)
BuffBiomass <- c(NA,81894,104513,26802)
BuffDensity <- c(NA,327.6,225.7,48.3)
CarpCPUE<-c(80.37,36.3,17.18,41.78)
BuffCPUE<-c(NA,102.29,24.56,64.65)
CarpLL<-c(59.99,22.41,9.74,29.96)
CarpUL<-c(100.76,50.20,24.63,53.05)
BuffLL<-c(NA,59.40,17.99,36.56)
BuffUL<-c(NA,145.17,31.14,95.32)
CarpBM.LL<-c(63432,45202,5387,29180)
CarpBM.UL<-c(224140,77317,17058,92395)
BuffBM.LL<-c(NA,70833,58659,21514)
BuffBM.UL<-c(NA,97419,185741,34005)

DF2017<-data.frame(Lakes,CarpBiomass,BuffBiomass,CarpBM.LL,CarpBM.UL,BuffBM.LL,BuffBM.UL,
               CarpCPUE,BuffCPUE,CarpLL,CarpUL,BuffLL,BuffUL)

summary(DF2017)

```

Now to create 2 plots, with regression lines (YAY!)

```{r,}

# visualize how CPUE changes as a function of biomass....
#
# I think biomass density might be beneficial here, but let's go with what MJW said

# Regression lines imply lm() but we'll see........

mod<-lm(CarpCPUE ~ CarpBiomass, data = DF2017)
summary(mod)
R2<-format(summary(mod)$r.squared,digits=3)


# Carp FIrst
carp<-ggplot(DF2017, aes(x=CarpBiomass, y=CarpCPUE)) +
  xlim(0,250000)+
  ylim(0,150)+
  geom_point(size=4) +
  geom_errorbar(aes(ymax = CarpUL, ymin = CarpLL),width=5000) +
  geom_errorbarh(aes(xmax= CarpBM.UL, xmin = CarpBM.LL),height=5) +
  annotate("text",x=c(130000,69000,25000,40000,10000,10000),y=c(85,33.3,12,49,140,130), 
           label = c("Blue","Center","North Twin","South Twin","R^2 = 0.972","p = 0.014")) +
  labs(title = "Relationship Between Common Carp Biomass and CPUE",
       x = "Estimated Common Carp Biomass (lbs.)",
       y = "Catch per Unit Effort (fish/hour)") +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  geom_smooth(method=lm,se=F) 


# Buffalo Second

mod2<-lm(BuffCPUE ~ BuffBiomass, data = DF2017)
summary(mod2)
R22<-format(summary(mod2)$r.squared,digits=3)
R22

buff<-ggplot(DF2017, aes(x=BuffBiomass, y=BuffCPUE)) +
  xlim(0,250000)+
  ylim(0,150)+
  geom_point(size=4) +
  geom_errorbar(aes(ymax = BuffUL, ymin = BuffLL),width=5000) +
  geom_errorbarh(aes(xmax=BuffBM.UL, xmin = BuffBM.LL),height=5) +
  annotate("text",x=c(90000,95000,38000,10000,10000),y=c(110,10,42,140,130), 
           label = c("Center","North Twin","South Twin","R^2 = 0.0902","p = 0.806")) +
  labs(title = "Relationship Between Bigmouth Buffalo Biomass and CPUE",
       x = "Estimated Bigmouth Buffalo Biomass (lbs.)",
       y = "Catch per Unit Effort (fish/hour)") +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  geom_smooth(method=lm,se=F)

# Problems here: when I remove the 0s from Blue Lake Buffalo, the regression is negative
# And the plot certainly doesn't look linear

grid.arrange(carp,buff,nrow=2,ncol=1)



```


I did what was asked, for now. That's all a person can really do.

# 2018 Data
- as of July 2018 - mixed ranges based on what spencer has entered
- as of July 23 2018 all samples up to 7-20 are entered (except the last 1 or 2 from Blue and Twins)
- collapse to averages (see below)
- still need catch n for CPUE but without seine hauls but with age structures

- CHANGING EVERYTHING BELOW TO INCORPORATE THE COMPILED DATA
__And need to add all the 0 fish / effort transects__
- as of 12/13/2018 I'll just ad the 0 fish 
__New 12-13-2018: importing "All.Biomass", the length-specific biomass and biomass density estimates from 2018.__ 
```{r}

# Create DF with CPUE, total biomass and biomass density (and 95% CIs) for each lake...

df<-read.csv("2018_COC_BIB_CMR_Data.csv",header=T) # load data 
head(df)
summary(df)

#### Data corrections
#
levels(df$Lake)
#

denframe<-read.csv("2018_BiomassDensityEstimates.csv",header=T)
denframe[,1]<-factor(c("Blue","Center","5 Island","N. Twin","S. Twin","Silver","Storm"))
head(denframe)
str(denframe)

```

creating the data frame necessary to plot

- biomass and density data frame
-- with schnabel pop estimates from december 2018
```{r,}

# CarpBiomass - avg from google sheets age structures * population estimates for that lake
BM<-denframe
colnames(BM)[1] <- "Lake"

# adding carp
BM$CarpN <- c(72140,6466,25798,3816,9755,20661,9251) # est carp abundance for 7 lakes as of 12/18/2018

# Buff pop estimates
BM$BuffN<- c(NA,3530,2300,18776,12486,34278,13724)
```

- CPUE data frame
```{r,}
###########################################
# CarpCPUE - n fish per hour electrofishing
#
coc.df<-subset(df,Species == "COC")                 # just carp
coc.df<-subset(coc.df, Gear == "Electroshocking")   # just e-fishing
coc.df<-subset(coc.df, !is.na(coc.df$On.Time..s.))  # only runs with recorded effort
coc.df$On.Time..s.<-as.numeric(coc.df$On.Time..s.)
str(coc.df)
# on-time in seconds to Effort in hours
coc.df$Effort<-coc.df$On.Time..s./3600

###########################################
# BuffCPUE - n fish per hour electrofishing
#
bib.df<-subset(df,Species == "BIB")                 # just Buff
bib.df<-subset(bib.df, Gear == "Electroshocking")   # just e-fishing
bib.df<-subset(bib.df, !is.na(bib.df$On.Time..s.))  # only runs with recorded effort
bib.df$On.Time..s.<-as.numeric(bib.df$On.Time..s.)
str(bib.df)
# on-time in seconds to Effort in hours
bib.df$Effort<-bib.df$On.Time..s./3600


# now to paste date/lake/run
coc.df$DLR<-factor(paste(coc.df$Date,coc.df$Lake,coc.df$Site.Transect))
bib.df$DLR<-factor(paste(bib.df$Date,bib.df$Lake,bib.df$Site.Transect))




##########################################
#
# CPUE
#
# Now to divide the count of captured fish by the mean effort per DLR
coc.cpue<-aggregate(Effort~Lake+DLR, data = coc.df, mean, na.action=NULL)
coc.df$dummy<-1
coc.n<-aggregate(dummy~Lake+DLR, data = coc.df, sum)
coc.cpue$n<-coc.n$dummy
coc.cpue$cpue<-coc.cpue$n/coc.cpue$Effort

  
# BuffCPUE -n fish per hour electrofishing

bib.cpue<-aggregate(Effort~Lake+DLR, data = bib.df, mean, na.action=NULL)
bib.df$dummy<-1
bib.n<-aggregate(dummy~Lake+DLR, data = bib.df, sum)
bib.cpue$n<-bib.n$dummy
bib.cpue$cpue<-bib.cpue$n/bib.cpue$Effort
bib.cpue<-bib.cpue[!is.na(bib.cpue$cpue),]



###############################################
#
#         data checking
#
#         Need to confirm EACH date/lake/run
#         and add in 0 values
BlueCheck<-subset(coc.cpue, Lake == "Blue")
levels(droplevels(BlueCheck$DLR))

FICheck<-subset(coc.cpue, Lake == "5 Island")
levels(droplevels(FICheck$DLR))

CenterCheck<-subset(coc.cpue, Lake == "Center")
levels(droplevels(CenterCheck$DLR))

NTCheck<-subset(coc.cpue, Lake == "N. Twin")
levels(droplevels(NTCheck$DLR))

SilverCheck<-subset(coc.cpue, Lake == "Silver")
levels(droplevels(SilverCheck$DLR))

STCheck<-subset(coc.cpue, Lake == "S. Twin")
levels(droplevels(STCheck$DLR))

StormCheck<-subset(coc.cpue, Lake == "Storm")
levels(droplevels(StormCheck$DLR))

################################################
BlueCheck<-subset(bib.cpue, Lake == "Blue")
levels(droplevels(BlueCheck$DLR))

FICheck<-subset(bib.cpue, Lake == "5 Island")
levels(droplevels(FICheck$DLR))

CenterCheck<-subset(bib.cpue, Lake == "Center")
levels(droplevels(CenterCheck$DLR))

NTCheck<-subset(bib.cpue, Lake == "N. Twin")
levels(droplevels(NTCheck$DLR))

SilverCheck<-subset(bib.cpue, Lake == "Silver")
levels(droplevels(SilverCheck$DLR))

STCheck<-subset(bib.cpue, Lake == "S. Twin")
levels(droplevels(STCheck$DLR))

StormCheck<-subset(bib.cpue, Lake == "Storm")
levels(droplevels(StormCheck$DLR))







```










```{r,}
# need a boxplot of CPUE for each lake apparently. Let's see:


boxplot(cpue~Lake,data=coc.cpue,
        main="Carp CPUE by Lake: 2018")

boxplot(cpue~Lake,data=bib.cpue,
        main="Buffalo CPUE by Lake: 2018")


###################################################
# hopefully find summary stats for below
###################################################


# CarpLL - lower bound for y axis 
# CarpUL- upper bound for y axis
COC.CPUE.95ci<-groupwiseMean(cpue ~ Lake,
              data = coc.cpue,
              conf = 0.95,
              digits = 3)

# BuffLL - lower bound for y axis
# BuffUL - upper bound for y axis
BIB.CPUE.95ci<-groupwiseMean(cpue ~ Lake,
              data = bib.cpue,
              conf = 0.95,
              digits = 3)

# CarpBM.LL - lower bound for x axis
# CarpBM.UL - upper bound for x axis
coc.BM<-coc.df[!is.na(coc.df$Weight.g),]
coc.BM.95ci<-groupwiseMean(Weight.g ~ Lake,
              data = coc.BM,
              conf = 0.95,
              digits = 3)
CarpBM.LL<-BM$CarpN*coc.BM.95ci$Trad.lower
CarpBM.UL<-BM$CarpN*coc.BM.95ci$Trad.upper


# BuffBM.LL - lower bound for x axis
# BuffBM.UL - lower bound for x axis
bib.BM<-bib.df[!is.na(bib.df$Weight.g),]
bib.BM.95ci<-groupwiseMean(Weight.g ~ Lake,
              data = bib.BM,
              conf = 0.95,
              digits = 3)
BuffBM.LL<-c(3152,2960,44598,13923,34507,12380)*bib.BM.95ci$Trad.lower
BuffBM.UL<-c(3152,2960,44598,13923,34507,12380)*bib.BM.95ci$Trad.upper


```

put that ish together


```{r,}

Lakes<-c("Blue","Center","Five Island","N Twin","Silver","S Twin","Storm")

DF<-data.frame(Lakes,
               BM$CarpBiomass,
               BM$BuffBiomass,
               CarpBM.LL,
               CarpBM.UL,
               c(NA,BuffBM.LL),
               c(NA,BuffBM.UL),
               COC.CPUE.95ci$Mean,
               c(NA,BIB.CPUE.95ci$Mean),
               COC.CPUE.95ci$Trad.lower,
               COC.CPUE.95ci$Trad.upper,
               c(NA,BIB.CPUE.95ci$Trad.lower),
               c(NA,BIB.CPUE.95ci$Trad.upper),
               BM$CarpDensity,
               BM$BuffDensity
               )

colnames(DF)<-c("Lake","CarpBiomass","BuffBiomass","CarpBM.LL","CarpBM.UL","BuffBM.LL","BuffBM.UL","CarpCPUE","BuffCPUE","CarpLL","CarpUL","BuffLL","BuffUL","CarpDensity","BuffDensity")

summary(DF)
```

Pat yourself on the back! we are in business. Now to build the plot

# X axis: Biomass in pounds
# Y axis: CPUE: #fish/hour

```{r}

# visualize how CPUE changes as a function of biomass....

mod<-lm(CarpCPUE ~ CarpBiomass, data = DF)
summary(mod)
R2<-format(summary(mod)$r.squared,digits=3)
R2


# Carp First
carp<-ggplot(DF, aes(x=CarpBiomass, y=CarpCPUE)) +
  xlim(0,500000)+ # increase of 100k
  ylim(0,350)+ # more than double from 2017
  geom_point(size=4) +
  geom_errorbar(aes(ymax = CarpUL, ymin = CarpLL),width=5000) +
  geom_errorbarh(aes(xmax= CarpBM.UL, xmin = CarpBM.LL),height=5) +
  annotate("text",x=c(175000,60000,200000,10000,40000,300000,75000,15000,15000),y=c(250,10,40,25,80,40,60,180,160), 
           label = c("Blue","Center","Five Island","N Twin","Silver","Twin","Storm","R^2 = 0.016","p = 0.014")) +
  labs(title = "2018 Common Carp Biomass and CPUE",
       x = "Estimated Common Carp Biomass (lbs.)",
       y = "Catch per Unit Effort (fish/hour)") +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  geom_smooth(method=lm,se=F) 


# Buffalo Second

mod2<-lm(BuffCPUE ~ BuffBiomass, data = DF)
summary(mod2)
R22<-format(summary(mod2)$r.squared,digits=3)
R22

buff<-ggplot(DF, aes(x=BuffBiomass, y=BuffCPUE)) +
  xlim(0,500000)+ # double from 2017
  ylim(0,150)+ # Same as 2018
  geom_point(size=4) +
  geom_errorbar(aes(ymax = BuffUL, ymin = BuffLL),width=5000) +
  geom_errorbarh(aes(xmax=BuffBM.UL, xmin = BuffBM.LL),height=5) +
  annotate("text",x=c(25000,25000,460000,75000,275000,190000,20000,20000),y=c(32,5,20,35,35,11,140,130), 
           label = c("Center","Five Island","N Twin","Silver","S Twin","Storm","R^2 = 0.079","p = 0.867")) +
  labs(title = "2018 Bigmouth Buffalo Biomass and CPUE",
       x = "Estimated Bigmouth Buffalo Biomass (lbs.)",
       y = "Catch per Unit Effort (fish/hour)") +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  geom_smooth(method=lm,se=F)

# Problems here: when I remove the 0s from Blue Lake Buffalo, the regression is negative
# And the plot certainly doesn't look linear

grid.arrange(carp,buff,nrow=2,ncol=1)

```

New plot for prairie lakes conference:

# X axis: fish density (# fish / acre )
# Y axis: CPUE: #fish/hour

```{r}

# visualize how CPUE changes as a function of biomass....

mod<-lm(CarpCPUE ~ CarpDensity, data = DF)
summary(mod)
R2<-format(summary(mod)$r.squared,digits=3)
R2


# Carp First
carp<-ggplot(DF, aes(x=CarpDensity, y=CarpCPUE)) +
  xlim(0,600)+ # 
  ylim(0,300)+ # 
  geom_point(size=4) +
  geom_errorbar(aes(ymax = CarpUL, ymin = CarpLL),width=5000) +
  geom_errorbarh(aes(xmax= CarpBM.UL, xmin = CarpBM.LL),height=5) +
  annotate("text",x=c(550,275,290,10,60,180,60,250,250),y=c(260,15,40,25,80,25,55,180,160), 
           label = c("Blue","Center","Five Island","N Twin","Silver","S Twin","Storm","R^2 = 0.591","p = 0.043")) +
  labs(title = "2018 Common Carp Density and CPUE",
       x = "Estimated Common Carp Density (fish/acre)",
       y = "Catch per Unit Effort (fish/hour)") +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  geom_smooth(method=lm,se=F) 


# Buffalo Second

mod2<-lm(BuffCPUE ~ BuffDensity, data = DF)
summary(mod2)
R22<-format(summary(mod2)$r.squared,digits=3)
R22

buff<-ggplot(DF, aes(x=BuffDensity, y=BuffCPUE)) +
  xlim(0,1500)+ # double from 2017
  ylim(0,300)+ # Same as 2018
  geom_point(size=4) +
  geom_errorbar(aes(ymax = BuffUL, ymin = BuffLL),width=5000) +
  geom_errorbarh(aes(xmax=BuffBM.UL, xmin = BuffBM.LL),height=5) +
  annotate("text",x=c(0,200,1400,150,350,175,500,500),y=c(32,10,20,35,35,0,140,130), 
           label = c("Center","Five Island","N Twin","Silver","S Twin","Storm","R^2 = 0.026","p = 0.762")) +
  labs(title = "2018 Bigmouth Buffalo Density and CPUE",
       x = "Estimated Bigmouth Buffalo Density (fish/acre)",
       y = "Catch per Unit Effort (fish/hour)") +
  theme_bw() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  geom_smooth(method=lm,se=F)

# Problems here: when I remove the 0s from Blue Lake Buffalo, the regression is negative
# And the plot certainly doesn't look linear

grid.arrange(carp,buff,nrow=1,ncol=2)

```

# New plot of biomass density on y axis and lakes on x axis

```{r,}
DF$CarpBMD<-DF$CarpBiomass/BM$LakeArea
summary(DF$CarpBMD)
DF$CarpBM.LL.BMD

DF$BuffBMD<-DF$BuffBiomass/BM$LakeArea
summary(DF$BuffBMD)

boxplot(CarpBMD~Lake,data=DF)




```











#####

# Derek Ogle's Chapter 7: CPUE

This file is from the Chapter7-FishR file on desktop's desktop (LOL)

-packages and options:
```{r}
packages(FSA)
packages(car)
packages(Hmisc)
packages(multcomp)

options(width=90,continue=" ",show.signif.stars=F,
        contrasts=c("contr.sum","contr.poly"))
par(mar=c(3.5,3.5,1,1), mgp=c(2.1,0.4,0),tcl=-0.2)
```


-detections of changes in relative abundance with highly variable cpue data
an example:

```{r}
year <- 0:14 # years for simulation
N0 <- 10000 # initial population size
A <- 0.95 # annual survival rate
abund <- round(N0*A^year,0) # abundance from exponential decay model
cpe <- round(abund/1000,1) # simulated cpe data
cbind(year,abund) # for display only
```

now randocm cpue data

```{r}
me1 <- c(-0.10,-0.05,0.05,0.10)
me1a <- sample(me1,length(cpe),replace=TRUE)
cpe.me1 <- round(cpe+cpe*me1a,1)
# 20 and 40 % error below
me2 <- c(-0.4,-0.2,0.1,0.4)
me2a <- sample(me2,length(cpe),replace=TRUE)
cpe.me2 <- round(cpe+cpe*me2a,1)
( d1 <- data.frame(year,abund,cpe,cpe.me1,cpe.me2) ) # for storage

plot(cpe~year,data=d1,ylim=c(0,15),xlab="Year",ylab="CPE",type="l",lwd=2,col="black")
points(d1$year,d1$cpe.me1,type="b",pch=19,lwd=1,col="blue")
points(d1$year,d1$cpe.me2,type="b",pch=19,lwd=1,col="red")
legend("topright",legend=c("Truth","5 or 10%","20 or 40%"),col=c("black","blue","red"),
lwd=c(2,1,1),pch=c(NA,19,19))


# simulation to do same as plot just above
cpe.sim <- function(year,cpe,me1,me2=NULL) {
  cpe1 <- cpe + cpe*sample(me1,length(cpe),replace=TRUE)
  if (!is.null(me2)) cpe2 <- cpe + cpe*sample(me2,length(cpe),replace=TRUE)
  max.y <- max(c(cpe,cpe1,cpe2))
  plot(year,cpe,ylim=c(0,max.y),xlab="Year",ylab="CPE",type="l",lwd=2,col="black")
  points(year,cpe1,type="b",pch=19,lwd=1,col="blue")
  if (!is.null(me2)) points(year,cpe2,type="b",pch=19,lwd=1,col="red")
  if (is.null(me2)) legend("topright",legend=c("Truth","CPE1"),col=c("black","blue"),lwd=c(2,1),pch=19)
  else legend("topright",legend=c("Truth","CPE1","CPE2"),col=c("black","blue","red"),lwd=c(2,1,1),pch=19)
}

cpe.sim(d1$year,d1$cpe,me1,me2)
```


# new example with catfish
```{r}
d2 <- read.table("Box7_2.txt",header=TRUE)
str(d2)


# log transformation added to df in order to assess effects of data transformation
d2$logcpe.A <- log10(d2$cpe.A+1) # CCF population in reservoir 1
d2$logcpe.B <- log10(d2$cpe.B+1) # ccf population in reservoir 2
str(d2)

lapply(as.list(d2[,-1]),Summarize,digits=3)
hist(d2$cpe.A,main="CPUE frequency in reservoir A")
hist(d2$cpe.B,main="CPUE frequency in reservoir B")
hist(d2$logcpe.A,main="log transformed cpue in reservoir A")
hist(d2$logcpe.B,main="log transformed cpue in reservoir B")

# Power calculations: saving mean and SD for log-transformed cpue in reservoir B
( mn.B <- mean(d2$logcpe.B) )
( sd.B <- sd(d2$logcpe.B) )

# power test to detect 10% change in cpue
power.t.test(n=NULL,delta=mn.B*0.10,power=0.9,sig.level=0.05,sd=sd.B,type="two.sample",
              alt="one.sided")

power.t.test(n=NULL,delta=mn.B*0.20,power=0.8,sig.level=0.10,sd=sd.B,type="two.sample",
              alt="one.sided")


```

## he continues with habitat assessment and blocking. 
for now I'm frustrated at what example turned into.
walked around the builidng let's see who feels different.
nah.

```{r}
perc.delta <- seq(0.05,0.25,0.01)
deltas <- mn.B*perc.delta
p1 <- sapply(deltas,power.t.test,n=NULL,power=0.9,sig.level=0.05,sd=sd.B,type="two.sample",
              alt="one.sided")
p1.n <- as.numeric(p1["n",])
plot(p1.n~perc.delta,xlab="Proportion Population Decline",ylab="Sample Size",type="l",
              ylim=c(0,max(p1.n)))



```

