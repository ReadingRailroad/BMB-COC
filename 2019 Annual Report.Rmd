---
title: "2019 Annual Report"
author: "Martin A. Simonson"
date: "January 6, 2019"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r,include=FALSE}
rm(list=ls())


packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

#remove.packages(c("ggplot2", "data.table"))
#install.packages('Rcpp', dependencies = TRUE)
#install.packages('ggplot2', dependencies = TRUE)
#install.packages('data.table', dependencies = TRUE)

#packages(rcompanion)
#packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(FSA)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
#packages(GGally)
packages(wesanderson)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(doBy)
packages(dplyr)
packages(tidyr)
```

# DNR Permit data


```{r, include = F}
datframe<-read.csv("2018_COC_BIB_CMR_Data.csv", header = T)
str(datframe)



# Lakes
levels(datframe$Lake)
datframe$detect<-1
junk<-melt(datframe, id.var = c("Species","Lake"),
           measure.vars = "detect")
LakeTotals<-dcast(junk,Species~Lake)
# this is good for overall total catch, HOWEVER:
#   For DNR permit (and probably subsequent IACUC) 
#   I need to split by released alive and euthanized





levels(datframe$Notes)
length(datframe$Species[datframe$Notes == "euthanized"])
datframe$Notes[datframe$Notes == "Aging Fish" |
                 datframe$Notes == "Aging Fish " |
                 datframe$Notes == "Aging Fish - 2017 Tag Loss" |
                 datframe$Notes == "Aging Fish - 2017 Tag Loss Female" |
                 datframe$Notes == "Aging Fish - Female" |
                 datframe$Notes == "Aging Fish - Male" |
                 datframe$Notes == "Aging Fish - Mirror" |
                 datframe$Notes == "Aging Fish - Scoliosis" |
                 datframe$Notes == "Aging Fish 2017 Tag Loss Female"] <- "euthanized"
datframe$Notes<-droplevels(datframe$Notes)
levels(datframe$Notes)
length(datframe$Species[datframe$Notes == "euthanized"])

# Released Alive 2018 
Alive<-subset(datframe, Notes != "euthanized")
A.melt<-melt(Alive, id.var = c("Species","Lake"),
              measure.vars = "detect")
AliveTotal<-dcast(A.melt,Species~Lake)
write.csv(AliveTotal, "2018 Catch-Released.csv")

# Euthanized 2018
Euth<-subset(datframe, Notes == "euthanized")
E.melt<-melt(Euth, id.var = c("Species","Lake"),
             measure.vars = "detect")
EuthTotal<-dcast(E.melt, Species~Lake)
write.csv(EuthTotal, "2018 Catch-Euthanized.csv")

```


# Annual Report Table and meeting Plots: Total Catches, then split by gear
- df of total catches by gear for each species in each lake (Table)
            - ending up with many rows and a column for each lake.
- stacked barplot is in order



```{r,}
##########################################################################
# 2018 catch
catch.melt<-melt(datframe, id.var = c("Species","Lake"),
              measure.vars = "detect")
TotalCatch<-dcast(catch.melt,Species~Lake)
#write.csv(TotalCatch, "2018 Catch by gear.csv")

#########################################################################
# 2018 Carp and Buffalo Catch split by gear

gear.melt<-melt(datframe, id.var = c("Species","Lake","Gear"),
              measure.vars = "detect")
GearCatch<-dcast(gear.melt,Lake + Gear~Species)
GearCatch<-GearCatch[,c(1,2,4,10)]

# Buffalo
GearPlot.Buff<-ggplot(GearCatch, aes(x=Lake, y = BIB, fill = Gear))+
                geom_bar(stat="identity",colour="black") +
                scale_fill_manual(values = wes_palette("Royal1")) +
                scale_y_continuous(limits = c(0,5000)) +
                labs(title = "2018 Total Bigmouth Buffalo Catch By Gear",
                 x="Lake",
                 y="Bigmouth Buffalo Catch") +
                theme_classic()

# Carp
GearPlot.Carp<-ggplot(GearCatch, aes(x=Lake, y = COC, fill = Gear))+
                geom_bar(stat="identity",colour="black") +
                scale_fill_manual(values = wes_palette("Chevalier1")) +
                scale_y_continuous(limits = c(0,5000)) +
                labs(title = "2018 Total Common Carp Catch By Gear",
                 x="Lake",
                 y="Common Carp Catch") +
                theme_classic()

grid.arrange(GearPlot.Buff,
             GearPlot.Carp,
             nrow=2,
             ncol=1)

```

# 2018 Length Frequencies
- Reading in data
- splitting up the lakes
- split by gear too and exclude fyke nets
- delete unnecessary columns for LF (most of them)

__Problem__: have to switch these to inches probably
```{r,}
#reading in data
dframe<-read.csv("2018_COC_BIB_CMR_Data.csv")
dframe<-dframe[,-1]

# removing fyke catches
levels(dframe$Gear)
dframe<-subset(dframe, Gear == "Electroshocking" |
                       Gear == "Commercial Seine")

# getting rid of unused columns
str(dframe)
dframe<-dframe[,-c(1,3,6:10,12:21)]

# splitting data frame by Lakes
levels(dframe$Lake)
Blue <- subset(dframe, Lake == "Blue")
Center<-subset(dframe, Lake == "Center")
FiveIsland<-subset(dframe, Lake == "5 Island")
NTwin<-subset(dframe, Lake == "N. Twin")
Silver<-subset(dframe, Lake == "Silver")
STwin<-subset(dframe, Lake == "S. Twin")
Storm<-subset(dframe, Lake == "Storm")

```

## Blue Lake
```{r}
# No extreme need to split species (one BIB in dataset) but I'll do it anyway
blue.coc<-subset(Blue, Species == "COC" & !is.na(Length..mm.))
blue.coc<-blue.coc[,-c(1:2)]
blue.coc<-melt(blue.coc)

# Length Frequency Histograms
# 2017






#2018
BlueLF.2018<-ggplot(blue.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack",
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,700))+
                labs(x = "",
                      y = "(Note larger y-axis)") +
                theme_classic()+
                annotate("text",x=750,y=600,label="Blue Lake Carp Length-Frequency")
BlueLF.2018


```

## Center Lake
```{r}
# Subsetting species
#                             Carp
center.coc<-subset(Center, Species == "COC" & !is.na(Length..mm.))
center.coc<-center.coc[,-c(1:2)]
center.c.m<-melt(center.coc)

#                             Buffalo
center.bib<-subset(Center, Species == "BIB" & !is.na(Length..mm.))
center.bib<-center.bib[,-c(1:2)]
center.b.m<-melt(center.bib)

# Length Frequency Histograms
# 2017





#2018 Carp
centerLF.c.2018<-ggplot(center.c.m, aes(x=value,  fill=Gear))+
                geom_histogram(binwidth=10, 
                               colour="black", 
                               position = "stack",
                               show.legend = FALSE) +
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x="",y="")+
                theme_classic()+
                annotate("text",x=250, y = 100, label = "Center Lake Carp Length-Frequency")
centerLF.c.2018
#2018 Buffalo
centerLF.b.2018<-ggplot(center.b.m, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend = F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text", x= 250, y = 100, label = "Center Lake Buffalo Length-Frequency")
centerLF.b.2018

```

## Five Island Lake
```{r}
# Subsetting species
#                             Carp
FiveIsland.coc<-subset(FiveIsland, Species == "COC" & !is.na(Length..mm.))
FiveIsland.coc<-FiveIsland.coc[,-c(1:2)]
FiveIsland.coc<-melt(FiveIsland.coc)
#                             Buffalo
FiveIsland.bib<-subset(FiveIsland, Species == "BIB" & !is.na(Length..mm.))
FiveIsland.bib<-FiveIsland.bib[,-c(1:2)]
FiveIsland.bib<-melt(FiveIsland.bib)

# Length Frequency Histograms
# 2017






#2018 Carp
FiveIslandLF.c.2018<-ggplot(FiveIsland.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",
                     y = "") +
                theme_classic()+
                annotate("text", x= 250, y = 150, label = "Five Island Lake Carp Length-Frequency")
FiveIslandLF.c.2018
#2018 Buffalo 
FiveIslandLF.b.2018<-ggplot(FiveIsland.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend=F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label="Five Island Lake Buffalo Length-Frequency")
FiveIslandLF.b.2018

```

## North Twin Lake
```{r}
# Subsetting species
#                             Carp
NTwin.coc<-subset(NTwin, Species == "COC" & !is.na(Length..mm.))
NTwin.coc<-NTwin.coc[,-c(1:2)]
NTwin.coc<-melt(NTwin.coc)
#                             Buffalo
NTwin.bib<-subset(NTwin, Species == "BIB" & !is.na(Length..mm.))
NTwin.bib<-NTwin.bib[,-c(1:2)]
NTwin.bib<-melt(NTwin.bib)

# Length Frequency Histograms
# 2017






#2018
NTwinLF.c.2018<-ggplot(NTwin.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",y = "") +
                theme_classic()+
                annotate("text",x=250,y=150, label = "North Twin Lake Carp Length-Frequency")
NTwinLF.c.2018

NTwinLF.b.2018<-ggplot(NTwin.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend = F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",
                      y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label="North Twin Lake Buffalo Length-Frequency")
NTwinLF.b.2018

```

## Silver Lake
```{r}
# Subsetting species
#                             Carp
Silver.coc<-subset(Silver, Species == "COC" & !is.na(Length..mm.))
Silver.coc<-Silver.coc[,-c(1:2)]
Silver.coc<-melt(Silver.coc)
#                             Buffalo
Silver.bib<-subset(Silver, Species == "BIB" & !is.na(Length..mm.))
Silver.bib<-Silver.bib[,-c(1:2)]
Silver.bib<-melt(Silver.bib)

# Length Frequency Histograms
# 2017






#2018
SilverLF.c.2018<-ggplot(Silver.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F,
                               fill = "#00BFC4")+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",y = "") +
                theme_classic()+
                annotate("text",x=250,y=150,label = "Silver Lake Carp Length-Frequency")
SilverLF.c.2018

SilverLF.b.2018<-ggplot(Silver.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend = F,
                                 fill = "#00BFC4")+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label = "Silver Lake Buffalo Length-Frequency")
SilverLF.b.2018

```

## South Twin Lake
```{r}
# Subsetting species
#                             Carp
STwin.coc<-subset(STwin, Species == "COC" & !is.na(Length..mm.))
STwin.coc<-STwin.coc[,-c(1:2)]
STwin.coc<-melt(STwin.coc)
#                             Buffalo
STwin.bib<-subset(STwin, Species == "BIB" & !is.na(Length..mm.))
STwin.bib<-STwin.bib[,-c(1:2)]
STwin.bib<-melt(STwin.bib)

# Length Frequency Histograms
# 2017






#2018
STwinLF.c.2018<-ggplot(STwin.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend = F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",y = "") +
                theme_classic()+
                annotate("text",x=250, y=190,label = "South Twin Lake Carp Length-Frequency")
STwinLF.c.2018

STwinLF.b.2018<-ggplot(STwin.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend=F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=190,label = "South Twin Lake Buffalo Length-Frequency")
STwinLF.b.2018

```

## Storm Lake
```{r}
# Subsetting species
#                             Carp
Storm.coc<-subset(Storm, Species == "COC" & !is.na(Length..mm.))
Storm.coc<-Storm.coc[,-c(1:2)]
Storm.coc<-melt(Storm.coc)
#                             Buffalo
Storm.bib<-subset(Storm, Species == "BIB" & !is.na(Length..mm.))
Storm.bib<-Storm.bib[,-c(1:2)]
Storm.bib<-melt(Storm.bib)

# Length Frequency Histograms
# 2017






#2018
StormLF.c.2018<-ggplot(Storm.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs( x = "",y = "") +
                theme_classic()+
                annotate("text",x=250,y=150,label="Storm Lake Carp Length-Frequency")
StormLF.c.2018

StormLF.b.2018<-ggplot(Storm.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend=F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label="Storm Lake Buffalo Length-Frequency")
StormLF.b.2018

```

## now arrange the objects in a meaningful way
```{r}
# Carp
grid.arrange(centerLF.c.2018,FiveIslandLF.c.2018,NTwinLF.c.2018,SilverLF.c.2018,STwinLF.c.2018,StormLF.c.2018,BlueLF.2018,
             centerLF.b.2018,FiveIslandLF.b.2018,NTwinLF.b.2018,SilverLF.b.2018,STwinLF.b.2018,StormLF.b.2018,
             nrow=2,ncol=7)
```


# 2018 Harvest
- condense data frame
- plot lakes on x axis, total harvest in lbs on y axis, species as paired bars
- plot lakes on x axis, removal rate in lbs/acre on y axis, species as paired bars


```{r}
harvest<-read.csv("Harvest_2018_Only.csv")
str(harvest)
harvest<-harvest[,-c(2,3,4)]
levels(harvest$Lake)
harvest$Pounds<-as.numeric(as.character(harvest$Pounds))

#Drop lakes
harvest<-droplevels(subset(harvest, Lake == "Center Lake" |
                         Lake == "Five Island Lake" |
                         Lake == "Silver Lake (Dickinson)" ))

#drop freshwater drum
harvest<-droplevels(subset(harvest, Species == "CAP"|
                                    Species == "BMB"))

# correct the species names for later plotting
harvest$Species<-as.character(harvest$Species)
harvest$Species[harvest$Species == "CAP"] <- "Common Carp"
harvest$Species[harvest$Species == "BMB"] <- "Bigmouth Buffalo"
harvest$Species<-factor(harvest$Species)

# add acrage
harvest$Acres[harvest$Lake == "Center Lake"] <- 220
harvest$Acres[harvest$Lake == "Five Island Lake"] <- 973
harvest$Acres[harvest$Lake == "Silver Lake (Dickinson)"] <- 1066

# add column for pounds removed per acre
harvest$Removal<-harvest$Pounds/harvest$Acres


```

```{r}
#########################################
#
#       Plot 1: total harvest
#
#########################################
# melt and cast to sum harvest for entire year
harvest.melt<-melt(harvest, id.vars = c("Lake","Species"),
                   measure.vars = "Pounds")

tot.harvest<-ggplot(harvest.melt, aes(x = Lake, y = value, fill = Species)) +
              geom_bar(stat="identity", position = "dodge", colour = "black") +
              scale_fill_manual(values = wes_palette("Moonrise2")) +
              theme_bw()+
              theme(legend.position = "bottom", legend.title = element_blank()) +
              labs (title = "2018 Total Commercial Harvest", 
                    y = "Harvest (lbs.)")


#########################################
#
#       Plot 2: standardized harvest by pounds
#
#########################################
# melt and cast to sum harvest for entire year
harvest.melt<-melt(harvest, id.vars = c("Lake","Species"),
                   measure.vars = "Removal")

std.harvest<-ggplot(harvest.melt, aes(x = Lake, y = value, fill = Species)) +
              geom_bar(stat="identity", position = "dodge", colour = "black") +
              scale_fill_manual(values = wes_palette("Moonrise2")) +
              theme_bw()+
              theme(legend.position = "bottom", legend.title = element_blank()) +
              labs (title = "2018 Harvest - Standardized", 
                    y = "Removal Rate (lbs. / Acre)")

grid.arrange(tot.harvest,
             std.harvest,
             nrow = 1,
             ncol = 2)

```


# Changes in biomass and biomass density following harvest in center lake

my plan a couple hours ago was to have a four panel plot: 

Within each panel is Center, N&S Twin Lakes
Within each lake is year

data for each panel is:
TOPLEFT: COC TOTAL BIOMASS
TOPRIGHT: BIB TOTAL BIOMASS
BOTTOMLEFT: COC BIOMASS DENSITY
BOTTOMRIGHT: BIB BIOMASS DENSITY

__because you're a masochist, do all four and see if there's a meaningful difference__

current idea is to take the code from the cpue plots. figure out how to categorize x values and fill with year

```{r}
# gonna need biomass df for both years with confidence intervals
# basically paired boxplots without the boxes?
daf<-read.csv("2018_BiomassDensityEstimates.csv")
daf
daf[,1]<-c("Blue","Center","Five Island","N. Twin","Silver","S. Twin","Storm")
daf$Year<-factor("2018")

dat<-read.csv("2017_BiomassDensityEstimates.csv")
dat
dat[,1]<-c("Blue","Center","N. Twin","S. Twin")
dat$Year<-factor("2017")

data<-rbind(dat,daf)
data<-subset(data, X == "Center" |
                   X == "N. Twin"|
                   X == "S. Twin")


```


split by species, melt, and plot!

```{r}

c.data<-data[,c(1:7,14)]
b.data<-data[,c(1,8:14)]

#Carp total biomass plot
coc.bm<-ggplot(c.data, aes(x= Year, y = C.BM, ymin=C.L.BM, ymax=C.U.BM))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Carp Total Biomass 2017-2018", 
                    y = "Biomass Estimate (lbs.)")
coc.bm

# Buf total biomass plot
bib.bm<-ggplot(b.data, aes(x= Year, y = B.BM, ymin=B.L.BM, ymax=B.U.BM))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Buffalo Total Biomass 2017-2018", 
                    y = "Biomass Estimate (lbs.)")
bib.bm

#Carp bm density plot
coc.bmD<-ggplot(c.data, aes(x= Year, y = C.BMDensity, ymin=C.L.BMDensity, ymax=C.U.BMDensity))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Carp Biomass Density 2017-2018", 
                    y = "Estimated Biomass Density (lbs. / acre)")
coc.bmD

# Buf total biomass plot
bib.bmD<-ggplot(b.data, aes(x= Year, y = B.BMDensity, ymin=B.L.BMDensity, ymax=B.U.BMDensity))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Buffalo Biomass Density 2017-2018", 
                    y = "Estimated Biomass Density (lbs. / acre)")
bib.bmD

grid.arrange(coc.bm,
             bib.bm,
             coc.bmD,
             bib.bmD,
             ncol = 2,
             nrow = 2)

```


# Plot of species diversity
- side by side plot, number of species on y axis lake on x axis and filled with EF vs. fyke in a stacked barplot

```{r}
diversity<-read.csv("2018_COC_BIB_CMR_Data.csv", header = T)

summary(diversity$Gear)
diversity<-droplevels(subset(diversity, Gear == "Fyke" |
                             Gear == "Electroshocking"))

p1.data<-data.frame(with(diversity, tapply(Species, list(Lake, Gear), FUN = function(x) length(unique(x)))))
p1.data$Lake<-c("5 Island","Blue","Center","N.Twin","S. Twin","Silver","Storm")
m1.d.melt<-melt(p1.data)
theme_set(theme_bw())
p1 <- ggplot(m1.d.melt, aes(x=Lake, y = value, fill = variable))+
            geom_bar(stat="identity", position = "dodge", colour = "black") +
              scale_fill_manual(values = wes_palette("Moonrise2")) +
            theme_bw()+
             theme(legend.position = "bottom", legend.title = element_blank()) +
              labs (title = "Species Richness", 
                    y = "Number of Species")
  
p1


```

# Water Quality?



















