---
title: "2019 Annual Report"
author: "Martin A. Simonson"
date: "January 6, 2019"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r,include=FALSE}
rm(list=ls())


packages<-function(x, repos="http://cran.r-project.org", ...){
x<-as.character(match.call()[[2]])
if (!require(x,character.only=TRUE)){
install.packages(pkgs=x, repos=repos, ...)
require(x,character.only=TRUE)
}
}

#remove.packages(c("ggplot2", "data.table"))
#install.packages('Rcpp', dependencies = TRUE)
#install.packages('ggplot2', dependencies = TRUE)
#install.packages('data.table', dependencies = TRUE)

#packages(rcompanion)
#packages(vegan)
packages(ggplot2)
packages(gridExtra)
packages(reshape2)
packages(FSA)
packages(nnet)
#packages(multcomp)
#packages(plyr)
#packages(rv)
packages(arm)
packages(lattice)
packages(tikzDevice)
#packages(GGally)
packages(wesanderson)
#packages(DescTools)
#packages(mvnormtest)
#packages(HH)
#packages(biotools)
#packages(car)
#packages(psych)
#packages(GPArotation)
packages(doBy)
packages(dplyr)
packages(tidyr)
packages(rcompanion)
```

# DNR Permit data


```{r, include = F}
datframe<-read.csv("2018_COC_BIB_CMR_Data.csv", header = T)
str(datframe)



# Lakes
levels(datframe$Lake)
datframe$detect<-1
junk<-melt(datframe, id.var = c("Species","Lake"),
           measure.vars = "detect")
LakeTotals<-dcast(junk,Species~Lake)
# this is good for overall total catch, HOWEVER:
#   For DNR permit (and probably subsequent IACUC) 
#   I need to split by released alive and euthanized





levels(datframe$Notes)
length(datframe$Species[datframe$Notes == "euthanized"])
datframe$Notes[datframe$Notes == "Aging Fish" |
                 datframe$Notes == "Aging Fish " |
                 datframe$Notes == "Aging Fish - 2017 Tag Loss" |
                 datframe$Notes == "Aging Fish - 2017 Tag Loss Female" |
                 datframe$Notes == "Aging Fish - Female" |
                 datframe$Notes == "Aging Fish - Male" |
                 datframe$Notes == "Aging Fish - Mirror" |
                 datframe$Notes == "Aging Fish - Scoliosis" |
                 datframe$Notes == "Aging Fish 2017 Tag Loss Female"] <- "euthanized"
datframe$Notes<-droplevels(datframe$Notes)
levels(datframe$Notes)
length(datframe$Species[datframe$Notes == "euthanized"])

# Released Alive 2018 
Alive<-subset(datframe, Notes != "euthanized")
A.melt<-melt(Alive, id.var = c("Species","Lake"),
              measure.vars = "detect")
AliveTotal<-dcast(A.melt,Species~Lake)
write.csv(AliveTotal, "2018 Catch-Released.csv")

# Euthanized 2018
Euth<-subset(datframe, Notes == "euthanized")
E.melt<-melt(Euth, id.var = c("Species","Lake"),
             measure.vars = "detect")
EuthTotal<-dcast(E.melt, Species~Lake)
write.csv(EuthTotal, "2018 Catch-Euthanized.csv")

```

##################################################################################
# Annual Report Table and meeting Plots: Total Catches, then split by gear
- df of total catches by gear for each species in each lake (Table)
            - ending up with many rows and a column for each lake.
- stacked barplot is in order



```{r,}
##########################################################################
# 2018 catch
catch.melt<-melt(datframe, id.var = c("Species","Lake"),
              measure.vars = "detect")
TotalCatch<-dcast(catch.melt,Species~Lake)
#write.csv(TotalCatch, "2018 Catch by gear.csv")

#########################################################################
# 2018 Carp and Buffalo Catch split by gear

gear.melt<-melt(datframe, id.var = c("Species","Lake","Gear"),
              measure.vars = "detect")
GearCatch<-dcast(gear.melt,Lake + Gear~Species)
GearCatch<-GearCatch[,c(1,2,4,10)]

# Buffalo
GearPlot.Buff<-ggplot(GearCatch, aes(x=Lake, y = BIB, fill = Gear))+
                geom_bar(stat="identity",colour="black") +
                scale_fill_manual(values = wes_palette("Royal1")) +
                scale_y_continuous(limits = c(0,5000)) +
                labs(title = "2018 Total Bigmouth Buffalo Catch By Gear",
                 x="Lake",
                 y="Bigmouth Buffalo Catch") +
                theme_classic()

# Carp
GearPlot.Carp<-ggplot(GearCatch, aes(x=Lake, y = COC, fill = Gear))+
                geom_bar(stat="identity",colour="black") +
                scale_fill_manual(values = wes_palette("Chevalier1")) +
                scale_y_continuous(limits = c(0,5000)) +
                labs(title = "2018 Total Common Carp Catch By Gear",
                 x="Lake",
                 y="Common Carp Catch") +
                theme_classic()

grid.arrange(GearPlot.Buff,
             GearPlot.Carp,
             nrow=2,
             ncol=1)

```


#######################################################################################
# 2018 Length Frequencies
- Reading in data
- splitting up the lakes
- split by gear too and exclude fyke nets
- delete unnecessary columns for LF (most of them)

__Problem__: have to switch these to inches probably
```{r,}
#reading in data
dframe<-read.csv("2018_COC_BIB_CMR_Data.csv")
dframe<-dframe[,-1]

# removing fyke catches
levels(dframe$Gear)
dframe<-subset(dframe, Gear == "Electroshocking" |
                       Gear == "Commercial Seine")

# getting rid of unused columns
str(dframe)
dframe<-dframe[,-c(1,3,6:10,12:21)]

# splitting data frame by Lakes
levels(dframe$Lake)
Blue <- subset(dframe, Lake == "Blue")
Center<-subset(dframe, Lake == "Center")
FiveIsland<-subset(dframe, Lake == "5 Island")
NTwin<-subset(dframe, Lake == "N. Twin")
Silver<-subset(dframe, Lake == "Silver")
STwin<-subset(dframe, Lake == "S. Twin")
Storm<-subset(dframe, Lake == "Storm")


```

- trying to make a single plot with facet.grid
```{r}
# subsetting species
df<-subset(dframe, !is.na(Length..mm.) & Species == "COC" |
                   !is.na(Length..mm.) & Species == "BIB")
df<-subset(df, Lake != "Blue")

df.m<-melt(df)

all.lakes.lf2018<-ggplot(df.m, aes(x=value, fill = Gear))+
                         geom_histogram(binwidth = 10,
                                        colour = "black",
                                        position = "stack")+
                         coord_cartesian(xlim = c(0,1000))+
                         scale_y_continuous(limits = c(0,200))+
                         facet_grid(vars(Species), vars(Lake))+
                         theme(panel.grid.major = element_blank(), 
                              panel.grid.minor = element_blank(),
                              panel.background = element_rect(fill="white",colour="grey50"), 
                              axis.line = element_line(colour = "black"),
                              legend.position = "bottom",
                              legend.background = element_rect(colour="grey20"))+
                         labs(title = "2018 Length Frequencies without blue lake",
                              x = "Length (mm)",
                              y = "Frequency")

all.lakes.lf2018
```



- separate plots below:
## Blue Lake
```{r}
# No extreme need to split species (one BIB in dataset) but I'll do it anyway
blue.coc<-subset(Blue, Species == "COC" & !is.na(Length..mm.))
blue.coc<-blue.coc[,-c(1:2)]
blue.coc<-melt(blue.coc)

# Length Frequency Histograms
# 2017






#2018
BlueLF.2018<-ggplot(blue.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack",
                               show.legend=F,
                               fill = "#00BFC4")+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,700))+
                labs(x = "",
                      y = "(Note larger y-axis)") +
                theme_classic()+
                theme(plot.margin = unit(c(0.2,0.2,0.2,0.2),"pt"))+
                annotate("text",x=500,y=600,label="Blue Lake Carp")
BlueLF.2018


```

## Center Lake
```{r}
# Subsetting species
#                             Carp
center.coc<-subset(Center, Species == "COC" & !is.na(Length..mm.))
center.coc<-center.coc[,-c(1:2)]
center.c.m<-melt(center.coc)

#                             Buffalo
center.bib<-subset(Center, Species == "BIB" & !is.na(Length..mm.))
center.bib<-center.bib[,-c(1:2)]
center.b.m<-melt(center.bib)

# Length Frequency Histograms
# 2017





#2018 Carp
centerLF.c.2018<-ggplot(center.c.m, aes(x=value,  fill=Gear))+
                geom_histogram(binwidth=10, 
                               colour="black", 
                               position = "stack",
                               show.legend = F) +
                coord_cartesian(xlim = c(100,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x="",y="")+
                theme_classic()+
                theme(axis.text.x=element_blank(),
                      plot.margin = unit(c(0.2,0.2,0.2,0.2),"pt"))+
                annotate("text",x=250, y = 150, label = "Center Lake Carp")
centerLF.c.2018
#2018 Buffalo
centerLF.b.2018<-ggplot(center.b.m, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend = F)+
                  coord_cartesian(xlim = c(100,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text", x= 250, y = 150, label = "Center Lake Buffalo")
centerLF.b.2018

```

## Five Island Lake
```{r}
# Subsetting species
#                             Carp
FiveIsland.coc<-subset(FiveIsland, Species == "COC" & !is.na(Length..mm.))
FiveIsland.coc<-FiveIsland.coc[,-c(1:2)]
FiveIsland.coc<-melt(FiveIsland.coc)
#                             Buffalo
FiveIsland.bib<-subset(FiveIsland, Species == "BIB" & !is.na(Length..mm.))
FiveIsland.bib<-FiveIsland.bib[,-c(1:2)]
FiveIsland.bib<-melt(FiveIsland.bib)

# Length Frequency Histograms
# 2017






#2018 Carp
FiveIslandLF.c.2018<-ggplot(FiveIsland.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",
                     y = "") +
                theme_classic()+
                annotate("text", x= 250, y = 150, label = "Five Island Lake Carp Length-Frequency")
FiveIslandLF.c.2018
#2018 Buffalo 
FiveIslandLF.b.2018<-ggplot(FiveIsland.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend=F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label="Five Island Lake Buffalo Length-Frequency")
FiveIslandLF.b.2018

```

## North Twin Lake
```{r}
# Subsetting species
#                             Carp
NTwin.coc<-subset(NTwin, Species == "COC" & !is.na(Length..mm.))
NTwin.coc<-NTwin.coc[,-c(1:2)]
NTwin.coc<-melt(NTwin.coc)
#                             Buffalo
NTwin.bib<-subset(NTwin, Species == "BIB" & !is.na(Length..mm.))
NTwin.bib<-NTwin.bib[,-c(1:2)]
NTwin.bib<-melt(NTwin.bib)

# Length Frequency Histograms
# 2017






#2018
NTwinLF.c.2018<-ggplot(NTwin.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",y = "") +
                theme_classic()+
                annotate("text",x=250,y=150, label = "North Twin Lake Carp Length-Frequency")
NTwinLF.c.2018

NTwinLF.b.2018<-ggplot(NTwin.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend = F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",
                      y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label="North Twin Lake Buffalo Length-Frequency")
NTwinLF.b.2018

```

## Silver Lake
```{r}
# Subsetting species
#                             Carp
Silver.coc<-subset(Silver, Species == "COC" & !is.na(Length..mm.))
Silver.coc<-Silver.coc[,-c(1:2)]
Silver.coc<-melt(Silver.coc)
#                             Buffalo
Silver.bib<-subset(Silver, Species == "BIB" & !is.na(Length..mm.))
Silver.bib<-Silver.bib[,-c(1:2)]
Silver.bib<-melt(Silver.bib)

# Length Frequency Histograms
# 2017






#2018
SilverLF.c.2018<-ggplot(Silver.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F,
                               fill = "#00BFC4")+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",y = "") +
                theme_classic()+
                annotate("text",x=250,y=150,label = "Silver Lake Carp Length-Frequency")
SilverLF.c.2018

SilverLF.b.2018<-ggplot(Silver.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend = F,
                                 fill = "#00BFC4")+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label = "Silver Lake Buffalo Length-Frequency")
SilverLF.b.2018

```

## South Twin Lake
```{r}
# Subsetting species
#                             Carp
STwin.coc<-subset(STwin, Species == "COC" & !is.na(Length..mm.))
STwin.coc<-STwin.coc[,-c(1:2)]
STwin.coc<-melt(STwin.coc)
#                             Buffalo
STwin.bib<-subset(STwin, Species == "BIB" & !is.na(Length..mm.))
STwin.bib<-STwin.bib[,-c(1:2)]
STwin.bib<-melt(STwin.bib)

# Length Frequency Histograms
# 2017






#2018
STwinLF.c.2018<-ggplot(STwin.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend = F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs(x = "",y = "") +
                theme_classic()+
                annotate("text",x=250, y=190,label = "South Twin Lake Carp Length-Frequency")
STwinLF.c.2018

STwinLF.b.2018<-ggplot(STwin.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend=F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=190,label = "South Twin Lake Buffalo Length-Frequency")
STwinLF.b.2018

```

## Storm Lake
```{r}
# Subsetting species
#                             Carp
Storm.coc<-subset(Storm, Species == "COC" & !is.na(Length..mm.))
Storm.coc<-Storm.coc[,-c(1:2)]
Storm.coc<-melt(Storm.coc)
#                             Buffalo
Storm.bib<-subset(Storm, Species == "BIB" & !is.na(Length..mm.))
Storm.bib<-Storm.bib[,-c(1:2)]
Storm.bib<-melt(Storm.bib)

# Length Frequency Histograms
# 2017






#2018
StormLF.c.2018<-ggplot(Storm.coc, aes(x=value, fill=Gear))+
                geom_histogram(binwidth=10,
                               colour="black",
                               position="stack", 
                               show.legend=F)+
                coord_cartesian(xlim = c(0,1000))+
                scale_y_continuous(limits = c(0,200))+
                labs( x = "",y = "") +
                theme_classic()+
                annotate("text",x=250,y=150,label="Storm Lake Carp Length-Frequency")
StormLF.c.2018

StormLF.b.2018<-ggplot(Storm.bib, aes(x=value, fill = Gear))+
                  geom_histogram(binwidth = 10, 
                                 colour = "black", 
                                 position = "stack", 
                                 show.legend=F)+
                  coord_cartesian(xlim = c(0,1000))+
                  scale_y_continuous(limits = c(0,200))+
                  labs(x = "",y = "") +
                  theme_classic()+
                  annotate("text",x=250,y=150,label="Storm Lake Buffalo Length-Frequency")
StormLF.b.2018

```

## now arrange the objects in a meaningful way
```{r}
# Carp
grid.arrange(centerLF.c.2018,FiveIslandLF.c.2018,NTwinLF.c.2018,SilverLF.c.2018,STwinLF.c.2018,StormLF.c.2018,BlueLF.2018,
             centerLF.b.2018,FiveIslandLF.b.2018,NTwinLF.b.2018,SilverLF.b.2018,STwinLF.b.2018,StormLF.b.2018,
             nrow=2,ncol=7)
```


#############################################################################
# CPUE and Biomass Density

Code here comes from CPUE plots with the source 2017 and 2018 plots.
- note that 2017 used total biomass and not biomass density
- 2018 uses density

after January project update meeting:
- come up with plot to compare this across months and across lakes
- need to use facet.grid again with month variable
- let's rock and roll!

```{r}
# front matter
DF<-read.csv("2018 Raw CPUE Data.csv",header=T)
str(DF)
DF<-DF[,-1]
DF[,1]<-as.factor(as.character(DF[,1]))
DF[,2]<-as.factor(DF[,2])
DF[,3]<-as.factor(as.character(DF[,3]))
DF$n<-as.numeric(DF$n)

summary(DF)
# removing the blue lake data point with 300 fish/hour

```

more specifically, let's say that I should
(1) plot with month as discrete x variable and CPUE as y axis variable and 6-7 dots for each month. BONUS if I can add the variance. side by side for each species

```{r}
# 95% CI stats... 
CI95<-groupwiseMean(cpue ~ Lake + Month + Species,
                    data = DF,
                    conf = 0.95,
                    digits = 3)
# results in lots of negative numbers for confidence interval, especially in late fall :(

# removing the blue lake data point with 300 fish/hour
CI95.b<-CI95[-13,]



CI95.plot<-ggplot(CI95.b, aes(x=Month, y=Mean))+
  geom_jitter(aes(colour = Species, shape = Species),
              size=2, width = 0.2)+
  theme_bw()+
  theme(legend.position = c(.8,.8),
        legend.title = element_text(size=12,face="bold"))
CI95.plot

CI95.boxplot<-ggplot(CI95.b, aes(x=Month, y=Mean))+
  geom_boxplot(aes(colour = Species),
              size=1)+
  theme_bw()+
  theme(legend.position = c(.8,.8),
        legend.title = element_text(size=12,face="bold"))
CI95.boxplot

# split by lake, and using entire df for more accurate distribution

DF.plot<-ggplot(DF, aes(x=Month, y=cpue))+
  geom_boxplot(aes(colour = Species),
              size=1)+
  theme_bw()+
  theme(legend.position = c(.9,.9),
        legend.title = element_text(size=12,face="bold"))+
    facet_grid(Lake ~ .)


DF.plot

# try again without blue
DF2<-subset(DF, Lake != "Blue")

DF2.plot<-ggplot(DF2, aes(x=Month, y=cpue))+
  geom_boxplot(aes(colour = Species),
              size=1)+
  theme_bw()+
  theme(legend.position = c(.9,.9),
        legend.title = element_text(size=12,face="bold"))+
    facet_grid(Lake ~ .)


DF2.plot
```

- come back to these. show MJW and ask. 




(2) stacked plots with each month as a panel in one column, biomass density on x axis and CPUE in the multiple y-axes. side by side for each species first but maybe also split by STD and Run-n-Gun within each species.  

```{r}
# loading in data frame
denframe<-read.csv("2018_BiomassDensityEstimates.csv",header=T)
denframe[,1]<-factor(c("Blue","Center","5 Island","N. Twin","Silver","S. Twin","Storm"))
head(denframe)
str(denframe)

# CarpBiomass - avg from 2018 length specific biomass density estimates (IN POUNDS)
BM<-denframe
colnames(BM)[1] <- "Lake"

# adding carp
BM$CarpN <- c(72140,6466,25798,3816,9755,20661,9251) # est carp abundance for 7 lakes as of 12/18/2018

# Buff pop estimates
BM$BuffN<- c(NA,3530,2300,18776,12486,34278,13724)


# step 1 add biomass density with density limits
# probably using Merge?
head(BM)
head(CI95)
# meh I'll just subset rather than wrangle another function
#                     lower biomass density limit - carp
CI95$L.BMD[CI95$Lake == "Blue" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Blue"]
CI95$L.BMD[CI95$Lake == "5 Island" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "5 Island"]
CI95$L.BMD[CI95$Lake == "Center" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Center"]
CI95$L.BMD[CI95$Lake == "N. Twin" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "N. Twin"]
CI95$L.BMD[CI95$Lake == "Silver" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Silver"]
CI95$L.BMD[CI95$Lake == "S. Twin" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "S. Twin"]
CI95$L.BMD[CI95$Lake == "Storm" &
             CI95$Species == "COC"] <-BM$C.L.BMDensity[BM$Lake == "Storm"]
                                                     

#                     biomass density estimate - carp
CI95$BMD[CI95$Lake == "Blue" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Blue"]
CI95$BMD[CI95$Lake == "5 Island" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "5 Island"]
CI95$BMD[CI95$Lake == "Center" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Center"]
CI95$BMD[CI95$Lake == "N. Twin" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "N. Twin"]
CI95$BMD[CI95$Lake == "Silver" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Silver"]
CI95$BMD[CI95$Lake == "S. Twin" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "S. Twin"]
CI95$BMD[CI95$Lake == "Storm" &
             CI95$Species == "COC"] <-BM$C.BMDensity[BM$Lake == "Storm"]


#                     upper biomass density estimate - carp
CI95$U.BMD[CI95$Lake == "Blue" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Blue"]
CI95$U.BMD[CI95$Lake == "5 Island" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "5 Island"]
CI95$U.BMD[CI95$Lake == "Center" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Center"]
CI95$U.BMD[CI95$Lake == "N. Twin" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "N. Twin"]
CI95$U.BMD[CI95$Lake == "Silver" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Silver"]
CI95$U.BMD[CI95$Lake == "S. Twin" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "S. Twin"]
CI95$U.BMD[CI95$Lake == "Storm" &
             CI95$Species == "COC"] <-BM$C.U.BMDensity[BM$Lake == "Storm"]

############################################################################
#                     lower biomass density limit - BUFFALO
CI95$L.BMD[CI95$Lake == "Blue" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Blue"]
CI95$L.BMD[CI95$Lake == "5 Island" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "5 Island"]
CI95$L.BMD[CI95$Lake == "Center" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Center"]
CI95$L.BMD[CI95$Lake == "N. Twin" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "N. Twin"]
CI95$L.BMD[CI95$Lake == "Silver" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Silver"]
CI95$L.BMD[CI95$Lake == "S. Twin" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "S. Twin"]
CI95$L.BMD[CI95$Lake == "Storm" &
             CI95$Species == "BIB"] <-BM$B.L.BMDensity[BM$Lake == "Storm"]
                                                     

#                     biomass density estimate - BUFFALO
CI95$BMD[CI95$Lake == "Blue" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Blue"]
CI95$BMD[CI95$Lake == "5 Island" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "5 Island"]
CI95$BMD[CI95$Lake == "Center" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Center"]
CI95$BMD[CI95$Lake == "N. Twin" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "N. Twin"]
CI95$BMD[CI95$Lake == "Silver" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Silver"]
CI95$BMD[CI95$Lake == "S. Twin" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "S. Twin"]
CI95$BMD[CI95$Lake == "Storm" &
             CI95$Species == "BIB"] <-BM$B.BMDensity[BM$Lake == "Storm"]


#                     upper biomass density estimate - BUFFALO
CI95$U.BMD[CI95$Lake == "Blue" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Blue"]
CI95$U.BMD[CI95$Lake == "5 Island" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "5 Island"]
CI95$U.BMD[CI95$Lake == "Center" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Center"]
CI95$U.BMD[CI95$Lake == "N. Twin" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "N. Twin"]
CI95$U.BMD[CI95$Lake == "Silver" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Silver"]
CI95$U.BMD[CI95$Lake == "S. Twin" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "S. Twin"]
CI95$U.BMD[CI95$Lake == "Storm" &
             CI95$Species == "BIB"] <-BM$B.U.BMDensity[BM$Lake == "Storm"]

############################################
# Lake = Lake 
# Month = month number
# Species = binary
# n = number of transects
# mean = mean cpue for that month (# fish per hour)
# conf.level = our alpha is 0.05
# Trad.lower = lower ci for monthly cpue
# Trad.upper = upper ci for monthly cpue
# L.BMD = lower biomass density estimate
# BMD = biomass density estimate in lbs per acre
# U.BMD = upper biomass density estimate
#############################################

```

- plots
-- x axis: biomass density in lbs/acre
-- y axis: CPUE in fish/hour
-- vertical panels: month

dot for each lake in each month

regressions may be pointless and cumbersome, ask MJW

__removing only the blue lake may observation of cpue__ so we can have the other non-oulier months of blue lake sampling but a y-axis that tops out at 300 not 1000. 

```{r}
head(CI95)




BMD.plot<-ggplot(CI95, aes(x=CI95[,10],y=CI95[,5]))+
                  geom_point(aes(colour=Species, shape = Lake),size=2)+
                  facet_grid(Month~.)+
                  scale_shape_manual(values = c(2,4,7,8,15,16,17))+
                  labs( x = "Biomass Density (lbs./acre)",
                        y = "Mean Electrofishing CPUE (Fish/Hour)",
                        title = "Electrofishing CPUE vs. Biomass Density")


BMD.plot

# Without blue lake in may
CI95.b<-CI95[-13,]
BMD.plot2<-ggplot(CI95.b, aes(x=CI95.b[,10],y=CI95.b[,5]))+
                  geom_point(aes(shape = Lake),size=3)+
                  scale_shape_manual(values = c(2,4,7,8,15,16,17))+
                  facet_grid(Month~Species)+
                  labs( x = "Biomass Density (lbs./acre)",
                        y = "Mean Electrofishing CPUE (Fish/Hour)",
                        title = "Electrofishing CPUE vs. Biomass Density")+
                  theme(panel.grid.major = element_blank(), 
                       panel.grid.minor = element_blank(),
                       panel.background = element_rect(fill="white",colour="grey50"), 
                       axis.line = element_line(colour = "black"))


BMD.plot2

```
- decent at this point. 
-- could change month numbers to three letter abbreviations
change back from BW to have more fun




###################################################################################
# 2018 Harvest
- condense data frame
- plot lakes on x axis, total harvest in lbs on y axis, species as paired bars
- plot lakes on x axis, removal rate in lbs/acre on y axis, species as paired bars

- these two plots were accepted at the annual report meeting Jan 2019 but:
-- want to adjust harvests to follow season (Oct to May annually) and not split by calendar year
-- I'm going to split these up so that we can have some idea of historical harvest on the lakes
------- (2015 to 2018)
-- then copy for standardized?

```{r}
harvest<-read.csv("Harvest_2018_Only.csv")
str(harvest)
harvest<-harvest[,-c(2,3,4)]
levels(harvest$Lake)
harvest$Pounds<-as.numeric(as.character(harvest$Pounds))

#Drop lakes
harvest<-droplevels(subset(harvest, Lake == "Center Lake" |
                         Lake == "Five Island Lake" |
                         Lake == "Silver Lake (Dickinson)" ))

#drop freshwater drum
harvest<-droplevels(subset(harvest, Species == "CAP"|
                                    Species == "BMB"))

# correct the species names for later plotting
harvest$Species<-as.character(harvest$Species)
harvest$Species[harvest$Species == "CAP"] <- "Common Carp"
harvest$Species[harvest$Species == "BMB"] <- "Bigmouth Buffalo"
harvest$Species<-factor(harvest$Species)

# add acrage
harvest$Acres[harvest$Lake == "Center Lake"] <- 220
harvest$Acres[harvest$Lake == "Five Island Lake"] <- 973
harvest$Acres[harvest$Lake == "Silver Lake (Dickinson)"] <- 1066

# add column for pounds removed per acre
harvest$Removal<-harvest$Pounds/harvest$Acres


```


```{r}
#########################################
#
#       Plot 1: total harvest
#
#########################################
# melt and cast to sum harvest for entire year
harvest.melt<-melt(harvest, id.vars = c("Lake","Species"),
                   measure.vars = "Pounds")

tot.harvest<-ggplot(harvest.melt, aes(x = Lake, y = value, fill = Species)) +
              geom_bar(stat="identity", position = "dodge", colour = "black") +
              scale_fill_manual(values = wes_palette("Moonrise2")) +
              theme_bw()+
              theme(legend.position = "bottom", legend.title = element_blank()) +
              labs (title = "2018 Total Commercial Harvest", 
                    y = "Harvest (lbs.)")


#########################################
#
#       Plot 2: standardized harvest by pounds
#
#########################################
# melt and cast to sum harvest for entire year
harvest.melt<-melt(harvest, id.vars = c("Lake","Species"),
                   measure.vars = "Removal")

std.harvest<-ggplot(harvest.melt, aes(x = Lake, y = value, fill = Species)) +
              geom_bar(stat="identity", position = "dodge", colour = "black") +
              scale_fill_manual(values = wes_palette("Moonrise2")) +
              theme_bw()+
              theme(legend.position = "bottom", legend.title = element_blank()) +
              labs (title = "2018 Harvest - Standardized", 
                    y = "Removal Rate (lbs. / Acre)")

grid.arrange(tot.harvest,
             std.harvest,
             nrow = 1,
             ncol = 2)

```

#######################################################################
Update to plots from Jan 2019 meeting
```{r,}
harvest<-read.csv("Harvest 2015 to 2018.csv")
str(harvest)
harvest<-harvest[,-c(2)]
harvest$Year<-factor(harvest$Year)
#harvest$Month<-factor(harvest$Month) - - - - - - - - - - - - maybe easier subsetting later
harvest$Harvest<-as.numeric(as.character(harvest$Harvest))
str(harvest)




#Drop lakes
levels(harvest$Lake)
harvest<-droplevels(subset(harvest, Lake == "Center Lake" |
                         Lake == "Five Island Lake" |
                         Lake == "Silver Lake (Dickinson)" ))

#drop freshwater drum
harvest<-droplevels(subset(harvest, Species == "CAP"|
                                    Species == "BMB"))

# correct the species names for later plotting
harvest$Species<-as.character(harvest$Species)
harvest$Species[harvest$Species == "CAP"] <- "Common Carp"
harvest$Species[harvest$Species == "BMB"] <- "Bigmouth Buffalo"
harvest$Species<-factor(harvest$Species)

# add acrage
harvest$Acres[harvest$Lake == "Center Lake"] <- 220
harvest$Acres[harvest$Lake == "Five Island Lake"] <- 973
harvest$Acres[harvest$Lake == "Silver Lake (Dickinson)"] <- 1066

# shorten silver lake name
harvest$Lake<-as.character(harvest$Lake)
harvest$Lake[harvest$Lake == "Silver Lake (Dickinson)"] <- "Silver Lake"
harvest$Lake<-factor(harvest$Lake)


# add column for pounds removed per acre
harvest$Removal<-harvest$Harvest/harvest$Acres

##################################
# Lake: factor of lakes with harvest 2015 to 2018
# Year: factor of year
# Month: factor of months sampled (numeric) 
# Harvest: total removal in pounds
# Acres: lake area in acres
# Removal: standardized rough fish removal in pounds per acre
#################################
```

- need to adjust DF so that we have another column representing a season. 
-- maybe like "15-16" could represent fall 15 and spring 16 harvest. Eh?
```{r}
# re-categorizing

# Adding Season column to combine harvests across calendar years.
summary(harvest$Month)
harvest$Season[harvest$Year == "2014" &
               harvest$Month >= 7 |
               harvest$Year == "2015" &
               harvest$Month <= 6]  <- "14-15"

harvest$Season[harvest$Year == "2015" &
               harvest$Month >= 7 |
               harvest$Year == "2016" &
               harvest$Month <= 6]  <- "15-16"

harvest$Season[harvest$Year == "2016" &
               harvest$Month >= 7 |
               harvest$Year == "2017" &
               harvest$Month <= 6]  <- "16-17"

harvest$Season[harvest$Year == "2017" &
               harvest$Month >= 7 |
               harvest$Year == "2018" &
               harvest$Month <= 6]  <- "17-18"

harvest$Season[harvest$Year == "2018" &
               harvest$Month >= 7 |
               harvest$Year == "2019" &
               harvest$Month <= 6]  <- "18-19"

!is.na(harvest$Season)
levels(harvest$Lake)
```

- Plot it! 
-- Lakes (3) on x-axis
-- lbs on y axis (lbs/acre on other y axis)
-- Each season is a new bar for each lake
-- perhaps stack based on Species??
-- then again with Removal on y axis

```{r}
p1<-ggplot(harvest,aes(x=Season, y=Harvest, fill = Species))+
           geom_bar(stat="identity",position="Dodge")+
           facet_wrap(.~Lake)+
           theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                panel.background = element_rect(fill="white",colour="grey50"), 
                axis.line = element_line(colour = "black"),
                legend.position = "bottom")+
           labs(title = "Total Commercial Harvest 2015-2018",
                x = "Harvest Season",
                y = "Harvest (lbs)")
           
p1

p2<-ggplot(harvest,aes(x=Season, y=Removal, fill = Species))+
           geom_bar(stat="identity",position="Dodge")+
           facet_wrap(.~Lake)+
           theme(panel.grid.major = element_blank(), 
                panel.grid.minor = element_blank(),
                panel.background = element_rect(fill="white",colour="grey50"), 
                axis.line = element_line(colour = "black"),
                legend.position = "bottom",
                legend.background = element_rect(colour="grey20"))+
           labs(title = "Commercial Harvest Removal Rate 2015-2018",
                x = "Harvest Season",
                y = "Harvest Removal Rate (lbs/acre)")
           
p2
```

# Von Bertalanffy Growth Curves
```{r}
packages(FSAdata)
packages(nlstools)
data(Croaker2)
crm<-Subset(Croaker2, sex == "M")

# starting points, infinite length at age, and growth rate K
svTypical<-vbStarts(tl~age,data=crm)
unlist(svTypical)
svTypical<-list(Linf=376,K=0.3,t0=-1.8)

vbTypical <- tl~Linf*(1-exp(-K*(age-t0)))
fitTypical <- nls(vbTypical,data=crm,start=svTypical)

fitPlot(fitTypical,xlab="Age",ylab="Total Length (mm)",main = "")
overview(fitTypical)

bootTypical <- nlsBoot(fitTypical,niter=200)
ests <- data.frame(bootTypical$coefboot)
pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(8-ests[,"t0"])))
quantile(pv,c(0.025,0.975))



# plot with CIs
ages2plot<- 0:15
fitPlot(fitTypical,xlab="Age",ylab = "Total Length (mm)",
        xlim = range(ages2plot),main="")
LCI<- UCI <- numeric(length(ages2plot))

for (i in 1:length(ages2plot)) {
  pv<-ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
  LCI[i] <- quantile(pv,0.025)
  UCI[i] <- quantile(pv,0,975)
}

lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)

# plot with two CIs 90 and 95
LCI <- UCI <- LPI <- UPI <- numeric(length(ages2plot))
for (i in 1:length(ages2plot)) {
    pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
    LCI[i] <- quantile(pv,0.025)
    UCI[i] <- quantile(pv,0.975)
    LPI[i] <- quantile(pv-bootTypical$rse,0.025)
    UPI[i] <- quantile(pv+bootTypical$rse,0.975)
}
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(UPI~ages2plot,type="l",col="red",lwd=2,lty=2)
lines(LPI~ages2plot,type="l",col="red",lwd=2,lty=2)

```

- now I need to apply the above example code to my data
- find most accurate age estimate file, read it in, and start a plot

```{r}
# read in data



# Subset by a lake


# vbStarts and function variables



# Plots



```



#################################################################################
# Changes in biomass and biomass density following harvest in center lake

my plan a couple hours ago was to have a four panel plot: 

Within each panel is Center, N&S Twin Lakes
Within each lake is year

data for each panel is:
TOPLEFT: COC TOTAL BIOMASS
TOPRIGHT: BIB TOTAL BIOMASS
BOTTOMLEFT: COC BIOMASS DENSITY
BOTTOMRIGHT: BIB BIOMASS DENSITY

__because you're a masochist, do all four and see if there's a meaningful difference__

current idea is to take the code from the cpue plots. figure out how to categorize x values and fill with year

```{r}
# gonna need biomass df for both years with confidence intervals
# basically paired boxplots without the boxes?
daf<-read.csv("2018_BiomassDensityEstimates.csv")
daf
daf[,1]<-c("Blue","Center","Five Island","N. Twin","Silver","S. Twin","Storm")
daf$Year<-factor("2018")

dat<-read.csv("2017_BiomassDensityEstimates.csv")
dat
dat[,1]<-c("Blue","Center","N. Twin","S. Twin")
dat$Year<-factor("2017")

data<-rbind(dat,daf)
data<-subset(data, X == "Center" |
                   X == "N. Twin"|
                   X == "S. Twin")


```


split by species, melt, and plot!

```{r}

c.data<-data[,c(1:7,14)]
b.data<-data[,c(1,8:14)]

#Carp total biomass plot
coc.bm<-ggplot(c.data, aes(x= Year, y = C.BM, ymin=C.L.BM, ymax=C.U.BM))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Carp Total Biomass 2017-2018", 
                    y = "Biomass Estimate (lbs.)")
coc.bm

# Buf total biomass plot
bib.bm<-ggplot(b.data, aes(x= Year, y = B.BM, ymin=B.L.BM, ymax=B.U.BM))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Buffalo Total Biomass 2017-2018", 
                    y = "Biomass Estimate (lbs.)")
bib.bm

#Carp bm density plot
coc.bmD<-ggplot(c.data, aes(x= Year, y = C.BMDensity, ymin=C.L.BMDensity, ymax=C.U.BMDensity))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Carp Biomass Density 2017-2018", 
                    y = "Estimated Biomass Density (lbs. / acre)")
coc.bmD

# Buf total biomass plot
bib.bmD<-ggplot(b.data, aes(x= Year, y = B.BMDensity, ymin=B.L.BMDensity, ymax=B.U.BMDensity))+
                geom_point(size=4)+
                geom_linerange(size = 0.5) +
                facet_wrap(~X,scales = "free_x")+
                theme_bw()+
                labs (title = "Buffalo Biomass Density 2017-2018", 
                    y = "Estimated Biomass Density (lbs. / acre)")
bib.bmD

grid.arrange(coc.bm,
             bib.bm,
             coc.bmD,
             bib.bmD,
             ncol = 2,
             nrow = 2)

```


# Plot of species diversity
- side by side plot, number of species on y axis lake on x axis and filled with EF vs. fyke in a stacked barplot

- update 1-28-2019
-- need to find some target species that we hypothesize will respond to harvest
-- need to come up with some of those metrics (Wr, size structure, cpue, PSD, etc)
<<<<<<< HEAD
-- Decide what's most meaningful for annual report!
=======
-- Maybe just most common sportfish species (age structures collected)
>>>>>>> 202a0ead5f86acadfda35ae8776eea551802ef7d

## Species Diversity
```{r}
diversity<-read.csv("2018_COC_BIB_CMR_Data.csv", header = T)

summary(diversity$Gear)
diversity<-droplevels(subset(diversity, Gear == "Fyke" |
                             Gear == "Electroshocking"))

p1.data<-data.frame(with(diversity, 
                         tapply(Species, 
                                list(Lake, Gear), 
                                FUN = function(x) 
                                  length(unique(x)))))

p1.data$Lake<-c("5 Island","Blue","Center","N.Twin","S. Twin","Silver","Storm")
m1.d.melt<-melt(p1.data)
theme_set(theme_bw())
p1 <- ggplot(m1.d.melt, aes(x=Lake, y = value, fill = variable))+
            geom_bar(stat="identity", position = "dodge", colour = "black") +
              scale_fill_manual(values = wes_palette("Moonrise2")) +
            theme_bw()+
             theme(legend.position = "bottom", legend.title = element_blank()) +
              labs (title = "Species Richness", 
                    y = "Number of Species")
  
p1


```

## Split up by species

- examine counts of species first, see what samples I have to work with.
```{r}
summary(diversity$Species[diversity$Gear == "Fyke"])
# BLC and BLG and WHC
# WAE
# White Sucker

summary(diversity$Species[diversity$Gear == "Electroshocking"])
# WAE
# LMB
# CCF
# BLC/BLGL/WHC

```




















# Water Quality?



















